<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Jamaica Decision 2025 â€” Live Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (maps) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js (charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ==============================
       THEME TOKENS
       ============================== */
    :root{
      --bg:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --accent:#0a58ca;
      --card:#ffffff; --card-alt:#f8fafc; --shadow:0 6px 18px rgba(17,24,39,.06);
      --jlp:#2e8b57; --pnp:#ff8c00; --jpp:#6a0dad; --uic:#008b8b; --other:#1e90ff;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --hdrh:56px; --tabh:48px;
    }
    html[data-theme="dark"]{
      --bg:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#334155;
      --accent:#60a5fa;
      --card:#111827;
      --card-alt:#0b1220;
      --shadow:0 6px 18px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial
    }
    body.modal-open{overflow:hidden}

    /* ==============================
       HEADER
       (raise z-index so maps stay underneath)
       ============================== */
    .header{
      position:sticky; top:0; z-index:1500;
      background:var(--card); border-bottom:1px solid var(--border)
    }
    .header-inner{
      max-width:1800px; margin:0 auto; padding:14px 24px;
      display:flex; align-items:center; gap:18px; flex-wrap:wrap
    }
    .brand{font-weight:800; font-size:1.25rem; letter-spacing:.2px}
    .live-pill{margin-left:auto; display:flex; align-items:center; gap:8px; font-weight:700}
    .live-dot{width:10px; height:10px; border-radius:50%; background:#ef4444; animation:pulse 1.8s infinite}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}
      70%{box-shadow:0 0 0 12px rgba(239,68,68,0)}
      100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}
    }
    .refresh{display:flex; align-items:center; gap:6px}
    select, .mode-btn{
      border:1px solid var(--border); border-radius:10px; padding:8px 10px;
      background:var(--card); color:var(--text); cursor:pointer; font-weight:700
    }
    .mode-btn{display:flex; align-items:center; gap:6px}

    /* ==============================
       SOURCE STATUS PILLS
       ============================== */
    .status-group{display:flex; align-items:center; gap:12px; margin-left:8px}
    .status-pill{
      display:flex; align-items:center; gap:8px;
      background:var(--card); border:1px solid var(--border); border-radius:999px;
      padding:6px 10px; font-weight:800; color:var(--text);
    }
    .status-pill small{color:var(--muted); font-weight:600}
    .dot{width:10px; height:10px; border-radius:50%; animation:pulse 1.8s infinite; background:#10b981}
    .dot.ok{ background:#10b981 } .dot.warn{ background:#f59e0b } .dot.bad{ background:#ef4444 }

    /* ==============================
       TABS (sticky below header)
       ============================== */
    .tabs{
      position:sticky; top:var(--hdrh); z-index:1400;
      background:var(--card); border-bottom:1px solid var(--border)
    }
    .tabs-inner{max-width:1800px; margin:0 auto; padding:0 24px; display:flex; gap:24px}
    .tab{padding:14px 2px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:800}
    .tab.active{border-color:var(--accent); color:var(--text)}

    /* ==============================
       TOPLINE STATS
       ============================== */
    .topline{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border-bottom:1px solid var(--border)}
    .topline-inner{
      max-width:1800px; margin:0 auto; padding:12px 24px;
      display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))
    }
    .tcard{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:flex; gap:12px; align-items:center}
    .tlogo{height:22px; width:auto; filter:brightness(1)}
    html[data-theme="dark"] .tlogo{filter:brightness(1.2) contrast(1.1)}
    .tstats{font-size:.98rem; color:var(--muted)} .tstats b{color:var(--text)}
    .delta{font-weight:800; margin-left:6px} .delta.up{color:#16a34a} .delta.down{color:#ef4444}

    /* ==============================
       PAGE GRID
       main + right stacked sidebars
       ============================== */
    .page{
      display:grid;
      grid-template-columns: 1fr minmax(0,1600px) 340px 1fr; /* main + sidebars */
      gap:16px;
    }
    .page > .main{ grid-column:2; }

    /* Right column wrapper (sticky + fills viewport under header/tabs) */
    .sidebars{
      grid-column:3;
      position:sticky;
      top:calc(var(--hdrh) + var(--tabh) + 12px);
      align-self:start;
      height:calc(100vh - (var(--hdrh) + var(--tabh) + 28px));
      display:flex; flex-direction:column; gap:12px;
      z-index:1; /* keep beneath header/tabs which are 1400+ */
    }

    /* Each panel gets half height, scroll only if needed */
    .sidebar-section{
      flex:1; min-height:0;
      background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:12px; overflow:auto;
    }
    .sidebar-section h3{ margin:2px 0 8px 0; font-size:1rem }

    /* Recently updated items (right top panel) */
    .sideitem{
      position:relative; display:flex; justify-content:space-between; align-items:center;
      border:2px solid var(--border); border-radius:12px; padding:6px 8px; margin:8px 0;
      font-weight:800; cursor:pointer; background:var(--card)
    }
    .sideitem small{color:var(--muted); font-weight:700; font-size:.88em; font-variant-numeric:tabular-nums}
    .age-good{border-color:var(--good)} .age-warn{border-color:var(--warn)} .age-bad{border-color:var(--bad)}

    /* Closest races items (right bottom panel) */
    .closeitem{
      display:grid; grid-template-columns:20px 1fr auto auto;
      gap:8px; align-items:center;
      border:2px solid var(--border); border-radius:12px; padding:8px 10px; margin:8px 0;
      background:var(--card); cursor:pointer;
    }
    .closeitem:hover{ filter:brightness(0.98) }
    .closeitem .name{ font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .closeitem .votes{ font-weight:800; text-align:right; }
    .closeitem .pct{ color:var(--muted); text-align:right; }
    .closeitem .meta{ grid-column:1 / -1; font-size:.88em; color:var(--muted); margin-top:4px }

    /* ==============================
       SECTION / CARDS
       ============================== */
    .container{max-width:1600px; margin:14px auto; padding:0 24px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}

    /* ==============================
       CONTROLS
       ============================== */
    .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
    .controls input, .controls select{
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:var(--card); color:var(--text)
    }
    .controls input#searchBar{width:360px; max-width:90vw}
    .controls input#cnoFilter{width:120px}

    /* ==============================
       CONSTITUENCY GRID
       ============================== */
    .parish{margin:12px 0 22px}
    .parish h2{font-size:1.1rem; border-left:4px solid var(--accent); padding-left:10px; margin:0 0 12px}
    .const-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    .const{background:var(--card); border:2px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer}
    .const-head{
      background:linear-gradient(180deg, color-mix(in oklab, var(--card) 90%, var(--bg)), color-mix(in oklab, var(--card) 75%, var(--bg)));
      border-bottom:1px solid var(--border);
      padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px
    }
    .const-name{font-weight:900; font-size:1rem; line-height:1.2; background:var(--bg); padding:3px 8px; border:1px solid var(--border); border-radius:8px}
    .updated{font-size:.85rem; color:var(--muted); display:flex; flex-direction:column; align-items:flex-end; text-align:right; gap:4px; white-space:nowrap}
    .pulse{display:inline-block; width:10px; height:10px; border-radius:50%; background:currentColor; animation:pulseSoft 1.8s infinite}
    @keyframes pulseSoft{
      0%{box-shadow:0 0 0 0 rgba(0,0,0,.2)}
      70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}
      100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}
    }
    .const-body{padding:12px; display:flex; flex-direction:column; gap:8px}
    .winner-badge{display:inline-flex; align-items:center; gap:6px; font-weight:800; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08)}
    html[data-theme="dark"] .winner-badge{border-color:#00000040}
    .winner-badge .check{font-weight:900}
    .boxline{font-size:.9rem; color:var(--muted); margin-top:2px}

    /* Rows (5 columns) */
    .rows{margin-top:6px; border-top:1px solid var(--border)}
    .row{
      display:grid; grid-template-columns:35px 1fr 40px 70px 52px;
      gap:12px; padding:10px 4px; align-items:start;
      border-bottom:1px solid var(--border); min-height:44px; background:var(--card-alt);
    }
    .row:last-child{border-bottom:none}
    .nm{font-weight:700; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.15}
    .party{ text-align:center; font-weight:800; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:.3px; }
    .votes{font-weight:800; text-align:right}
    .pct{color:var(--muted); text-align:right}
    .party-icon{height:18px; width:auto; display:block; margin-top:2px; filter:none}
    html[data-theme="dark"] .party-icon{filter:brightness(1.1)}

    /* ==============================
       SCOREBOARD + CHARTS
       ============================== */
    .scoreboard{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(330px,1fr))}
    .pcard{border:1px solid var(--border); border-radius:10px; padding:14px; background:var(--card)}
    .phead{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .pbrand{display:flex; align-items:center; gap:10px; font-weight:800}
    .plogo{height:22px; width:auto; filter:none}
    html[data-theme="dark"] .plogo{filter:brightness(1.2) contrast(1.1)}
    .pmain{font-size:1.6rem; font-weight:800}
    .bar{height:8px; border-radius:999px; background:var(--border); overflow:hidden; margin-top:8px}
    .bar>span{display:block; height:100%}
    .charts{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
    .chart-wrap{position:relative; height:300px}
    canvas{position:absolute; inset:0}

    /* ==============================
       CLOSEST LIST (National tab)
       ============================== */
    .closelist{list-style:none; padding:0; margin:0; display:grid; gap:8px}
    .closelist li{
      display:flex; justify-content:space-between; gap:10px;
      border:1px solid var(--border); background:var(--card);
      border-radius:10px; padding:10px 12px; cursor:pointer
    }

    /* ==============================
       MAPS
       ============================== */
    .map-wrap{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card-alt); z-index:1}
    #mapContainer{height:460px}
    #imapMap{height:60vh; min-height:380px; max-height:72vh}
    .mapControls{position:absolute; right:8px; top:8px; z-index:500}
    .btn{
      background:var(--card); border:1px solid var(--border); border-radius:10px;
      padding:8px 10px; cursor:pointer; font-weight:700; color:var(--text)
    }
    .btn:hover{filter:brightness(0.98)}
    .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
    .legend-item{display:inline-flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); padding:6px 10px; border-radius:999px; color:var(--text)}
    .swatch{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15)}
    .leaflet-tooltip{background:#111827; color:#f9fafb; border:0; border-radius:8px; padding:8px 10px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .leaflet-container{background:var(--card-alt)}
    .leaflet-control-attribution{display:none}
    .leaflet-pane{z-index:400} /* header/tabs/ticker are 1400+ */

    /* ==============================
       BOTTOM TICKER
       ============================== */
    .ticker{position:sticky; bottom:0; z-index:1600; background:#0b1220; color:#fff; border-top:1px solid #0f172a}
    html[data-theme="dark"] .ticker{background:#0b1220}
    .ticker-inner{max-width:1600px; margin:0 auto; padding:10px 24px; display:flex; align-items:center; gap:12px; overflow:hidden}
    .tick-title{font-weight:800; margin-right:8px}
    .marquee{white-space:nowrap; overflow:hidden; flex:1}
    .marquee span{display:inline-block; padding-left:100%; animation:scroll 180s linear infinite}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

    /* ==============================
       PREVIEW MODAL
       ============================== */
    .modal{position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(2px)}
    .modal.show{display:flex}
    .modal-content{
      width:min(1100px, 66vw); max-height:86vh; background:var(--card);
      color:var(--text); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      display:grid; grid-template-rows:auto auto 1fr auto; overflow:hidden;
    }
    .modal-header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border)}
    .modal-title{font-weight:900; font-size:1.05rem}
    .modal-hint{padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--border)} /* aria-live line */
    .modal-body{display:grid; grid-template-columns:1.2fr .8fr; gap:0; min-height:380px}
    #previewMap{min-height:380px; position:relative}
    .modal-details{border-left:1px solid var(--border); padding:10px 12px; overflow:auto}
    .modal-actions{padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end}
    .btn-secondary{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border:1px solid var(--border)}
    .btn-primary{background:var(--accent); border:1px solid color-mix(in oklab, var(--accent) 70%, black); color:white}
    .close-x{border-radius:10px; padding:6px 10px; background:var(--card); border:1px solid var(--border); cursor:pointer}
    .shimmer{
      position:absolute; inset:0; pointer-events:none;
      background:linear-gradient(100deg, rgba(0,0,0,0) 0%, rgba(148,163,184,.22) 40%, rgba(0,0,0,0) 80%);
      background-size:200% 100%;
      animation:shimmer 1.2s linear infinite;
      z-index:5;
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* ==============================
       RESPONSIVE
       ============================== */
    @media (max-width:1300px){
      .page{ display:block }
      .sidebars{
        position:relative; top:auto; height:auto; z-index:auto; margin:12px 24px;
      }
      .sidebar-section{ overflow:visible }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ==============================
         MAIN
         ============================== -->
    <div class="main">
      <!-- Header -->
      <header class="header" id="siteHeader">
        <div class="header-inner">
          <div class="brand">Jamaica Decision 2025 â€” Live Results</div>

          <button id="modeBtn" class="mode-btn" title="Toggle light/dark">ðŸŒž Light</button>

          <div class="refresh">
            <span style="color:var(--muted)">Auto-refresh:</span>
            <select id="refreshSel">
              <option value="15000">15s</option>
              <option value="30000">30s</option>
              <option value="60000" selected>1m</option>
              <option value="120000">2m</option>
              <option value="300000">5m</option>
            </select>
            <button id="btnForceRefresh" class="btn">Refresh now</button>
          </div>

          <!-- Parity pills -->
          <div class="status-group" id="sourceStatus">
            <div class="status-pill" id="pillMain" title="Waiting for first checkâ€¦">
              <span class="dot ok" aria-hidden="true"></span> Main <small id="mainLag">OK</small>
            </div>
            <div class="status-pill" id="pillBackup" title="Waiting for first checkâ€¦">
              <span class="dot ok" aria-hidden="true"></span> Backup <small id="backupLag">OK</small>
            </div>
          </div>

          <div class="live-pill"><span class="live-dot"></span><span id="lastUpdated">Updatingâ€¦</span></div>
        </div>
      </header>

      <!-- Tabs (order: Constituencies, Interactive, National) -->
      <nav class="tabs" id="siteTabs">
        <div class="tabs-inner">
          <div class="tab active" data-tab="constituencies">Constituencies</div>
          <div class="tab" data-tab="interactive">Interactive Map</div>
          <div class="tab" data-tab="national">National</div>
        </div>
      </nav>

      <!-- Topline -->
      <section class="topline">
        <div class="topline-inner" id="toplineBar"></div>
      </section>

      <!-- NATIONAL -->
      <section id="tab-national" class="hidden">
        <div class="container">
          <div class="scoreboard" id="scoreboard"></div>

          <div class="charts">
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Total Votes by Party</h2>
              <div class="chart-wrap"><canvas id="voteChart"></canvas></div>
            </div>
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Seats Won by Party</h2>
              <div class="chart-wrap"><canvas id="seatChart"></canvas></div>
            </div>
          </div>

          <div class="card">
            <h2>Top 10 Closest Seats</h2>
            <ul id="closestList" class="closelist"></ul>
            <p id="closestNote" style="color:var(--muted); margin-top:8px"></p>
          </div>

          <div class="card">
            <h2>Seats Won Map</h2>
            <div class="map-wrap">
              <div id="mapContainer"></div>
              <div class="mapControls"><button id="btnResetNational" class="btn">Reset view</button></div>
            </div>
            <div id="mapLegend" class="legend"></div>
          </div>
        </div>
      </section>

      <!-- CONSTITUENCIES (default visible) -->
      <section id="tab-constituencies">
        <div class="container">
          <div class="card">
            <div class="controls">
              <input id="searchBar" type="text" placeholder="Search candidate, constituency, #â€¦">
              <select id="parishFilter"><option value="">All Parishes</option></select>
              <select id="partyFilter">
                <option value="">All Parties</option>
                <option>JLP</option><option>PNP</option><option>JPP</option><option>UIC</option><option>Other</option>
              </select>
              <input id="cnoFilter" type="text" inputmode="numeric" placeholder="Const. #">
              <div class="split">
                <label for="sortField" style="color:var(--muted); font-weight:700">Sort by</label>
                <select id="sortField">
                  <option value="cno">Const #</option>
                  <option value="name">Const name</option>
                  <option value="parish">Parish</option>
                  <option value="party">Leading party</option>
                </select>
                <select id="sortDir">
                  <option value="asc">Asc</option>
                  <option value="desc">Desc</option>
                </select>
              </div>
            </div>
            <h2>Constituencies by Parish</h2>
            <div id="parishContainer"></div>
          </div>
        </div>
      </section>

      <!-- INTERACTIVE MAP -->
      <section id="tab-interactive" class="hidden">
        <div class="container">
          <div class="card">
            <h2>Interactive Map</h2>
            <div class="map-wrap">
              <div id="imapMap"></div>
              <div class="mapControls"><button id="btnResetInteractive" class="btn">Reset view</button></div>
            </div>
            <div id="imapLegend" class="legend" style="margin-top:8px"></div>
            <div id="imapDetails" class="card" style="margin-top:12px">
              <h2 style="margin-top:0">Constituency Details</h2>
              <div id="imapContent" class="small">Click a constituency to see results here.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ==============================
         RIGHT SIDEBARS (stacked)
         ============================== -->
    <div class="sidebars">
      <!-- TOP: Recently Updated -->
      <aside class="sidebar-section" aria-label="Recently Updated Constituency Numbers">
        <h3>Recently Updated (#)</h3>
        <div id="sidebarList"></div>
      </aside>

      <!-- BOTTOM: Closest Races -->
      <aside class="sidebar-section" aria-label="Top 10 Closest Races">
        <h3>Top 10 Closest Races</h3>
        <div id="sidebarCloseList"></div>
      </aside>
    </div>
  </div>

  <!-- ==============================
       Bottom ticker
       ============================== -->
  <div class="ticker">
    <div class="ticker-inner">
      <span class="tick-title">Live Updates:</span>
      <div class="marquee"><span id="tickerText">â€”</span></div>
    </div>
  </div>

  <!-- ==============================
       PREVIEW MODAL MARKUP
       ============================== -->
  <div class="modal" id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="previewTitle">Constituency</div>
        <button class="close-x" id="btnPreviewClose" aria-label="Close preview">âœ•</button>
      </div>
      <div class="modal-hint" aria-live="polite">Loadingâ€¦</div>
      <div class="modal-body">
        <div id="previewMap">
          <div class="shimmer" id="previewShimmer"></div>
        </div>
        <div class="modal-details">
          <div id="previewBoxes" class="boxline" style="margin-top:2px"></div>
          <table style="width:100%; border-collapse:collapse; margin-top:8px">
            <thead>
              <tr><th style="width:28px"></th><th style="text-align:left">Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr>
            </thead>
            <tbody id="previewTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPreviewCancel">Close</button>
        <button class="btn btn-primary" id="btnPreviewGo">Open in Interactive Map</button>
      </div>
    </div>
  </div>

  <script>
  /* ===== Config (Proxy + Data URLs) ===== */
  const PROXY_BASE   = 'https://decision2025.odaneforsythe.workers.dev/';
  const DIRECT_MAIN  = 'https://jamaica-elections.com/general/2025/show/jsonapi.php';
  const DIRECT_BACKUP= 'https://onedrex.net:9443/election/api/view/constituency-details/v2/carlito2025';
  const MAIN_URLS    = [ PROXY_BASE + encodeURIComponent(DIRECT_MAIN) ];
  const BACKUP_URLS  = [ PROXY_BASE + encodeURIComponent(DIRECT_BACKUP) ];

  const AUTO_DEFAULT = 60000;
  const ECJ_GEOJSON =
   'https://services6.arcgis.com/3R3y1KXaPJ9BFnsU/arcgis/rest/services/ECJWEB_MAP/FeatureServer/6/query?where=1%3D1&outFields=*&f=geojson';
  const JAMAICA_BOUNDS = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);

  const PARTY_COLORS = { JLP:'#2e8b57', PNP:'#ff8c00', JPP:'#6a0dad', UIC:'#008b8b', Other:'#1e90ff' };
  const PARTY_LOGOS = {
    JLP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JLP_logo-300x98.png",
    PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_logo-300x182.png",
    JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_logo-300x275.png",
    UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_logo-300x164.png",
    Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
  };
  const PARTY_SYMBOLS = {
    JLP:"https://ecj.com.jm/wp-content/uploads/2025/03/JLP_symbol.png",
    PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_symbol.png",
    JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_symbol-300x261.png",
    UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_symbol-300x106.png",
    Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
  };
  const CORE_PARTIES = ["JLP","PNP","JPP","UIC"];
  const TICKER_MAX_AGE = 15*60*1000;
  const SIDEBAR_MAX_AGE = 25*60*1000;
  const PARITY_INTERVAL_MS = 5 * 60 * 1000;

  /* ===== Normalizer + Name Aliases with metadata ===== */
  function norm(s){ return String(s||'').toLowerCase().replace(/[\s\-\u2013\u2014'â€™.]/g,'').replace(/&/g,'and'); }
  const NAME_ALIASES = {
    [norm('Kingston East and Port Royal')]: { key: norm('Kingston Eastern and Port Royal'), parish: 'KINGSTON', constno: '3' }
  };
  function canonKey(k){ return NAME_ALIASES[k]?.key || k; }

  /* ===== State ===== */
  let voteChart=null, seatChart=null, refreshTimer=null, timerInterval=null;
  let mapNational=null, mapInteractive=null, geoLayerNational=null, geoLayerInteractive=null;
  let baseLightNat=null, baseDarkNat=null, baseLightInt=null, baseDarkInt=null, currentBase='light';
  let arcFeatures=[], byParish={}, constNameToNo={}, constNameToParish={};
  let leaderColors = {}; let focusedKey = null; let pendingFocusName = null;
  let lastSeats = JSON.parse(localStorage.getItem('lastSeats') || '{}');
  let lastConstHashes = JSON.parse(localStorage.getItem('constituencyHashes')||'{}');
  let lastConstUpdated = JSON.parse(localStorage.getItem('constituencyUpdated')||'{}');

  /* ===== Preview modal state ===== */
  let previewMap=null, previewLayer=null, previewKey=null;

  /* ===== Utils ===== */
  function toast(msg){
    const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
    document.body.appendChild(t); setTimeout(()=>t.remove(),4000);
  }
  function contrastText(hex){
    try{
      const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);
      return ((r*299+g*587+b*114)/1000>=140)?'#0b1220':'#ffffff';
    }catch{ return '#0b1220'; }
  }
  function fmtHHMMSS(ms){
    const s=Math.max(0,Math.floor(ms/1000));
    const hh=String(Math.floor(s/3600)).padStart(2,'0');
    const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }
  function makeHash(cands){
    return cands.map(k=>`${(k.Party||'Other').toUpperCase()}|${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}|${Number(k.Votes||0)}`).join(';');
  }
  const partyKey = p => { const P = String(p||'Other').toUpperCase(); if (P.startsWith('INDA') || P.startsWith('INDB')) return 'Other'; return CORE_PARTIES.includes(P) ? P : 'Other'; };
  const bust = url => url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now();

  /* ===== Theme toggle ===== */
  function applyTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('modeBtn').textContent = theme==='dark' ? 'ðŸŒ™ Dark' : 'ðŸŒž Light';
    if (mapNational && baseLightNat && baseDarkNat){
      if (theme==='dark' && currentBase!=='dark'){ mapNational.removeLayer(baseLightNat); baseDarkNat.addTo(mapNational); currentBase='dark'; }
      if (theme==='light' && currentBase!=='light'){ mapNational.removeLayer(baseDarkNat); baseLightNat.addTo(mapNational); currentBase='light'; }
      setTimeout(()=>mapNational.invalidateSize(), 60);
    }
    if (mapInteractive && baseLightInt && baseDarkInt){
      if (theme==='dark'){ mapInteractive.removeLayer(baseLightInt); baseDarkInt.addTo(mapInteractive); }
      else { mapInteractive.removeLayer(baseDarkInt); baseLightInt.addTo(mapInteractive); }
      setTimeout(()=>mapInteractive.invalidateSize(), 60);
    }
  }
  function initTheme(){
    const saved = localStorage.getItem('theme') || 'light';
    applyTheme(saved);
    document.getElementById('modeBtn').addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
      const next = cur==='dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });
  }

  /* ===== Tabs ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('tab-'+t.dataset.tab).classList.remove('hidden');
      if (t.dataset.tab==='national' && mapNational) setTimeout(()=>mapNational.invalidateSize(), 60);
      if (t.dataset.tab==='interactive' && mapInteractive) {
        setTimeout(()=>mapInteractive.invalidateSize(), 60);
        if (pendingFocusName){ focusConstituencyByName(pendingFocusName, true); pendingFocusName=null; }
        else {
          const cur = document.getElementById('imapContent')?.dataset?.currentKey;
          if (cur) focusConstituencyByName(cur, true);
        }
      }
    }));
  });

  /* ===== Sticky offsets ===== */
  function updateStickyOffsets(){
    const hdr = document.getElementById('siteHeader');
    const tabs = document.getElementById('siteTabs');
    if (hdr){ document.documentElement.style.setProperty('--hdrh', hdr.offsetHeight+'px'); }
    if (tabs){ document.documentElement.style.setProperty('--tabh', tabs.offsetHeight+'px'); }
  }
  window.addEventListener('resize', updateStickyOffsets);
  document.addEventListener('DOMContentLoaded', updateStickyOffsets);

  /* ===== Auto refresh ===== */
  const sel = (function(){ const el=document.createElement('select'); return el; })(); // placeholder to avoid TDZ
  document.addEventListener('DOMContentLoaded', ()=>{
    const s = document.getElementById('refreshSel');
    if(!s) return;
    s.value = localStorage.getItem('refreshIntervalMs') || String(AUTO_DEFAULT);
    s.addEventListener('change', ()=>{ localStorage.setItem('refreshIntervalMs', s.value); setupAutoRefresh(); });
    document.getElementById('btnForceRefresh').addEventListener('click', ()=>{ loadECJAndData(); });
  });

  /* ===== Maps ===== */
  const JAMAICA_BOUNDS_LEAF = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);
  function initNationalMap(){
    if (mapNational) return;
    mapNational = L.map('mapContainer',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
    baseLightNat = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    baseDarkNat  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkNat : baseLightNat).addTo(mapNational);
    mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
    mapNational.setMinZoom(mapNational.getZoom());
    const btn = document.getElementById('btnResetNational');
    if(btn){ btn.onclick = ()=>{
      mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
      mapNational.setMinZoom(mapNational.getZoom());
      setTimeout(()=> mapNational.invalidateSize(), 40);
    };}
  }
  function initInteractiveMap(){
    if (mapInteractive) return;
    mapInteractive = L.map('imapMap',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
    baseLightInt = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    baseDarkInt  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkInt : baseLightInt).addTo(mapInteractive);
    mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
    mapInteractive.setMinZoom(mapInteractive.getZoom());
    const btn = document.getElementById('btnResetInteractive');
    if(btn){ btn.onclick = ()=>{
      mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
      mapInteractive.setMinZoom(mapInteractive.getZoom());
      focusedKey = null; pendingFocusName = null;
      const cont = document.getElementById('imapContent');
      cont.textContent = 'Click a constituency to see results here.';
      cont.dataset.currentKey = '';
      if (geoLayerInteractive){
        geoLayerInteractive.eachLayer(l=>{
          try{ l.closeTooltip(); }catch(_){}
          const nm = l.feature?.properties?.CONST_NAME || '';
          const key = norm(nm);
          const fill = leaderColors[key] || '#e5e7eb';
          l.setStyle({ fillColor:fill, fillOpacity:0.75, color:'#94a3b8', weight:1 });
        });
      }
      setTimeout(()=> mapInteractive.invalidateSize(), 40);
    };}
    window.addEventListener('resize', ()=> setTimeout(()=> mapInteractive.invalidateSize(), 40));
  }
  function buildLegendInto(containerId){
    const host=document.getElementById(containerId); if(!host) return;
    host.innerHTML='';
    ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
      const el=document.createElement('span'); el.className='legend-item';
      el.innerHTML=`<span class="swatch" style="background:${PARTY_COLORS[p]}"></span>${p}`;
      host.appendChild(el);
    });
  }

  /* ===== Boundaries ===== */
  async function loadECJBoundaries(){
    const gj = await fetch(ECJ_GEOJSON, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('Boundaries HTTP '+r.status); return r.json(); });
    arcFeatures = gj.features || [];
    byParish = {}; constNameToNo={}; constNameToParish={};
    arcFeatures.forEach(f=>{
      const p=f.properties||{};
      const parish = p.PARISH_NAM || p.PARISH_NAME || '';
      const cname  = p.CONST_NAME || p.CONSTNAME || p.Name || '';
      const cno    = p.CONST_NO || p.CONSTNO || p.Number || '';
      const key=norm(cname);
      if (parish) (byParish[parish] ||= []);
      constNameToNo[key]=(cno||'').toString();
      constNameToParish[key]=parish||'';
    });
    Object.values(NAME_ALIASES).forEach(a=>{
      if (a.key){
        constNameToParish[a.key] = a.parish || constNameToParish[a.key] || '';
        constNameToNo[a.key]     = a.constno || constNameToNo[a.key] || '';
      }
    });
  }
    /* ===== Pulsing helpers ===== */
  function startPulse(layer){
    if (!layer || layer._pulseTimer) return;
    let up=true;
    layer._pulseTimer = setInterval(()=>{
      const next = up ? 0.95 : 0.6; up=!up;
      try{ layer.setStyle({ fillOpacity: next }); }catch(_){}
    }, 800);
  }
  function stopPulse(layer){
    if (layer && layer._pulseTimer){
      clearInterval(layer._pulseTimer);
      layer._pulseTimer = null;
      try{ layer.setStyle({ fillOpacity:0.75 }); }catch(_){}
    }
  }

  /* ===== Map coloring & interactions ===== */
  function paintMap(layer, detailsByConst){
    if (!layer) return;
    layer.eachLayer(Ly=>{
      const nm = Ly.feature?.properties?.CONST_NAME || '';
      const key = norm(nm);
      const info = detailsByConst[key];
      if (info){
        const fill = PARTY_COLORS[info.party] || PARTY_COLORS.Other;
        leaderColors[key]=fill;
        const strokeWeight = (focusedKey && focusedKey===key) ? 3 : 1;
        const strokeColor  = (focusedKey && focusedKey===key) ? '#111827' : '#94a3b8';
        Ly.setStyle({ fillColor: fill, fillOpacity:0.75, color:strokeColor, weight:strokeWeight });
        const disp = `${nm}${constNameToNo[key]?` (#${constNameToNo[key]})`:''}`;
        const rows = (info.all||[]).map(c=>{
          const col=PARTY_COLORS[c.party]||PARTY_COLORS.Other;
          return `<div><span style="color:${col}; font-weight:700">${c.name}</span> (${c.party}) â€” ${c.votes.toLocaleString()} â€¢ ${c.pct}%</div>`;
        }).join('');
        Ly.bindTooltip(`<div style="min-width:260px"><div style="font-weight:800;margin-bottom:4px">${disp}</div>${rows}</div>`, {sticky:true});
      }else{
        Ly.setStyle({ fillColor:'#e5e7eb', fillOpacity:0.6, color:'#94a3b8', weight:1 });
        Ly.bindTooltip(`<div><strong>${nm}</strong><br/><span style="color:#d1d5db">No result yet.</span></div>`, {sticky:true});
      }
    });
  }

  function updateFocusOutline(){
    if (!geoLayerInteractive) return;
    geoLayerInteractive.eachLayer(l=>{
      const nm = l.feature?.properties?.CONST_NAME || '';
      const key = norm(nm);
      const fill = leaderColors[key] || '#e5e7eb';
      const isFocused = focusedKey && focusedKey===key;
      try{
        l.setStyle({ fillColor: fill, fillOpacity:0.75, color: isFocused? '#111827':'#94a3b8', weight: isFocused? 3:1 });
        if (isFocused){ l.bringToFront(); startPulse(l); } else { stopPulse(l); }
      }catch(_){}
    });
  }

  function wireInteractiveBehaviors(){
    if (!geoLayerInteractive) return;
    const parishMap = {};
    geoLayerInteractive.eachLayer(l=>{
      const parish = l.feature?.properties?.PARISH_NAM || '';
      (parishMap[parish] ||= []).push(l);
    });
    geoLayerInteractive.eachLayer(layer=>{
      const nm = layer.feature?.properties?.CONST_NAME || '';
      const parish = layer.feature?.properties?.PARISH_NAM || '';
      const key = norm(nm);
      layer.on('click', ()=>{
        const grp = parishMap[parish] || [layer];
        const group = L.featureGroup(grp);
        try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(_){}
        focusedKey = key; updateFocusOutline();
        showConstituencyDetails(key, nm);
      });
      layer.on('mouseover', e=>{
        e.target.setStyle({ weight:(focusedKey===key?3:2), color:'#111827', fillOpacity:0.9 });
        try{ e.target.bringToFront(); e.target.openTooltip(); }catch(_){}
      });
      layer.on('mouseout', e=>{
        const fill = leaderColors[key] || '#e5e7eb';
        const wt = (focusedKey===key)? 3 : 1;
        const col = (focusedKey===key)? '#111827' : '#94a3b8';
        try{ e.target.setStyle({ fillColor: fill, fillOpacity:0.75, color: col, weight: wt }); e.target.closeTooltip(); }catch(_){}
      });
    });
  }

  /* ===== Details panel ===== */
  function showConstituencyDetails(normKey, featureName){
    const cont=document.getElementById('imapContent');
    cont.dataset.currentKey = normKey;
    const block = document.querySelector(`.const[data-key="${normKey}"]`);
    if (!block){ cont.textContent='No data found.'; return; }
    const rows = JSON.parse(block.dataset.candidates || '[]');
    const updated = block.dataset.updated ? Number(block.dataset.updated) : null;
    const cNo = block.dataset.constno ? ` (#${block.dataset.constno})` : '';

    const ageMs = Date.now() - (updated||Date.now());
    let dotColor = 'var(--bad)'; if (ageMs <= 5*60*1000) dotColor='var(--good)'; else if (ageMs <= 20*60*1000) dotColor='var(--warn)';

    const dispName = featureName + cNo;
    const boxStr = block.dataset.boxes || '';
    const boxPct = block.dataset.boxpct || '';

    let html = `<h3 style="margin:4px 0">${dispName}</h3>`;
    html += `
      <div class="updated">
        <span>Last updated:</span>
        <span><span class="pulse" style="color:${dotColor}"></span>
          <span style="font-variant-numeric:tabular-nums">${fmtHHMMSS(Date.now()-(updated||Date.now()))}</span> ago
        </span>
      </div>
      ${boxStr ? `<div class="boxline">Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}</div>` : ''}
    `;
    html += `<table style="width:100%; border-collapse:collapse; margin-top:6px"><thead><tr><th style="width:28px"></th><th>Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      const icon = PARTY_SYMBOLS[r.party] || PARTY_SYMBOLS.Other;
      const nameStyle = `style="color:${PARTY_COLORS[r.party]||PARTY_COLORS.Other}; font-weight:700"`;
      html += `<tr>
        <td><img src="${icon}" alt="${r.party}" class="party-icon" referrerpolicy="no-referrer"></td>
        <td ${nameStyle}>${r.name}</td>
        <td>${r.party}</td>
        <td style="text-align:right; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
        <td style="text-align:right">${r.pct||0}%</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    cont.innerHTML = html;
  }

  /* ===== Shared â€˜Closest racesâ€™ computation + renderers ===== */
  function computeTop10Closest(rawClosest){
    return (rawClosest || [])
      .filter(x => Array.isArray(x.candidates) && x.candidates.length >= 2)
      .map(x => ({
        key: x.key,
        constituency: x.constituency,
        constNo: x.constNo || '',
        marginPct: x.marginPct,
        top2: x.candidates.slice(0,2)
      }))
      .filter(x => !isNaN(x.marginPct))
      .sort((a,b) => a.marginPct - b.marginPct)
      .slice(0, 10);
  }

  function renderClosestInto(container, items, variant='sidebar'){
    if (!container) return;
    container.innerHTML = '';
    const list = computeTop10Closest(items);
    if (!list.length){
      const empty = document.createElement(variant==='national' ? 'p' : 'div');
      empty.className = (variant==='national') ? '' : 'closeitem';
      empty.innerHTML = `<small>No close races available yet.</small>`;
      container.appendChild(empty);
      return;
    }

    if (variant==='national'){
      list.forEach(seat=>{
        const li=document.createElement('li');
        li.style.cursor='pointer';
        const [c1,c2]=seat.top2;
        const color1=PARTY_COLORS[c1.party]||PARTY_COLORS.Other;
        const color2=PARTY_COLORS[c2.party]||PARTY_COLORS.Other;
        const sym1=PARTY_SYMBOLS[c1.party]||PARTY_SYMBOLS.Other;
        const sym2=PARTY_SYMBOLS[c2.party]||PARTY_SYMBOLS.Other;
        li.innerHTML = `
          <div style="display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;">
            <div>
              <div style="font-weight:900">${seat.constNo?`#${seat.constNo} â€” `:''}${seat.constituency}</div>
              <div style="display:grid; gap:4px; margin-top:4px">
                <div style="display:grid; grid-template-columns:20px 1fr auto auto; gap:8px; align-items:center">
                  <img src="${sym1}" class="party-icon" alt="${c1.party}" referrerpolicy="no-referrer" style="height:18px">
                  <div style="color:${color1}; font-weight:800">${c1.name} <small style="color:var(--muted)">(${c1.party})</small></div>
                  <div style="font-weight:800; text-align:right">${Number(c1.votes||0).toLocaleString()}</div>
                  <div style="color:var(--muted); text-align:right">${c1.pct||0}%</div>
                </div>
                <div style="display:grid; grid-template-columns:20px 1fr auto auto; gap:8px; align-items:center">
                  <img src="${sym2}" class="party-icon" alt="${c2.party}" referrerpolicy="no-referrer" style="height:18px">
                  <div style="color:${color2}; font-weight:800">${c2.name} <small style="color:var(--muted)">(${c2.party})</small></div>
                  <div style="font-weight:800; text-align:right">${Number(c2.votes||0).toLocaleString()}</div>
                  <div style="color:var(--muted); text-align:right">${c2.pct||0}%</div>
                </div>
              </div>
            </div>
            <div><strong>${seat.marginPct.toFixed(1)}%</strong></div>
          </div>
        `;
        li.addEventListener('click', ()=> gotoInteractive(seat.key || seat.constituency));
        container.appendChild(li);
      });
      return;
    }

    // Sidebar cards
    list.forEach(seat=>{
      const el=document.createElement('div');
      el.className='closeitem';
      const [c1,c2]=seat.top2;
      const color1=PARTY_COLORS[c1.party]||PARTY_COLORS.Other;
      const color2=PARTY_COLORS[c2.party]||PARTY_COLORS.Other;
      const sym1=PARTY_SYMBOLS[c1.party]||PARTY_SYMBOLS.Other;
      const sym2=PARTY_SYMBOLS[c2.party]||PARTY_SYMBOLS.Other;
      el.innerHTML=`
        <img src="${sym1}" class="party-icon" alt="${c1.party}" referrerpolicy="no-referrer" style="height:18px">
        <div class="name" style="color:${color1}">${c1.name} <small style="color:var(--muted)">(${c1.party})</small></div>
        <div class="votes">${Number(c1.votes||0).toLocaleString()}</div>
        <div class="pct">${c1.pct||0}%</div>

        <img src="${sym2}" class="party-icon" alt="${c2.party}" referrerpolicy="no-referrer" style="height:18px">
        <div class="name" style="color:${color2}">${c2.name} <small style="color:var(--muted)">(${c2.party})</small></div>
        <div class="votes">${Number(c2.votes||0).toLocaleString()}</div>
        <div class="pct">${c2.pct||0}%</div>

        <div class="meta">
          ${seat.constNo?`#${seat.constNo} â€” `:''}${seat.constituency}
          &nbsp;â€¢&nbsp; Margin: <strong>${seat.marginPct.toFixed(1)}%</strong>
        </div>
      `;
      el.addEventListener('click', ()=> gotoInteractive(seat.key || seat.constituency));
      container.appendChild(el);
    });
  }
  function buildClosestSidebar(arr){ renderClosestInto(document.getElementById('sidebarCloseList'), arr, 'sidebar'); }
  function buildClosestNational(arr){
    renderClosestInto(document.getElementById('closestList'), arr, 'national');
    const note = document.getElementById('closestNote');
    if (note) note.textContent = 'Margin = percentage-point gap between 1st and 2nd.';
  }

  /* ===== Sidebar: Recently Updated + ticker ===== */
  function fmtAgeToClass(ageMs){
    if (ageMs <= 5*60*1000) return 'age-good';
    if (ageMs <= 20*60*1000) return 'age-warn';
    return 'age-bad';
  }
  function tickTimersAndRecent(){
    // Update timers on cards
    document.querySelectorAll('.const .timer').forEach(t=>{
      const ts = Number(t.dataset.ts||0);
      const age = ts ? (Date.now()-ts) : 0;
      t.textContent = fmtHHMMSS(age);
      const dot = t.parentElement?.querySelector('.pulse');
      if (dot){
        let col='var(--bad)'; if (age<=5*60*1000) col='var(--good)'; else if (age<=20*60*1000) col='var(--warn)';
        dot.style.color = col;
      }
    });

    // Build lists
    const recents = []; const ticker  = [];
    Object.keys(lastConstUpdated).forEach(k=>{
      const ts = lastConstUpdated[k];
      const age = Date.now()-ts;
      const name = Object.values(window.__rawData||{}).find(x=> canonKey(norm(x?.Name))===k)?.Name || k;
      const num = constNameToNo[k] || '';
      if (ts && age <= SIDEBAR_MAX_AGE) recents.push({k, name, num, ts, age});
      if (ts && age <= TICKER_MAX_AGE)  ticker.push({k, name, num, ts, age});
    });
    recents.sort((a,b)=> b.ts - a.ts);
    ticker.sort((a,b)=> b.ts - a.ts);

    const side = document.getElementById('sidebarList');
    if (side){
      side.innerHTML='';
      recents.forEach(r=>{
        const el=document.createElement('div');
        el.className='sideitem '+fmtAgeToClass(r.age);
        el.dataset.key = r.k;
        el.innerHTML=`<span>#${r.num||'â€”'}</span><small>${fmtHHMMSS(r.age)}</small>`;
        el.addEventListener('click', ()=> gotoInteractiveKey(r.k));
        side.appendChild(el);
      });
    }

    const tick = document.getElementById('tickerText');
    if (tick){
      if (ticker.length){
        const parts = ticker.map(r=> `${r.name}${r.num?` (#${r.num})`:''} â€” ${fmtHHMMSS(Date.now()-r.ts)} ago`);
        tick.textContent = '   â€¢   ' + parts.join('   â€¢   ') + '   â€¢   ';
      }else{
        tick.textContent = 'â€” No constituency updated in the last 15 minutes â€”';
      }
    }

    // Keep interactive panel timer in sync
    const curKey = document.getElementById('imapContent')?.dataset?.currentKey;
    const imTimer = document.querySelector('#imapContent .updated span[style*="font-variant-numeric"]');
    const imDot   = document.querySelector('#imapContent .updated .pulse');
    if (imTimer && curKey && lastConstUpdated[curKey]){
      const age = Date.now()-lastConstUpdated[curKey];
      imTimer.textContent = fmtHHMMSS(age);
      if (imDot){
        let col='var(--bad)'; if (age<=5*60*1000) col='var(--good)'; else if (age<=20*60*1000) col='var(--warn)';
        imDot.style.color = col;
      }
    }
  }

  /* ===== Robust fetch helpers ===== */
  async function fetchOne(url){
    try{
      const r = await fetch(bust(url), {cache:'no-store'});
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      // Try JSON regardless of content-type (some servers mislabel)
      return await r.json();
    }catch(e){ throw new Error(`${url} â†’ ${e.message}`); }
  }
  async function fetchWithFallback(urlList){
    const errors = [];
    for (const u of urlList){
      try{ const data = await fetchOne(u); return { data, ok:true, used:u }; }
      catch(e){ errors.push(e.message); }
    }
    return { ok:false, errors };
  }
  /* ===== Data load ===== */
  async function loadECJAndData(){
    try{
      if (!arcFeatures.length){ try{ await loadECJBoundaries(); }catch(_){ toast('Could not load boundaries.'); } }
      initNationalMap(); initInteractiveMap();
      buildLegendInto('mapLegend'); buildLegendInto('imapLegend');

      const probe = await fetchWithFallback(MAIN_URLS);
      if (probe.ok) DATA_URL = probe.used;

      const data = await fetchOne(DATA_URL);
      window.__rawData = data;

      if (!geoLayerNational){
        geoLayerNational = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapNational);
      }
      if (!geoLayerInteractive){
        geoLayerInteractive = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapInteractive);
      }

      const partyTotals={JLP:0, PNP:0, JPP:0, UIC:0, Other:0};
      const partySeats ={JLP:0, PNP:0, JPP:0, UIC:0, Other:0};
      const detailsByConst={}, closestArr=[];
      Object.values(data).forEach(c=>{
        const cname=c?.Name||''; 
        const cData=Array.isArray(c?.Data)? c.Data[0] : c?.Data;
        const cand = Array.isArray(cData?.Candidates)? cData.Candidates : [];
        if(!cname || !cand.length) return;
        let key = canonKey(norm(cname));

        const safePct  = (x)=> Number(x)||0;
        const safeVote = (x)=> Number(x)||0;
        const winner = cand.reduce((m,x)=> safeVote(x.Votes)>safeVote(m.Votes)? x : m, cand[0]);
        const sorted = cand.slice().sort((a,b)=> safePct(b.Percentage)-safePct(a.Percentage)).map(k=>({
          name:`${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}`.trim(),
          party:partyKey(k.Party),
          votes:safeVote(k.Votes),
          pct:safePct(k.Percentage)
        }));

        const sig = makeHash(cand);
        if (lastConstHashes[key] !== sig){
          lastConstHashes[key] = sig;
          lastConstUpdated[key] = Date.now();
          localStorage.setItem('constituencyHashes', JSON.stringify(lastConstHashes));
          localStorage.setItem('constituencyUpdated', JSON.stringify(lastConstUpdated));
        }

        detailsByConst[key] = { party:partyKey(winner?.Party), all: sorted };
        cand.forEach(k=>{ const p=partyKey(k.Party); partyTotals[p]=(partyTotals[p]||0)+safeVote(k.Votes); });
        const wParty = partyKey(winner?.Party);
        partySeats[wParty] = (partySeats[wParty] ?? 0) + 1;

        const topPct = sorted[0]?.pct||0, runnerPct=sorted[1]?.pct||0;
        closestArr.push({
          key, constituency:cname, constNo:cData?.["Constituency Number"]||'',
          winnerParty: sorted[0]?.party||'Other',
          marginPct: Math.max(0,(topPct-runnerPct)),
          candidates: sorted
        });
      });

      const {totals: groupedTotals, seats: groupedSeats} = groupSmallParties(partyTotals, partySeats, 0.02, Object.keys(PARTY_COLORS));

      buildToplineBar(groupedTotals, groupedSeats);
      buildScoreboard(groupedTotals, groupedSeats);
      buildCharts(groupedTotals, groupedSeats);
      buildClosestSidebar(closestArr);
      buildClosestNational(closestArr);
      renderParishBlocks(detailsByConst, data);
      paintMap(geoLayerNational, detailsByConst);
      paintMap(geoLayerInteractive, detailsByConst);
      wireInteractiveBehaviors();
      updateFocusOutline();

      document.getElementById('lastUpdated').textContent = "Live â€¢ " + new Date().toLocaleTimeString();

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(tickTimersAndRecent, 1000);
      tickTimersAndRecent();
    }catch(e){ console.error(e); toast('Partial update â€” check console.'); }
  }

  function groupSmallParties(totals,seats,threshold=0.02, keep=[]){
    const baseKeys = Array.from(new Set([...keep, 'Other', 'JLP','PNP','JPP','UIC']));
    const total = Object.values(totals).reduce((a,b)=>a+b,0) || 1;
    const T = Object.fromEntries(baseKeys.map(k=>[k,0]));
    const S = Object.fromEntries(baseKeys.map(k=>[k,0]));
    for (const p of Object.keys(totals)){
      const share = totals[p] / total;
      const bucket = (!keep.includes(p) && p!=='Other' && share < threshold) ? 'Other' : p;
      T[bucket] = (T[bucket] || 0) + (totals[p] || 0);
      S[bucket] = (S[bucket] || 0) + (seats[p]  || 0);
    }
    if (T.Other == null) T.Other = 0;
    if (S.Other == null) S.Other = 0;
    return {totals:T, seats:S};
  }

  /* ===== Deep link + handshake ===== */
  function gotoInteractive(name){
    let k = norm(name);
    const alias = NAME_ALIASES[k];
    const resolved = alias?.key || k;
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
    document.getElementById('tab-interactive').classList.remove('hidden');

    if (!geoLayerInteractive){ pendingFocusName = resolved; return; }
    focusConstituencyByName(resolved, true);
    setTimeout(()=> mapInteractive.invalidateSize(), 80);
    document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
  }

  function gotoInteractiveKey(key){
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
    document.getElementById('tab-interactive').classList.remove('hidden');

    if (!geoLayerInteractive){ pendingFocusName = key; return; }
    focusConstituencyByName(key, true);
    setTimeout(()=> mapInteractive.invalidateSize(), 80);
    document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
  }

  function focusConstituencyByNumber(no){
    if (!geoLayerInteractive) return false;
    let found=null, parish=null, display=null, key=null;
    geoLayerInteractive.eachLayer(L=>{
      const p = L.feature?.properties||{};
      const n = String(p.CONST_NO || p.CONSTNO || p.Number || '');
      if (n === String(no)){
        found=L; parish=p.PARISH_NAM; display=p.CONST_NAME; key=norm(p.CONST_NAME||'');
      }
    });
    if (!found) return false;
    const grp=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
    const group = L.featureGroup(grp.length? grp:[found]);
    try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
    focusedKey = key; updateFocusOutline();
    setTimeout(()=> found.openTooltip(), 250);
    showConstituencyDetails(key, display||`#${no}`);
    return true;
  }

  function focusConstituencyByName(nameOrKey, isKey=false){
    if (!geoLayerInteractive) return;
    const rawK = isKey ? nameOrKey : norm(nameOrKey);
    const alias = NAME_ALIASES[rawK];
    const keyWanted = alias?.key || rawK;

    let target=null, parish=null, display=null;
    geoLayerInteractive.eachLayer(L=>{
      const nm = L.feature?.properties?.CONST_NAME || '';
      const k = norm(nm);
      if (k===keyWanted){ target=L; parish = L.feature?.properties?.PARISH_NAM; display=nm; }
    });

    if (target){
      const grp=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
      const group = L.featureGroup(grp.length? grp:[target]);
      try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
      focusedKey = keyWanted; updateFocusOutline();
      startPulse(target);
      setTimeout(()=> target.openTooltip(), 250);
      showConstituencyDetails(keyWanted, display||nameOrKey);
    } else {
      const number = constNameToNo[keyWanted] || constNameToNo[alias?.key || ''];
      if (number && focusConstituencyByNumber(number)) return;
      setTimeout(()=> focusConstituencyByName(nameOrKey, isKey), 150);
    }
  }

  /* ===== Preview modal logic ===== */
  function initPreviewMap(){
    if (previewMap) return;
    previewMap = L.map('previewMap', { zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS, maxBoundsViscosity:1 });
    const isDark = document.documentElement.getAttribute('data-theme')==='dark';
    const base = L.tileLayer(isDark
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      {minZoom:7, maxZoom:15}).addTo(previewMap);
    previewMap.fitBounds(JAMAICA_BOUNDS);
    previewMap.setMinZoom(previewMap.getZoom());
  }

  function closePreview(){
    const modal = document.getElementById('previewModal');
    modal.classList.remove('show');
    document.body.classList.remove('modal-open');
    if (previewLayer){
      try{ previewLayer.eachLayer(stopPulse); previewLayer.remove(); }catch(_){}
      previewLayer=null;
    }
    const shim = document.getElementById('previewShimmer');
    if (shim) shim.style.display='none';
  }
  function populatePreviewDetails(key){
    const tbody = document.getElementById('previewTableBody');
    const boxes = document.getElementById('previewBoxes');
    tbody.innerHTML='';
    boxes.textContent='';
    const block = document.querySelector(`.const[data-key="${key}"]`);
    if (!block) return;
    const rows = JSON.parse(block.dataset.candidates || '[]');
    const boxStr = block.dataset.boxes || '';
    const boxPct = block.dataset.boxpct || '';
    if (boxStr) boxes.innerHTML = `Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}`;
    rows.forEach(r=>{
      const icon = PARTY_SYMBOLS[r.party] || PARTY_SYMBOLS.Other;
      const nameStyle = `style="color:${PARTY_COLORS[r.party]||PARTY_COLORS.Other}; font-weight:700"`;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img src="${icon}" alt="${r.party}" class="party-icon" referrerpolicy="no-referrer"></td>
        <td ${nameStyle}>${r.name}</td>
        <td>${r.party}</td>
        <td style="text-align:right; font-variant-numeric:tabular-nums; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
        <td style="text-align:right">${r.pct||0}%</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openPreviewForKey(key){
    previewKey = key;
    const modal = document.getElementById('previewModal');
    modal.classList.add('show');
    document.body.classList.add('modal-open');

    initPreviewMap();
    const shim = document.getElementById('previewShimmer');
    if (shim) shim.style.display='block';

    // Title
    const rec = Object.values(window.__rawData||{}).find(x => canonKey(norm(x?.Name))===key);
    const displayName = rec?.Name || key;
    const num = constNameToNo[key] || '';
    document.getElementById('previewTitle').textContent = displayName + (num ? ` (#${num})` : '');

    // Hint aria-live
    let hint = 'Review the area below Â· Use the button to open the Interactive Map';
    try{
      const block = document.querySelector(`.const[data-key="${key}"]`);
      const rows  = JSON.parse(block?.dataset?.candidates || '[]');
      const lead  = rows[0];
      const boxes = block?.dataset?.boxes || '';
      if (lead){
        const P = partyKey(lead.party);
        hint = `${lead.name} (${P}) leading â€¢ ${Number(lead.votes||0).toLocaleString()} votes${boxes ? ` â€¢ Boxes: ${boxes}` : ''}`;
      } else if (boxes) { hint = `Boxes: ${boxes}`; }
    }catch(_){}
    document.querySelector('.modal-hint').textContent = hint;

    // Details table + boxes
    populatePreviewDetails(key);

    // Map highlight
    if (previewLayer){ previewLayer.remove(); previewLayer=null; }
    previewLayer = L.geoJSON({type:'FeatureCollection', features: arcFeatures}, {
      style:(feat)=>{
        const nm = feat?.properties?.CONST_NAME || '';
        const k  = norm(nm);
        const isTarget = (k===key);
        const fill = isTarget ? (leaderColors[key] || '#60a5fa') : '#cbd5e1';
        return { color: isTarget ? '#111827' : '#94a3b8', weight: isTarget ? 3 : 1, fillColor: fill, fillOpacity: isTarget ? 0.8 : 0.5 };
      }
    }).addTo(previewMap);

    // Fit to parish bounds, zoom in
    let target=null, parish=null;
    previewLayer.eachLayer(l=>{
      const nm = l.feature?.properties?.CONST_NAME || '';
      if (norm(nm)===key){ target=l; parish=l.feature?.properties?.PARISH_NAM; }
    });
    if (target){
      const grp=[]; previewLayer.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
      const bounds = (grp.length ? L.featureGroup(grp) : target).getBounds();
      try{
        previewMap.fitBounds(bounds, {padding:[24,24]});
        setTimeout(()=> previewMap.zoomIn(1), 120);
      }catch(_){}
      startPulse(target);
    }
    setTimeout(()=> {
      previewMap.invalidateSize();
      if (shim) shim.style.display='none';
    }, 120);

    // Map click = open interactive
    previewMap.off('click');
    previewMap.on('click', ()=> {
      const k = previewKey; closePreview(); if (k) gotoInteractiveKey(k);
    });

    // Focus mgmt
    const goBtn = document.getElementById('btnPreviewGo');
    if (goBtn) goBtn.focus();

    // Update hash
    if (num) location.hash = '#'+num;
  }

  // Modal button + keyboard events
  document.getElementById('btnPreviewClose').addEventListener('click', closePreview);
  document.getElementById('btnPreviewCancel').addEventListener('click', closePreview);
  document.getElementById('btnPreviewGo').addEventListener('click', ()=>{ const k=previewKey; closePreview(); if (k) gotoInteractiveKey(k); });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') closePreview();
    if (e.key === 'Enter' && document.getElementById('previewModal').classList.contains('show')){
      const k = previewKey; closePreview(); if (k) gotoInteractiveKey(k);
    }
  });
  document.getElementById('previewModal').addEventListener('click', (e)=>{
    if (e.target.id === 'previewModal') closePreview();
  });

  /* ===== Auto refresh ===== */
  function setupAutoRefresh(){
    if (refreshTimer) clearInterval(refreshTimer);
    const ms = Number(localStorage.getItem('refreshIntervalMs')||sel.value||AUTO_DEFAULT);
    refreshTimer = setInterval(loadECJAndData, ms);
  }

  /* ===== Parity check (Boxes Counted) ===== */
  function buildCountMap(dataset){
    const out = {};
    if (!dataset) return out;
    const items = Array.isArray(dataset) ? dataset : Object.values(dataset);
    items.forEach(c => {
      const name = c?.Name || c?.name || '';
      if (!name) return;
      let key = canonKey(norm(name));
      const d = Array.isArray(c?.Data) ? c.Data[0] : (c?.Data || c || {});
      let counted = 0;
      if (typeof d["Boxes Counted"] === 'string'){
        const m = d["Boxes Counted"].match(/(\d+)\s*of\s*(\d+)/i);
        if (m) counted = Number(m[1]);
      }
      const numericCounted = d.counted_boxes ?? d.boxes_counted ?? d.boxesCounted ?? d.counted ?? null;
      if (numericCounted != null && !isNaN(Number(numericCounted))) counted = Number(numericCounted);
      out[key] = counted;
    });
    return out;
  }

  function setPillState(which, state, tooltip, subtext){
    const pill = document.getElementById(which==='main' ? 'pillMain' : 'pillBackup');
    const dot  = pill?.querySelector('.dot');
    const txt  = document.getElementById(which==='main' ? 'mainLag' : 'backupLag');
    if (!pill || !dot || !txt) return;
    dot.classList.remove('ok','warn','bad');
    dot.classList.add(state);
    pill.title = tooltip || '';
    txt.textContent = subtext || (state==='ok' ? 'OK' : state==='warn' ? 'Check' : 'Offline');
  }

  function summarizeParity(mainMap, backupMap){
    const keys = new Set([...Object.keys(mainMap), ...Object.keys(backupMap)]);
    const diffs = [];
    let mainBehind=0, backupBehind=0;
    keys.forEach(k=>{
      const m = Number(mainMap[k]||0);
      const b = Number(backupMap[k]||0);
      if (m !== b){
        diffs.push({key:k, main:m, backup:b});
        if (m < b) mainBehind++;
        if (b < m) backupBehind++;
      }
    });
    return { diffs, mainBehind, backupBehind };
  }

  async function runParityCheck(){
    const mRes = await fetchWithFallback(MAIN_URLS);
    if (mRes.ok && DATA_URL !== mRes.used) DATA_URL = mRes.used;
    const bRes = await fetchWithFallback(BACKUP_URLS);

    if (!mRes.ok && !bRes.ok){
      setPillState('main','bad','Main unreachable:\n'+mRes.errors.join('\n'),'Offline');
      setPillState('backup','bad','Backup unreachable:\n'+bRes.errors.join('\n'),'Offline');
      return;
    }
    if (!mRes.ok){
      setPillState('main','bad','Main unreachable:\n'+mRes.errors.join('\n'),'Offline');
      if (bRes.ok) setPillState('backup','warn','Main unreachable; comparison unavailable.\nBackup OK','OK');
      return;
    }
    if (!bRes.ok){
      setPillState('backup','bad','Backup unreachable:\n'+bRes.errors.join('\n'),'Offline');
      setPillState('main','warn','Backup unreachable; comparison unavailable.\nMain OK','OK');
      return;
    }

    const mainMap   = buildCountMap(mRes.data);
    const backupMap = buildCountMap(bRes.data);
    const { diffs, mainBehind, backupBehind } = summarizeParity(mainMap, backupMap);

    if (!diffs.length){
      setPillState('main','ok','Main matches Backup','OK');
      setPillState('backup','ok','Backup matches Main','OK');
      return;
    }
    const tip = `${diffs.length} constituencies differ`;
    if (mainBehind > backupBehind){
      setPillState('main','warn',tip+'\n(Main appears behind)','Behind');
      setPillState('backup','warn',tip+'\n(Main appears ahead)','Ahead');
    }else if (backupBehind > mainBehind){
      setPillState('backup','warn',tip+'\n(Backup appears behind)','Behind');
      setPillState('main','warn',tip+'\n(Backup appears ahead)','Ahead');
    }else{
      setPillState('main','warn',tip+'\n(Mixed differences)','Check');
      setPillState('backup','warn',tip+'\n(Mixed differences)','Check');
    }
  }

  /* ===== Start ===== */
  (async function start(){
    initTheme();
    updateStickyOffsets();
    try{ await loadECJBoundaries(); }catch(_){}
    initNationalMap(); initInteractiveMap();
    buildLegendInto('mapLegend'); buildLegendInto('imapLegend');
    await loadECJAndData();
    setupAutoRefresh();

    // Parity check now and every 5 minutes
    runParityCheck();
    setInterval(runParityCheck, PARITY_INTERVAL_MS);
  })();
</script>
</body>
</html>
