<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Decision 2025 — AP-Inspired Seat Bar + Battleground</title>

<style>
:root{
  --bg:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --card:#ffffff;
  --accent:#0a58ca; --shadow:0 8px 24px rgba(17,24,39,.06);
  --jlp:#2e8b57; --pnp:#ff8c00; --jpp:#6a0dad; --uic:#008b8b; --other:#1e90ff;
}
html[data-theme="dark"]{
  --bg:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:#334155; --card:#0b1220;
  --accent:#60a5fa; --shadow:0 8px 28px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
.container{max-width:1200px;margin:0 auto;padding:16px}

/* Header */
.header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border)}
.header-inner{display:flex;align-items:center;gap:12px;justify-content:space-between;max-width:1200px;margin:0 auto;padding:12px 16px}
.brand{font-weight:900;letter-spacing:.2px}
.mode-btn{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:var(--card);color:var(--text);cursor:pointer;font-weight:800}

/* Seat (majority) bar */
.seatbar-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
.seatbar-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:800}
.seatbar-sub{color:var(--muted);font-weight:600}
.seatbar{position:relative;height:22px;border-radius:999px;background:var(--border);overflow:hidden}
.seatbar .tick{position:absolute;left:calc(32/63*100%);top:-2px;width:2px;height:26px;background:#11182755}
html[data-theme="dark"] .seatbar .tick{background:#e5e7eb66}
.seat-slice{height:100%;display:block}
.tooltip{position:fixed;pointer-events:none;background:#111827;color:#fff;border-radius:8px;padding:8px 10px;
         font-size:.9rem;line-height:1.25;border:1px solid #00000040;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;transform:translateY(4px);transition:opacity .12s,transform .12s}

/* Battleground cards (AP-ish compact) */
.section-h{display:flex;align-items:center;justify-content:space-between;margin:18px 0 10px}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
.bcard{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.bhead{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);
       background:linear-gradient(180deg, color-mix(in oklab, var(--card) 90%, var(--bg)), color-mix(in oklab, var(--card) 75%, var(--bg)))}
.bname{font-weight:900;font-size:1rem;line-height:1.2}
.updated{font-size:.85rem;color:var(--muted);white-space:nowrap}
.pulse{display:inline-block;width:10px;height:10px;border-radius:50%;background:#10b981;margin-right:6px;animation:pulse 1.8s infinite;vertical-align:-1px}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.35)}70%{box-shadow:0 0 0 10px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
.bbody{padding:10px 12px}
.bbadge{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-weight:800;margin-bottom:6px}
.brows{margin-top:6px;border-top:1px solid var(--border)}
.brow{display:grid;grid-template-columns:1fr 80px 60px;gap:10px;align-items:center;padding:8px 2px;border-bottom:1px dashed var(--border);background:color-mix(in oklab, var(--card) 94%, var(--bg))}
.brow:last-child{border-bottom:none}
.bnm{font-weight:800;line-height:1.2}
.JLP{color:var(--jlp)} .PNP{color:var(--pnp)} .JPP{color:var(--jpp)} .UIC{color:var(--uic)} .Other{color:var(--other)}
.bvotes{font-weight:800;text-align:right;font-variant-numeric:tabular-nums}
.bpct{text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}

/* Footer note */
.note{color:var(--muted);font-size:.92rem;margin-top:10px}

/* Toast */
.toast{position:fixed;right:12px;bottom:12px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);z-index:2000;font-weight:700}
.hidden{display:none !important}
</style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">Decision 2025 — Live</div>
      <button id="modeBtn" class="mode-btn" title="Toggle light/dark">🌞 Light</button>
    </div>
  </header>

  <main class="container">
    <!-- Race to 32 -->
    <section class="seatbar-wrap" aria-labelledby="race32">
      <div class="seatbar-head">
        <div id="race32" style="font-weight:900">Race to 32</div>
        <div class="seatbar-sub" id="seatSummary">Loading…</div>
      </div>
      <div id="seatBar" class="seatbar" role="img" aria-label="Seat progress">
        <div class="tick" title="Majority: 32"></div>
        <!-- slices appended by JS -->
      </div>
      <div class="note" id="seatNote">Each slice is one constituency; slice width can be area-weighted using ECJ boundaries.</div>
    </section>

    <!-- Battleground / Closest -->
    <div class="section-h">
      <h2 style="margin:0">Battleground Seats</h2>
      <div class="seatbar-sub" id="bgSubtitle">Closest by vote margin</div>
    </div>
    <section id="bgrid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Floating tooltip for seat slices -->
  <div id="apTip" class="tooltip" role="tooltip" aria-hidden="true"></div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>
  <script>
/* ===================== Config ===================== */
const MAJORITY = 32;           // Race to 32
const TOTAL_SEATS = 63;        // Jamaica lower house size
const DATA_URL = './2025-data.json'; // local data file (if present)
const ECJ_GEOJSON =
 'https://services6.arcgis.com/3R3y1KXaPJ9BFnsU/arcgis/rest/services/ECJWEB_MAP/FeatureServer/6/query?where=1%3D1&outFields=*&f=geojson';

const PARTY_COLORS = { JLP:'var(--jlp)', PNP:'var(--pnp)', JPP:'var(--jpp)', UIC:'var(--uic)', Other:'var(--other)' };

/* ===================== Theme ===================== */
(function initTheme(){
  const btn = document.getElementById('modeBtn');
  const cur = localStorage.getItem('theme') || 'light';
  applyTheme(cur);
  btn.onclick = ()=>{
    const now = document.documentElement.getAttribute('data-theme')==='dark'?'dark':'light';
    const next = (now==='dark'?'light':'dark');
    applyTheme(next);
    localStorage.setItem('theme', next);
  };
  function applyTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    btn.textContent = theme==='dark' ? '🌙 Dark' : '🌞 Light';
  }
})();

/* ===================== Utilities ===================== */
const norm = s => String(s||'').toLowerCase().replace(/[\s\-\u2013\u2014'’.]/g,'').replace(/&/g,'and');
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), 3000);
}
const partyKey = p => {
  const P = String(p||'Other').toUpperCase();
  if (P.startsWith('INDA') || P.startsWith('INDB')) return 'Other';
  return ['JLP','PNP','JPP','UIC'].includes(P) ? P : 'Other';
};

/* Polygon area approximation (equirectangular) for GeoJSON */
function ringArea(coords){
  if (!coords || coords.length<3) return 0;
  // project (lon,lat) to meters using equirectangular at mean lat
  const meanLat = coords.reduce((a,c)=>a+c[1],0)/coords.length * Math.PI/180;
  const R = 6371000; // Earth radius
  const cosLat = Math.cos(meanLat);
  const pts = coords.map(([lon,lat])=>{
    const x = (lon*Math.PI/180) * R * cosLat;
    const y = (lat*Math.PI/180) * R;
    return [x,y];
  });
  let area=0;
  for (let i=0;i<pts.length;i++){
    const [x1,y1] = pts[i];
    const [x2,y2] = pts[(i+1)%pts.length];
    area += (x1*y2 - x2*y1);
  }
  return Math.abs(area)/2;
}
function polygonArea(poly){
  // poly: [ [ [lon,lat],... ] , [hole] , ... ]
  if (!Array.isArray(poly) || !poly.length) return 0;
  let a = ringArea(poly[0]);
  for (let i=1;i<poly.length;i++) a -= ringArea(poly[i]);
  return Math.max(0,a);
}
function featureArea(f){
  const g = f && f.geometry;
  if (!g) return 0;
  if (g.type==='Polygon') return polygonArea(g.coordinates);
  if (g.type==='MultiPolygon') return g.coordinates.reduce((s,p)=>s+polygonArea(p),0);
  return 0;
}

/* ===================== Seat Bar + Tooltip ===================== */
function buildSeatBar(results, areaWeights){
  const bar = document.getElementById('seatBar');
  // Remove old slices
  bar.querySelectorAll('.seat-slice').forEach(n=>n.remove());

  // Build items: each constituency → width weight
  const items = results.map(r=>({
    key:r.key,
    number:r.number||0,
    party:r.party,
    w: (areaWeights && areaWeights[r.key]) ? areaWeights[r.key] : 1
  }));

  // Sort for stable visual band (by party then number)
  items.sort((a,b)=> a.party===b.party ? a.number-b.number : a.party.localeCompare(b.party));

  const totalW = items.reduce((a,b)=>a+b.w,0) || 1;

  items.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'seat-slice';
    div.style.width = (s.w/totalW*100).toFixed(4)+'%';
    div.style.background = PARTY_COLORS[s.party] || PARTY_COLORS.Other;
    div.dataset.key = s.key;

    div.addEventListener('mousemove', ev => showTip(ev, s.key, results));
    div.addEventListener('mouseleave', hideTip);
    div.addEventListener('click', ()=> openConstituency(s.key));

    bar.appendChild(div);
  });

  // Counts + majority note
  const counts = {JLP:0,PNP:0,JPP:0,UIC:0,Other:0};
  results.forEach(r=> counts[r.party] = (counts[r.party]||0)+1 );
  document.getElementById('seatSummary').textContent =
    `JLP ${counts.JLP||0} | PNP ${counts.PNP||0} | JPP ${counts.JPP||0} | UIC ${counts.UIC||0} | Other ${counts.Other||0}`;
}

/* Tooltip content */
function showTip(ev, key, results){
  const tip = document.getElementById('apTip');
  const r = results.find(x=>x.key===key);
  if (!r){ hideTip(); return; }
  const color = PARTY_COLORS[r.party] || PARTY_COLORS.Other;
  tip.innerHTML = `
    <div style="font-weight:900;margin-bottom:4px">${r.name}${r.number?` (#${r.number})`:''}</div>
    <div><span style="color:${color};font-weight:800">${r.leader?.name||'—'}</span> (${r.party})
      — ${(r.leader?.votes||0).toLocaleString()} • ${r.leader?.pct??0}%</div>
    ${r.runner ? `<div style="color:var(--muted)">${r.runner.name} — ${(r.runner.votes||0).toLocaleString()} • ${r.runner.pct??0}%</div>`:''}
  `;
  tip.style.left = (ev.clientX + 12) + 'px';
  tip.style.top  = (ev.clientY + 12) + 'px';
  tip.style.opacity = 1;
  tip.style.transform = 'translateY(0)';
  tip.setAttribute('aria-hidden','false');
}
function hideTip(){
  const tip = document.getElementById('apTip');
  tip.style.opacity = 0;
  tip.style.transform = 'translateY(4px)';
  tip.setAttribute('aria-hidden','true');
}

/* Hook slice/card click into your app (replace as needed) */
function openConstituency(key){
  // Integrate with your router / interactive map / modal here.
  // Example: window.gotoInteractiveKey?.(key);
  console.log('open →', key);
}

/* ===================== Battleground Cards ===================== */
function buildBattleground(results){
  const grid = document.getElementById('bgrid');
  grid.innerHTML = '';

  // Compute close by absolute vote margin between #1 and #2
  const ranked = results
    .filter(r=> r.leader && r.runner)
    .map(r=> ({...r, gap:Math.abs((r.leader.votes||0)-(r.runner.votes||0))}))
    .sort((a,b)=> a.gap - b.gap)
    .slice(0,12);

  document.getElementById('bgSubtitle').textContent =
    ranked.length ? `Closest by vote margin — showing ${ranked.length}` : 'No close races available';

  ranked.forEach(r=>{
    const color = PARTY_COLORS[r.party] || PARTY_COLORS.Other;
    const declared = !!r.declared;
    const card = document.createElement('div');
    card.className='bcard';
    const last = r.lastUpdatedLabel || '—';

    card.innerHTML = `
      <div class="bhead">
        <div class="bname">${r.name}${r.number?` (#${r.number})`:''}</div>
        <div class="updated"><span class="pulse"></span>${last}</div>
      </div>
      <div class="bbody">
        ${declared
          ? `<div class="bbadge" style="background:${color};color:#fff;border-color:${color}">✓ ${r.leader.name} (${r.party})</div>`
          : `<div class="bbadge" style="border-color:${color}">Leading: <b style="color:${color}">${r.leader.name} (${r.party})</b></div>`
        }
        ${r.boxes? `<div class="bbox" style="color:var(--muted);margin-top:4px">Boxes: <b>${r.boxes}</b>${r.boxPct?` (${r.boxPct}%)`:''}</div>`: ''}
        <div class="brows">
          <div class="brow">
            <div class="bnm ${r.party}">${r.leader.name}</div>
            <div class="bvotes">${(r.leader.votes||0).toLocaleString()}</div>
            <div class="bpct">${r.leader.pct??0}%</div>
          </div>
          <div class="brow">
            <div class="bnm ${r.runner.party||'Other'}">${r.runner.name}</div>
            <div class="bvotes">${(r.runner.votes||0).toLocaleString()}</div>
            <div class="bpct">${r.runner.pct??0}%</div>
          </div>
        </div>
      </div>
    `;
    card.addEventListener('click', ()=> openConstituency(r.key));
    grid.appendChild(card);
  });
}

/* ===================== Data Adapters ===================== */
/** Convert your 2025-data.json shape → RESULTS array the seat bar/cards expect. */
function adaptData(raw){
  // raw is an object keyed by constituency name; each has Data[0].Candidates[]
  const results = [];
  Object.values(raw||{}).forEach(c=>{
    const cname = c?.Name || '';
    const d = Array.isArray(c?.Data) ? c.Data[0] : c?.Data;
    const cand = Array.isArray(d?.Candidates) ? d.Candidates : [];
    if (!cname || cand.length===0) return;

    const sortedByVotes = cand
      .map(k=>({
        name: `${(k['First Name']||'').trim()} ${(k['Last Name']||'').trim()}`.trim(),
        party: partyKey(k.Party),
        votes: Number(k.Votes)||0,
        pct: Number(k.Percentage)||0
      }))
      .sort((a,b)=> b.votes - a.votes);

    const leader = sortedByVotes[0] || null;
    const runner = sortedByVotes[1] || null;

    const boxesStr = d?.['Boxes Counted'] || '';
    const pctRaw = Number(d?.['Box Counted Percentage']);
    const declared = (function(){
      let full = false;
      const m = boxesStr && String(boxesStr).match(/(\d+)\s*of\s*(\d+)/i);
      if (m){ const counted=+m[1], total=+m[2]; full = total>0 && counted===total; }
      return full || (!isNaN(pctRaw) && pctRaw>=95);
    })();

    const key = norm(cname);
    const number = Number(d?.['Constituency No'] || d?.ConstNo || '') || null;

    // Build human “x min ago” if updated_ts exists
    let lastUpdatedLabel = '—';
    const ts = Number(d?.updated_ts || 0);
    if (ts){
      const diff = Math.max(0, Date.now()-ts);
      const m = Math.floor(diff/60000), h = Math.floor(m/60);
      lastUpdatedLabel = h ? `${h}h ${m%60}m ago` : `${m}m ago`;
    }

    results.push({
      key, name: cname, number,
      party: leader ? leader.party : 'Other',
      leader, runner,
      declared,
      boxes: boxesStr || '',
      boxPct: !isNaN(pctRaw) ? pctRaw : '',
      lastUpdatedLabel
    });
  });

  // Safety: trim to TOTAL_SEATS if your data includes extras
  if (results.length > TOTAL_SEATS) results.length = TOTAL_SEATS;
  return results;
}

/* ===================== ECJ Area Weights ===================== */
async function fetchAreaWeights(){
  try{
    const r = await fetch(ECJ_GEOJSON, {cache:'no-store'});
    if (!r.ok) throw new Error('ECJ HTTP '+r.status);
    const gj = await r.json();
    const out = {};
    (gj.features||[]).forEach(f=>{
      const cname = f?.properties?.CONST_NAME || '';
      const key = norm(cname);
      out[key] = featureArea(f) || 1;
    });
    // Normalize weights to avoid extreme skews
    const vals = Object.values(out);
    const max = Math.max(...vals,1), min = Math.max(Math.min(...vals),1);
    const normed = {};
    Object.keys(out).forEach(k=>{
      const v = out[k];
      // clamp to 10x range for readability
      const clamped = Math.min(max, Math.max(min, v));
      normed[k] = clamped;
    });
    return normed;
  }catch(e){
    console.warn('Area weight fetch failed:', e);
    return null;
  }
}

/* ===================== Boot ===================== */
(async function start(){
  // Try to load local data; otherwise use demo
  let raw;
  try{
    const r = await fetch(DATA_URL, {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    raw = await r.json();
  }catch(e){
    console.warn('Local 2025-data.json not found, using demo.', e);
    raw = demoData();
    document.getElementById('seatNote').textContent =
      'Demo data loaded (could not find 2025-data.json). Each slice is one constituency.';
    toast('Demo mode: 2025-data.json not found');
  }

  const results = adaptData(raw);

  // If you want strictly MAJORITY race count visual (first 63 only):
  if (results.length && results.length !== TOTAL_SEATS){
    document.getElementById('seatNote').textContent += ` • Loaded ${results.length}/${TOTAL_SEATS} seats`;
  }

  // Compute area weights (optional)
  const weights = await fetchAreaWeights();
  buildSeatBar(results, weights);
  buildBattleground(results);
})();

/* ===================== Demo dataset (only used if local file missing) ===================== */
function demoData(){
  // Minimal shape that mimics your 2025-data.json
  const mk = (name, n, lVotes, lPct, lParty, rVotes, rPct, rParty, boxes='120 of 180', pctBoxes=66, updated_ts=Date.now() - Math.random()*3600_000) => ({
    Name:name,
    Data:[{
      "Constituency No": n,
      "Boxes Counted": boxes,
      "Box Counted Percentage": pctBoxes,
      updated_ts,
      Candidates:[
        {"First Name":"Leader","Last Name":String(n),"Votes":lVotes,"Percentage":lPct,"Party":lParty},
        {"First Name":"Runner","Last Name":String(n),"Votes":rVotes,"Percentage":rPct,"Party":rParty},
        {"First Name":"Other","Last Name":String(n),"Votes":Math.floor(Math.random()*2000),"Percentage":5,"Party":"Other"}
      ]
    }]
  });
  const obj = {};
  const names = [
    'Kingston Western','Kingston Central','Kingston Eastern and Port Royal','St. Andrew West Rural',
    'St. Andrew Eastern','St. Andrew Western','St. Andrew North Central','St. Andrew East Central',
    'St. Catherine North Central','St. Catherine Eastern','St. Catherine West Central','St. Catherine South Central',
    'St. James West Central','St. James Central','St. Elizabeth North Eastern'
  ];
  names.forEach((nm,i)=>{
    const n = i+1;
    const lParty = i%2? 'PNP':'JLP';
    const rParty = i%2? 'JLP':'PNP';
    const lVotes = 10000 + Math.floor(Math.random()*6000);
    const rVotes = lVotes - (500 + Math.floor(Math.random()*4000));
    const total = lVotes + rVotes + 1000;
    const lPct = Math.round(1000*lVotes/total)/10;
    const rPct = Math.round(1000*rVotes/total)/10;
    obj[nm] = mk(nm, n, lVotes, lPct, lParty, rVotes, rPct, rParty);
  });
  return obj;
}
</script>
</body>
</html>
