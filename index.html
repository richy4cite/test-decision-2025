<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>Jamaica Decision 2025 — Live Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet + Chart.js + Turf -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  /* THEME TOKENS */
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --accent:#0a58ca;
    --card:#ffffff; --card-alt:#f8fafc; --shadow:0 6px 18px rgba(17,24,39,.06);
    --jlp:#2e8b57; --pnp:#ff8c00; --jpp:#6a0dad; --uic:#008b8b; --other:#1e90ff;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --hdrh:56px; --tabh:48px;
  }
  html[data-theme="dark"]{
    --bg:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:#334155; --accent:#60a5fa;
    --card:#111827; --card-alt:#0b1220; --shadow:0 6px 18px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  body.modal-open{overflow:hidden}

  /* Header (sticky above maps) */
  .header{position:sticky; top:0; z-index:1500; background:var(--card); border-bottom:1px solid var(--border)}
  .header-inner{max-width:1800px; margin:0 auto; padding:14px 24px; display:flex; align-items:center; gap:18px; flex-wrap:wrap}
  .brand{font-weight:800; font-size:1.25rem; letter-spacing:.2px}
  .live-pill{margin-left:auto; display:flex; align-items:center; gap:8px; font-weight:700}
  .live-dot{width:10px; height:10px; border-radius:50%; background:#ef4444; animation:pulse 1.8s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}70%{box-shadow:0 0 0 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
  .refresh{display:flex; align-items:center; gap:6px}
  select, .mode-btn{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:var(--card); color:var(--text); cursor:pointer; font-weight:700}
  .mode-btn{display:flex; align-items:center; gap:6px}
  .status-group{display:flex; align-items:center; gap:12px; margin-left:8px}
  .status-pill{display:flex; align-items:center; gap:8px;background:var(--card); border:1px solid var(--border); border-radius:999px;padding:6px 10px; font-weight:800}
  .status-pill small{color:var(--muted); font-weight:600}
  .dot{width:10px; height:10px; border-radius:50%; animation:pulse 1.8s infinite; background:#10b981}

  /* Tabs (sticky under header) */
  .tabs{position:sticky; top:var(--hdrh); z-index:1400; background:var(--card); border-bottom:1px solid var(--border)}
  .tabs-inner{max-width:1800px; margin:0 auto; padding:0 24px; display:flex; gap:24px}
  .tab{padding:14px 2px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:800}
  .tab.active{border-color:var(--accent); color:var(--text)}

  /* Page grid (right column fixed) */
  .page{display:grid; grid-template-columns:1fr minmax(0,1600px) 360px 1fr; gap:16px}
  .page > .main{grid-column:2}

  /* RIGHT COLUMN: two stacked panels */
  .rightcol{grid-column:3; position:sticky; top:calc(var(--hdrh) + var(--tabh) + 12px); align-self:start;
    height:calc(100vh - (var(--hdrh) + var(--tabh) + 28px));
    display:grid; grid-template-rows:1fr 1fr; gap:12px; z-index:1}
  .sidepanel{display:flex; flex-direction:column; min-height:0; background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden}
  .sidepanel h3{margin:8px 10px; font-size:1rem}
  .panel-body{min-height:0; overflow:auto; padding:6px 8px}
  .panel-body:has(.empty){display:flex; align-items:center; justify-content:center; color:var(--muted)}

  /* Recently updated items */
  .sideitem{position:relative; display:flex; justify-content:space-between; align-items:center;
    border:2px solid var(--border); border-radius:10px; padding:4px 8px; margin:6px 0; font-weight:800; cursor:pointer; background:var(--card);
    transition:transform .06s ease, background .12s ease; line-height:1.2}
  .sideitem:hover{background:color-mix(in oklab, var(--card) 90%, var(--bg)); transform:translateY(-1px)}
  .sideitem small{color:var(--muted); font-weight:700; font-size:.85em; font-variant-numeric:tabular-nums}
  .sideitem .pin-btn{border:1px solid var(--border); background:var(--card); border-radius:8px; padding:2px 6px; font-size:.75rem; margin-left:8px; cursor:pointer}
  .age-good{border-color:var(--good)} .age-warn{border-color:var(--warn)} .age-bad{border-color:var(--bad)}

  /* Closest panel — tight rows */
  .closest-item{border:2px solid var(--border); border-radius:10px; margin:6px 0; overflow:hidden; background:var(--card); cursor:pointer}
  .closest-head{display:flex; align-items:center; justify-content:space-between; gap:6px; padding:6px 8px; background:var(--card-alt); border-bottom:1px solid var(--border)}
  .closest-head .cname{font-weight:900; font-size:.95rem; line-height:1.1}
  .closest-body{padding:4px 8px}
  .closerow{display:grid; grid-template-columns:22px 1fr 72px 62px; gap:8px; align-items:center; padding:3px 0; line-height:1.1}
  .closerow .votes, .closerow .pct{font-variant-numeric:tabular-nums; text-align:right; font-weight:800; font-size:.92rem}
  .closerow img{height:16px; width:auto}
  .closest-foot{padding:4px 8px; border-top:1px dashed var(--border); color:var(--muted); display:flex; justify-content:space-between; align-items:center; font-size:.9rem}
  .closest-item:hover{background:color-mix(in oklab, var(--card) 94%, var(--bg))}
  .closest-pin{border:1px solid var(--border); border-radius:8px; background:var(--card); padding:3px 6px; font-weight:800; font-size:.8rem}

  /* Topline container */
  .topline{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border-bottom:1px solid var(--border)}
  .topline-inner{max-width:1800px; margin:0 auto; padding:14px 24px; display:grid; gap:14px}

  /* ===== NEW: AP-style Seat Bar (Race to 32) ===== */
  .seat-wrap{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow)}
  .seat-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .seat-title b{font-size:1.05rem}
  .seatbar{
    position:relative; display:flex; height:28px;
    border:1px solid var(--border); border-radius:8px; overflow:hidden; background:var(--card-alt)
  }
  .seat-slice{height:100%; cursor:pointer; transition:filter .15s ease,opacity .15s ease; outline:1px solid rgba(0,0,0,.05)}
  .seat-slice:hover{filter:brightness(0.95)}
  .seatbar .tick{position:absolute; top:-4px; bottom:-4px; width:2px; background:#11182755; left:calc(32/63*100%)}
  .seat-legend{display:flex; gap:8px; align-items:center; margin-top:8px; color:var(--muted); font-size:.92rem; flex-wrap:wrap}
  .sw{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.1)}

  /* ===== Top stats cards (unchanged) ===== */
  .topgrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px}
  .stat{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
        background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow)}
  .stat-logo{height:26px; width:auto}
  .stat-name{font-weight:900; letter-spacing:.2px}
  .stat-main{font-weight:900; font-size:1.6rem}
  .stat-sub{color:var(--muted); font-size:.92rem}
  .mini-bar{grid-column:1/-1; height:8px; border-radius:999px; background:var(--border); overflow:hidden}
  .mini-bar > span{display:block; height:100%}
  .king{border:2px solid color-mix(in oklab, var(--accent) 60%, var(--border));}

  /* Constituency list container */
  .container{max-width:1600px; margin:14px auto; padding:0 24px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}

  .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
  .controls input, .controls select{border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:var(--card); color:var(--text)}
  .controls input#searchBar{width:420px; max-width:95vw}

  .parish{margin:12px 0 22px}
  .parish h2{font-size:1.1rem; border-left:4px solid var(--accent); padding-left:10px; margin:0 0 12px}
  .const-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}

  /* ===== NEW: Battleground-style constituency card ===== */
  .bcard{border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card); cursor:pointer; transition:transform .08s ease, box-shadow .15s ease}
  .bcard:hover{transform:translateY(-2px); box-shadow:var(--shadow)}
  .bhead{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px;
         background:linear-gradient(180deg, color-mix(in oklab, var(--card) 92%, var(--bg)), var(--card)); border-bottom:1px solid var(--border)}
  .bname{font-weight:900; font-size:1rem}
  .bbadge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08); font-weight:800}
  .bbody{padding:10px 12px}
  .bbox{color:var(--muted); margin-bottom:6px}
  .brows{border-top:1px solid var(--border); margin-top:6px}
  .brow{display:grid; grid-template-columns:1fr 80px 60px; gap:10px; align-items:center; padding:6px 0; border-bottom:1px solid var(--border)}
  .brow:last-child{border-bottom:none}
  .bnm{font-weight:800; line-height:1.1}
  .bvotes, .bpct{text-align:right; font-variant-numeric:tabular-nums}
  .winner-declared{box-shadow:inset 0 0 0 2px rgba(0,0,0,.04)}
  .bdeclared{outline:2px solid color-mix(in oklab, var(--accent) 40%, var(--border)); outline-offset:-2px; border-radius:12px}

  /* Party text tints */
  .JLP{color:var(--jlp)} .PNP{color:var(--pnp)} .JPP{color:var(--jpp)} .UIC{color:var(--uic)} .Other{color:var(--other)}

  /* Maps */
  .map-wrap{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card-alt); z-index:1}
  #mapContainer{height:460px}
  #imapMap{height:60vh; min-height:380px; max-height:72vh}
  .mapControls{position:absolute; right:8px; top:8px; z-index:500}
  .btn{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; color:var(--text)}
  .btn:hover{filter:brightness(0.98)}
  .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
  .legend-item{display:inline-flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); padding:6px 10px; border-radius:999px}
  .swatch{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15)}
  .leaflet-tooltip{background:#111827; color:#f9fafb; border:0; border-radius:8px; padding:8px 10px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .leaflet-container{background:var(--card-alt)}
  .leaflet-control-attribution{display:none}

  /* National tab charts */
  .charts{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
  .chart-wrap{position:relative; height:300px}
  .chart-wrap canvas{position:absolute; inset:0}

  /* Bottom ticker */
  .ticker{position:sticky; bottom:0; z-index:1600; background:#0b1220; color:#fff; border-top:1px solid #0f172a}
  html[data-theme="dark"] .ticker{background:#0b1220}
  .ticker-inner{max-width:1600px; margin:0 auto; padding:10px 24px; display:flex; align-items:center; gap:12px; overflow:hidden}
  .tick-title{font-weight:800; margin-right:8px}
  .marquee{white-space:nowrap; overflow:hidden; flex:1}
  .marquee span{display:inline-block; padding-left:100%; animation:scroll 180s linear infinite}
  @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  .hidden{display:none !important}
  .toast{position:fixed; right:12px; bottom:72px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); z-index:2000; font-weight:700}

  /* Tooltip for seat bar */
  .tooltip{
    position:fixed;z-index:2000;pointer-events:none;
    background:#111827;color:#f9fafb;border-radius:8px;padding:6px 8px;
    font-size:.85rem;box-shadow:0 8px 22px rgba(0,0,0,.25);opacity:0;transform:translateY(4px);
    transition:opacity .12s ease, transform .12s ease
  }

  /* Preview modal */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(2px)}
  .modal.show{display:flex}
  .modal-content{width:min(1100px, 66vw); max-height:86vh; background:var(--card); color:var(--text);
    border:1px solid var(--border); border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.35);
    display:grid; grid-template-rows:auto auto 1fr auto; overflow:hidden}
  .modal-header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border)}
  .modal-title{font-weight:900; font-size:1.05rem}
  .modal-hint{padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--border)}
  .modal-body{display:grid; grid-template-columns:1.2fr .8fr; gap:0; min-height:380px}
  #previewMap{min-height:380px; position:relative}
  .modal-details{border-left:1px solid var(--border); padding:10px 12px; overflow:auto}
  .modal-actions{padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end}
  .btn-secondary{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border:1px solid var(--border)}
  .btn-primary{background:var(--accent); border:1px solid color-mix(in oklab, var(--accent) 70%, black); color:white}
  .close-x{border-radius:10px; padding:6px 10px; background:var(--card); border:1px solid var(--border); cursor:pointer}
  .shimmer{position:absolute; inset:0; pointer-events:none; background:linear-gradient(100deg, rgba(0,0,0,0) 0%, rgba(148,163,184,.22) 40%, rgba(0,0,0,0) 80%);
    background-size:200% 100%; animation:shimmer 1.2s linear infinite; z-index:5}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Floating pinned race */
  .pin-float{position:fixed; right:12px; bottom:110px; z-index:2000; width:min(380px, 92vw);
    background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); overflow:hidden}
  .pin-float .head{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:var(--card-alt); border-bottom:1px solid var(--border); font-weight:900}
  .pin-float .body{padding:8px 10px}
  .pin-float .close{border:1px solid var(--border); border-radius:8px; padding:4px 8px; background:var(--card); cursor:pointer}
  .pin-float .row{display:grid; grid-template-columns:26px 1fr 80px 70px; gap:10px; padding:6px 0; align-items:center}
  .pin-float img{height:18px}

  @media (max-width:1300px){
    .page{display:block}
    .rightcol{position:relative; top:auto; height:auto; grid-template-rows:auto auto}
  }
</style>
</head>
<body>
  <div class="page">
    <!-- MAIN -->
    <div class="main">
      <!-- Header -->
      <header class="header" id="siteHeader">
        <div class="header-inner">
          <div class="brand">Jamaica Decision 2025 — Live Results</div>

          <button id="modeBtn" class="mode-btn" title="Toggle light/dark">🌞 Light</button>

          <div class="refresh">
            <span style="color:var(--muted)">Auto-refresh:</span>
            <select id="refreshSel">
              <option value="15000">15s</option>
              <option value="30000">30s</option>
              <option value="60000" selected>1m</option>
              <option value="120000">2m</option>
              <option value="300000">5m</option>
            </select>
            <button id="btnForceRefresh" class="btn">Refresh now</button>
          </div>

          <div class="status-group" id="sourceStatus">
            <div class="status-pill" id="pillMain" title="Using local 2025-data.json">
              <span class="dot" aria-hidden="true"></span> Data <small id="mainLag">Local file</small>
            </div>
          </div>

          <div class="live-pill"><span class="live-dot"></span><span id="lastUpdated">Updating…</span></div>
        </div>
      </header>

      <!-- Tabs -->
      <nav class="tabs" id="siteTabs">
        <div class="tabs-inner">
          <div class="tab active" data-tab="constituencies">Constituencies</div>
          <div class="tab" data-tab="interactive">Interactive Map</div>
          <div class="tab" data-tab="national">National</div>
        </div>
      </nav>

      <!-- ===== Topline: AP-style Seat Bar + Party Stats ===== -->
      <section class="topline">
        <div class="topline-inner">
          <!-- AP-style seat bar (Race to 32) -->
          <div class="seat-wrap">
            <div class="seat-title">
              <b>Seat Progress — Race to 32</b>
              <span class="muted" id="seatSummary">Loading…</span>
            </div>
            <div class="seatbar" id="seatBar"><div class="tick" title="Majority threshold: 32"></div></div>
            <div class="seat-legend">
              <span><span class="sw" style="background:var(--jlp)"></span> JLP</span>
              <span><span class="sw" style="background:var(--pnp)"></span> PNP</span>
              <span><span class="sw" style="background:var(--jpp)"></span> JPP</span>
              <span><span class="sw" style="background:var(--uic)"></span> UIC</span>
              <span><span class="sw" style="background:var(--other)"></span> Other</span>
            </div>
          </div>

          <!-- Party stat cards -->
          <div id="topStats" class="topgrid"></div>
        </div>
      </section>

      <!-- NATIONAL -->
      <section id="tab-national" class="hidden">
        <div class="container">
          <div class="scoreboard" id="scoreboard"></div>

          <div class="charts">
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Total Votes by Party</h2>
              <div class="chart-wrap"><canvas id="voteChart"></canvas></div>
            </div>
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Seats Won by Party</h2>
              <div class="chart-wrap"><canvas id="seatChart"></canvas></div>
            </div>
          </div>

          <div class="card">
            <h2>Top 10 Closest Seats</h2>
            <ul id="closestList" class="closelist" style="list-style:none; padding:0; margin:0; display:grid; gap:8px"></ul>
            <p id="closestNote" style="color:var(--muted); margin-top:8px"></p>
          </div>

          <div class="card">
            <h2>Seats Won Map</h2>
            <div class="map-wrap">
              <div id="mapContainer"></div>
              <div class="mapControls"><button id="btnResetNational" class="btn">Reset view</button></div>
            </div>
            <div id="mapLegend" class="legend"></div>
          </div>
        </div>
      </section>

      <!-- CONSTITUENCIES -->
      <section id="tab-constituencies">
        <div class="container">
          <div class="card">
            <div class="controls">
              <input id="searchBar" type="text" placeholder="Search candidate, constituency, #…">
              <select id="parishFilter"><option value="">All Parishes</option></select>
              <select id="partyFilter">
                <option value="">All Parties</option>
                <option>JLP</option><option>PNP</option><option>JPP</option><option>UIC</option><option>Other</option>
              </select>
            </div>
            <h2>Constituencies by Parish</h2>
            <div id="parishContainer"></div>
          </div>
        </div>
      </section>

      <!-- INTERACTIVE MAP -->
      <section id="tab-interactive" class="hidden">
        <div class="container">
          <div class="card">
            <h2>Interactive Map</h2>
            <div class="map-wrap">
              <div id="imapMap"></div>
              <div class="mapControls"><button id="btnResetInteractive" class="btn">Reset view</button></div>
            </div>
            <div id="imapLegend" class="legend" style="margin-top:8px"></div>
            <div id="imapDetails" class="card" style="margin-top:12px">
              <h2 style="margin-top:0">Constituency Details</h2>
              <div id="imapContent" class="small">Click a constituency to see results here.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT: Two stacked sidebars -->
    <aside class="rightcol" aria-label="Right panels">
      <!-- Recently Updated (top half) -->
      <section class="sidepanel" id="panelUpdated" aria-label="Recently Updated Constituency Numbers">
        <h3>Recently Updated (#)</h3>
        <div class="panel-body"><div id="sidebarList"></div></div>
      </section>

      <!-- Closest Races (bottom half) -->
      <section class="sidepanel" id="panelClosest" aria-label="Closest Races">
        <h3>Closest Races (≤ 200 votes)</h3>
        <div class="panel-body"><div id="closestSidebar"></div></div>
      </section>
    </aside>
  </div>

  <!-- Bottom ticker -->
  <div class="ticker">
    <div class="ticker-inner">
      <span class="tick-title">Live Updates:</span>
      <div class="marquee"><span id="tickerText">—</span></div>
    </div>
  </div>

  <!-- Floating pinned race -->
  <div id="pinFloat" class="pin-float hidden" aria-live="polite"></div>

  <!-- Tooltip (seat bar hover) -->
  <div class="tooltip" id="tooltip"></div>

  <!-- ================== PREVIEW MODAL ================== -->
  <div class="modal" id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="previewTitle">Constituency</div>
        <button class="close-x" id="btnPreviewClose" aria-label="Close preview">✕</button>
      </div>
      <div class="modal-hint" aria-live="polite">Loading…</div>
      <div class="modal-body">
        <div id="previewMap">
          <div class="shimmer" id="previewShimmer"></div>
        </div>
        <div class="modal-details">
          <div id="previewBoxes" class="boxline" style="margin-top:2px"></div>
          <table style="width:100%; border-collapse:collapse; margin-top:8px">
            <thead>
              <tr><th style="width:28px"></th><th style="text-align:left">Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr>
            </thead>
            <tbody id="previewTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPreviewCancel">Close</button>
        <button class="btn btn-primary" id="btnPreviewGo">Open in Interactive Map</button>
      </div>
    </div>
  </div>
  
<script>
/* ===========================
   Jamaica Decision 2025 — App JS
   Part 2 (logic)
   =========================== */

/* ===== Config ===== */
const AUTO_DEFAULT = 60000;
const DATA_URL = './2025-data.json';           // local file
const ECJ_GEOJSON =
 'https://services6.arcgis.com/3R3y1KXaPJ9BFnsU/arcgis/rest/services/ECJWEB_MAP/FeatureServer/6/query?where=1%3D1&outFields=*&f=geojson';

const JAMAICA_BOUNDS = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);
const JAMAICA_BOUNDS_LEAF = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);

const TOTAL_SEATS = 63;
const MAJORITY_TARGET = 32;                    // race to 32
const CLOSE_VOTE_THRESHOLD = 200;              // ≤ 200 votes difference

/* Party theming */
const PARTY_COLORS = { JLP:'#2e8b57', PNP:'#ff8c00', JPP:'#6a0dad', UIC:'#008b8b', Other:'#1e90ff' };
const PARTY_LOGOS = {
  JLP:'https://www.ecj.com.jm/wp-content/uploads/2025/03/JLP_logo-300x98.png',
  PNP:'https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_logo-300x182.png',
  JPP:'https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_logo-300x275.png',
  UIC:'https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_logo-300x164.png',
  Other:'https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png'
};
const PARTY_SYMBOLS = {
  JLP:'https://ecj.com.jm/wp-content/uploads/2025/03/JLP_symbol.png',
  PNP:'https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_symbol.png',
  JPP:'https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_symbol-300x261.png',
  UIC:'https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_symbol-300x106.png',
  Other:'https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png'
};

const TICKER_MAX_AGE = 15*60*1000;
const SIDEBAR_MAX_AGE = 25*60*1000;

/* ===== Normalizer + Name Aliases ===== */
function norm(s){ return String(s||'').toLowerCase().replace(/[\s\-–—'’.]/g,'').replace(/&/g,'and'); }
const NAME_ALIASES = {
  [norm('Kingston East and Port Royal')]: { key: norm('Kingston Eastern and Port Royal'), parish: 'KINGSTON', constno: '3' }
};
function canonKey(k){ return NAME_ALIASES[k]?.key || k; }

/* ===== State ===== */
let voteChart=null, seatChart=null, refreshTimer=null, timerInterval=null;
let mapNational=null, mapInteractive=null, geoLayerNational=null, geoLayerInteractive=null;
let baseLightNat=null, baseDarkNat=null, baseLightInt=null, baseDarkInt=null, currentBase='light';
let arcFeatures=[], byParish={}, constNameToNo={}, constNameToParish={};
let areaByKey = {};                 // GeoJSON area per constituency (turf)
let leaderColors = {};
let focusedKey = null;
let pendingFocusName = null;
let lastSeats = JSON.parse(localStorage.getItem('lastSeats') || '{}');
let lastConstHashes = JSON.parse(localStorage.getItem('constituencyHashes')||'{}');
let lastConstUpdated = JSON.parse(localStorage.getItem('constituencyUpdated')||'{}');

let hoverPreviewLayer=null;
let pinnedKey = localStorage.getItem('pinnedRaceKey') || null;

let previewMap=null, previewLayer=null, previewKey=null;

window.__rawData = {};
window.__detailsByConst = {};

/* ===== Utils ===== */
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),4000); }
function contrastText(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16); return ((r*299+g*587+b*114)/1000>=140)?'#0b1220':'#ffffff'; }catch{ return '#0b1220'; } }
function fmtHHMMSS(ms){ const s=Math.max(0,Math.floor(ms/1000)); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
function makeHash(cands){ return cands.map(k=>`${(k.Party||'Other').toUpperCase()}|${(k['First Name']||'').trim()} ${(k['Last Name']||'').trim()}|${Number(k.Votes||0)}`).join(';'); }
const partyKey = p => { const P = String(p||'Other').toUpperCase(); if (P.startsWith('INDA') || P.startsWith('INDB')) return 'Other'; return ['JLP','PNP','JPP','UIC'].includes(P) ? P : 'Other'; };
const bust = url => url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now();

/* ===== Theme ===== */
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  const modeBtn = document.getElementById('modeBtn');
  if (modeBtn) modeBtn.textContent = theme==='dark' ? '🌙 Dark' : '🌞 Light';

  if (mapNational && baseLightNat && baseDarkNat){
    if (theme==='dark' && currentBase!=='dark'){ mapNational.removeLayer(baseLightNat); baseDarkNat.addTo(mapNational); currentBase='dark'; }
    if (theme==='light' && currentBase!=='light'){ mapNational.removeLayer(baseDarkNat); baseLightNat.addTo(mapNational); currentBase='light'; }
    setTimeout(()=>mapNational.invalidateSize(), 60);
  }
  if (mapInteractive && baseLightInt && baseDarkInt){
    if (theme==='dark'){ mapInteractive.removeLayer(baseLightInt); baseDarkInt.addTo(mapInteractive); }
    else { mapInteractive.removeLayer(baseDarkInt); baseLightInt.addTo(mapInteractive); }
    setTimeout(()=>mapInteractive.invalidateSize(), 60);
  }
}
function initTheme(){
  const saved = localStorage.getItem('theme') || 'light';
  applyTheme(saved);
  const modeBtn = document.getElementById('modeBtn');
  if (modeBtn){
    modeBtn.addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
      const next = cur==='dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });
  }
}

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById('tab-'+t.dataset.tab).classList.remove('hidden');

  if (t.dataset.tab==='national'){
    if (mapNational) setTimeout(()=>mapNational.invalidateSize(), 60);
    try{ voteChart?.resize(); seatChart?.resize(); }catch(_){}
  }

  if (t.dataset.tab==='interactive' && mapInteractive) {
    setTimeout(()=>mapInteractive.invalidateSize(), 60);
    if (pendingFocusName){ focusConstituencyByName(pendingFocusName, true); pendingFocusName=null; }
    else {
      const cur = document.getElementById('imapContent')?.dataset?.currentKey;
      if (cur) focusConstituencyByName(cur, true);
    }
  }
}));

/* ===== Sticky offsets ===== */
function updateStickyOffsets(){
  const hdr = document.getElementById('siteHeader');
  const tabs = document.getElementById('siteTabs');
  if (hdr){ document.documentElement.style.setProperty('--hdrh', hdr.offsetHeight+'px'); }
  if (tabs){ document.documentElement.style.setProperty('--tabh', tabs.offsetHeight+'px'); }
}
window.addEventListener('resize', updateStickyOffsets);

/* ===== Auto refresh ===== */
const sel = document.getElementById('refreshSel');
if (sel){
  sel.value = localStorage.getItem('refreshIntervalMs') || String(AUTO_DEFAULT);
  sel.addEventListener('change', ()=>{ localStorage.setItem('refreshIntervalMs', sel.value); setupAutoRefresh(); });
}
const forceBtn = document.getElementById('btnForceRefresh');
if (forceBtn){ forceBtn.addEventListener('click', ()=>{ loadAll(); }); }

/* ===== Maps ===== */
function initNationalMap(){
  if (mapNational) return;
  mapNational = L.map('mapContainer',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
  baseLightNat = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
  baseDarkNat  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
  (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkNat : baseLightNat).addTo(mapNational);
  mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
  mapNational.setMinZoom(mapNational.getZoom());
  const btn = document.getElementById('btnResetNational');
  if (btn){
    btn.onclick = ()=>{
      mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
      mapNational.setMinZoom(mapNational.getZoom());
      setTimeout(()=> mapNational.invalidateSize(), 40);
    };
  }
}
function initInteractiveMap(){
  if (mapInteractive) return;
  mapInteractive = L.map('imapMap',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
  baseLightInt = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
  baseDarkInt  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
  (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkInt : baseLightInt).addTo(mapInteractive);
  mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
  mapInteractive.setMinZoom(mapInteractive.getZoom());
  const btn = document.getElementById('btnResetInteractive');
  if (btn){
    btn.onclick = ()=>{
      mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
      mapInteractive.setMinZoom(mapInteractive.getZoom());
      focusedKey = null; pendingFocusName = null;
      const cont = document.getElementById('imapContent');
      cont.textContent = 'Click a constituency to see results here.';
      cont.dataset.currentKey = '';
      if (geoLayerInteractive){
        geoLayerInteractive.eachLayer(l=>{
          try{ l.closeTooltip(); }catch(_){}
          const nm = l.feature?.properties?.CONST_NAME || '';
          const key = norm(nm);
          const fill = leaderColors[key] || '#e5e7eb';
          l.setStyle({ fillColor:fill, fillOpacity:0.75, color:'#94a3b8', weight:1 });
          stopPulse(l);
        });
      }
      setTimeout(()=> mapInteractive.invalidateSize(), 40);
    };
  }
  window.addEventListener('resize', ()=> setTimeout(()=> mapInteractive.invalidateSize(), 40));
}
function buildLegendInto(containerId){
  const host=document.getElementById(containerId); if(!host) return;
  host.innerHTML='';
  ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
    const el=document.createElement('span'); el.className='legend-item';
    el.innerHTML=`<span class="swatch" style="background:${PARTY_COLORS[p]}"></span>${p}`;
    host.appendChild(el);
  });
}

/* ===== Boundaries ===== */
async function loadECJBoundaries(){
  const gj = await fetch(ECJ_GEOJSON, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('Boundaries HTTP '+r.status); return r.json(); });
  arcFeatures = gj.features || [];
  byParish = {}; constNameToNo={}; constNameToParish={}; areaByKey = {};
  arcFeatures.forEach(f=>{
    const p=f.properties||{};
    const parish = p.PARISH_NAM || p.PARISH_NAME || '';
    const cname  = p.CONST_NAME || p.CONSTNAME || p.Name || '';
    const cno    = p.CONST_NO || p.CONSTNO || p.Number || '';
    const key=norm(cname);
    if (parish) (byParish[parish] ||= []);
    constNameToNo[key]=(cno||'').toString();
    constNameToParish[key]=parish||'';
    // compute polygon area for seat bar weighting
    try{
      const area = turf.area(f); // in m²
      areaByKey[key] = area || 1;
    }catch(_){ areaByKey[key] = 1; }
  });
  Object.values(NAME_ALIASES).forEach(a=>{
    if (a.key){
      constNameToParish[a.key] = a.parish || constNameToParish[a.key] || '';
      constNameToNo[a.key]     = a.constno || constNameToNo[a.key] || '';
      if (areaByKey[a.key] == null) areaByKey[a.key] = 1;
    }
  });
}

/* ===== Pulsing helpers ===== */
function startPulse(layer){
  if (!layer || layer._pulseTimer) return;
  let up=true;
  layer._pulseTimer = setInterval(()=>{
    const next = up ? 0.95 : 0.6; up=!up;
    layer.setStyle({ fillOpacity: next });
  }, 800);
}
function stopPulse(layer){
  if (layer && layer._pulseTimer){
    clearInterval(layer._pulseTimer);
    layer._pulseTimer = null;
    layer.setStyle({ fillOpacity:0.75 });
  }
}

/* ===== Topline: seat bar + stats ===== */
function partyFullName(k){
  switch(k){
    case 'JLP': return 'Jamaica Labour Party';
    case 'PNP': return 'People’s National Party';
    case 'JPP': return 'Jamaica Progressive Party';
    case 'UIC': return 'United Independents\' Congress';
    default: return 'Other Parties';
  }
}
function buildTopStats(totals, seats){
  const host = document.getElementById('topStats'); if(!host) return;
  host.innerHTML = '';
  const totalVotes = Object.values(totals).reduce((a,b)=>a+b,0) || 1;
  const entries = ['JLP','PNP','JPP','UIC','Other'].map(key=>{
    const votes = totals[key]||0; const votePct = (votes/totalVotes)*100; const s = seats[key]||0;
    return { key, votes, votePct, seats:s };
  });
  const maxSeats = Math.max(...entries.map(e=>e.seats));
  entries.forEach(e=>{
    const color = PARTY_COLORS[e.key] || PARTY_COLORS.Other;
    const card = document.createElement('div');
    card.className = 'stat' + (e.seats===maxSeats && e.seats>0 ? ' king' : '');
    card.innerHTML = `
      <img class="stat-logo" src="${PARTY_LOGOS[e.key]}" alt="${e.key} logo" referrerpolicy="no-referrer">
      <div>
        <div class="stat-name">${partyFullName(e.key)}</div>
        <div class="stat-sub">Votes: <b>${e.votes.toLocaleString()}</b> • ${e.votePct.toFixed(1)}%</div>
      </div>
      <div class="stat-main" style="color:${color}">${e.seats}</div>
      <div class="mini-bar"><span style="width:${Math.min(100,e.votePct).toFixed(1)}%; background:${color}"></span></div>
    `;
    host.appendChild(card);
  });
}

/* AP-style seat bar: each constituency → slice width ~ area */
function buildSeatBar(detailsByConst){
  const bar = document.getElementById('seatBar');
  const summary = document.getElementById('seatSummary');
  if (!bar) return;
  bar.innerHTML = '<div class="tick" title="Majority threshold: 32"></div>';

  // Build array of seats with area weight and winner (or leading)
  const seats = [];
  let jlp=0,pnp=0,jpp=0,uic=0,oth=0;
  Object.keys(detailsByConst).forEach(key=>{
    const info = detailsByConst[key];
    const lead = info.all?.[0];
    const P = partyKey(lead?.party || 'Other');
    const area = Math.max(1, areaByKey[key] || 1);
    seats.push({ key, party:P, area });
    if (P==='JLP') jlp++; else if (P==='PNP') pnp++; else if (P==='JPP') jpp++; else if (P==='UIC') uic++; else oth++;
  });

  // Normalize widths to 100%
  const totalArea = seats.reduce((a,b)=>a+b.area,0) || 1;
  // Stable order: group by party bucket then by area (or by const no if available)
  seats.sort((a,b)=>{
    if (a.party!==b.party) return a.party.localeCompare(b.party);
    return (constNameToNo[a.key]||'').localeCompare(String(constNameToNo[b.key]||''));
  });

  seats.forEach(s=>{
    const w = (s.area/totalArea)*100;
    const div = document.createElement('div');
    div.className = 'seat-slice';
    div.style.cssText = `width:${w.toFixed(4)}%; background:${PARTY_COLORS[s.party]||PARTY_COLORS.Other}`;
    div.dataset.key = s.key;
    div.title = ''; // handled by custom tooltip
    // Hover tooltip
    div.addEventListener('mousemove', (e)=> showSeatTooltip(e, s.key));
    div.addEventListener('mouseleave', hideSeatTooltip);
    // Click → preview
    div.addEventListener('click', ()=> openPreviewForKey(s.key));
    bar.appendChild(div);
  });

  summary.textContent = `JLP ${jlp} | PNP ${pnp} | JPP ${jpp} | UIC ${uic} | Other ${oth}`;
}
function showSeatTooltip(ev, key){
  const tip = document.getElementById('tooltip'); if (!tip) return;
  const rec = Object.values(window.__rawData||{}).find(x=> canonKey(norm(x?.Name))===key);
  const name = rec?.Name || key;
  const cno = constNameToNo[key] ? ` (#${constNameToNo[key]})` : '';
  const rows = window.__detailsByConst[key]?.all || [];
  const lead = rows[0];
  const P = partyKey(lead?.party || 'Other');
  const color = PARTY_COLORS[P] || '#888';
  tip.innerHTML = `
    <div style="font-weight:900; margin-bottom:4px">${name}${cno}</div>
    ${lead ? `<div><span style="color:${color}; font-weight:800">${lead.name}</span> (${P}) — ${Number(lead.votes||0).toLocaleString()} • ${lead.pct||0}%</div>` : `<div style="color:#cbd5e1">No data</div>`}
  `;
  tip.style.left = (ev.clientX + 12) + 'px';
  tip.style.top  = (ev.clientY + 12) + 'px';
  tip.style.opacity = 1;
  tip.style.transform = 'translateY(0)';
}
function hideSeatTooltip(){
  const tip = document.getElementById('tooltip'); if (!tip) return;
  tip.style.opacity = 0;
  tip.style.transform = 'translateY(4px)';
}

/* ===== National tab ===== */
function buildScoreboard(totals,seats){
  const el=document.getElementById('scoreboard'); if(!el) return; el.innerHTML='';
  const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
  const prev = JSON.parse(localStorage.getItem('lastSeats')||'{}');
  [{key:'JLP', name:'Jamaica Labour Party', color:PARTY_COLORS.JLP, logo:PARTY_LOGOS.JLP},
   {key:'PNP', name:'People’s National Party', color:PARTY_COLORS.PNP, logo:PARTY_LOGOS.PNP},
   {key:'Other', name:'Others (JPP, UIC, etc.)', color:PARTY_COLORS.Other, logo:PARTY_LOGOS.Other}].forEach(g=>{
    const votes=totals[g.key]||0, s=seats[g.key]||0, pct=((votes/(totalVotes||1))*100).toFixed(1);
    const delta=s-(prev?.[g.key]||0);
    const deltaHtml = delta?`<span class="delta ${delta>0?'up':'down'}">${delta>0?'▲':'▼'} ${Math.abs(delta)}</span>`:'';
    const div=document.createElement('div'); div.className='pcard';
    div.innerHTML = `
      <div class="phead">
        <div class="pbrand" style="color:${g.color}">
          <img class="plogo" src="${g.logo}" alt="${g.key} logo" referrerpolicy="no-referrer">
          <strong>${g.name}</strong>
        </div>
        <div class="pmain" style="color:${g.color}">${pct}%</div>
      </div>
      <div class="bar"><span style="width:${pct}%; background:${g.color}"></span></div>
      <div style="margin-top:8px; color:var(--muted)"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; Votes: ${votes.toLocaleString()}</div>`;
    el.appendChild(div);
  });
}
function buildCharts(totals,seats){
  const vc=document.getElementById('voteChart'), sc=document.getElementById('seatChart');
  try{ voteChart && voteChart.destroy(); }catch(_){}
  try{ seatChart && seatChart.destroy(); }catch(_){}
  const labels=Object.keys(totals); if(!labels.length) return;
  const colors=labels.map(p=>PARTY_COLORS[p]||PARTY_COLORS.Other);
  voteChart=new Chart(vc,{type:'pie',data:{labels,datasets:[{data:labels.map(k=>totals[k]||0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  seatChart=new Chart(sc,{type:'bar',data:{labels,datasets:[{label:'Seats',data:labels.map(k=>seats[k]||0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,precision:0,grid:{color:'rgba(148,163,184,.3)'}}}}});
}
function buildClosestPanel(items){
  const list=document.getElementById('closestList');
  const note=document.getElementById('closestNote');
  if(!list || !note) return;
  list.innerHTML='';
  const top10 = (items||[])
    .filter(x => !isNaN(x.marginPct))
    .sort((a,b)=> a.marginPct - b.marginPct)
    .slice(0,10);
  top10.forEach(item=>{
    const party = (item.winnerParty||'Other').toUpperCase();
    const color = PARTY_COLORS[party] || '#1e90ff';
    const li=document.createElement('li');
    li.style.cssText='border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:var(--card)';
    li.innerHTML = `
      <span>
        <strong>${item.constituency}</strong> —
        <span style="color:${color}">
          ${item.winnerFirst} ${item.winnerLast} (${party})
        </span>
      </span>
      <span><strong>${(item.marginPct||0).toFixed(1)}%</strong></span>
    `;
    li.title = (item.candidates||[]).slice(0,3).map(c =>
      `${c.name} (${(c.party||'Other').toUpperCase()}): ${Number(c.votes||0).toLocaleString()} • ${c.pct || 0}%`
    ).join(' | ');
    li.addEventListener('click', ()=> gotoInteractive(item.constituency));
    list.appendChild(li);
  });
  note.textContent = 'Margin = percentage-point gap between 1st and 2nd.';
}

/* ===== Map coloring & interactions ===== */
function paintMap(layer, detailsByConst){
  if (!layer) return;
  layer.eachLayer(Ly=>{
    const nm = Ly.feature?.properties?.CONST_NAME || '';
    const key = norm(nm);
    const info = detailsByConst[key];
    if (info){
      const fill = PARTY_COLORS[partyKey(info.party)] || PARTY_COLORS.Other;
      leaderColors[key]=fill;
      const isFocused = focusedKey && focusedKey===key;
      Ly.setStyle({ fillColor: fill, fillOpacity:isFocused?0.85:0.75, color:isFocused?'#111827':'#94a3b8', weight:isFocused?3:1 });
      const disp = `${nm}${constNameToNo[key]?` (#${constNameToNo[key]})`:''}`;
      const rows = (info.all||[]).slice(0,3).map(c=>{
        const P=partyKey(c.party), col=PARTY_COLORS[P]||PARTY_COLORS.Other;
        return `<div><span style="color:${col}; font-weight:700">${c.name}</span> (${P}) — ${c.votes.toLocaleString()} • ${c.pct}%</div>`;
      }).join('');
      Ly.bindTooltip(`<div style="min-width:260px"><div style="font-weight:800;margin-bottom:4px">${disp}</div>${rows}</div>`, {sticky:true});
    }else{
      Ly.setStyle({ fillColor:'#e5e7eb', fillOpacity:0.6, color:'#94a3b8', weight:1 });
      Ly.bindTooltip(`<div><strong>${nm}</strong><br/><span style="color:#d1d5db">No result yet.</span></div>`, {sticky:true});
    }
  });
}
function updateFocusOutline(){
  if (!geoLayerInteractive) return;
  geoLayerInteractive.eachLayer(l=>{
    const nm = l.feature?.properties?.CONST_NAME || '';
    const key = norm(nm);
    const fill = leaderColors[key] || '#e5e7eb';
    const isFocused = focusedKey && focusedKey===key;
    const isHovering = hoverPreviewLayer && hoverPreviewLayer === l;
    l.setStyle({ fillColor: fill, fillOpacity:isHovering?0.9:0.75, color: (isFocused||isHovering)? '#111827':'#94a3b8', weight: (isFocused||isHovering)? 3:1 });
    if (isFocused || isHovering){ try{ l.bringToFront(); }catch(_){}
      startPulse(l);
    } else { stopPulse(l); }
  });
}
function getLayerByKey(key){
  let target=null;
  if (!geoLayerInteractive) return null;
  geoLayerInteractive.eachLayer(l=>{
    const nm = l.feature?.properties?.CONST_NAME || '';
    if (norm(nm)===key) target=l;
  });
  return target;
}
function previewHoverStart(key){
  const layer = getLayerByKey(key);
  hoverPreviewLayer = layer || null;
  if (layer){
    try{ layer.openTooltip(); layer.bringToFront(); }catch(_){}
    updateFocusOutline();
  }
}
function previewHoverEnd(){
  if (hoverPreviewLayer){ try{ hoverPreviewLayer.closeTooltip(); }catch(_){} }
  hoverPreviewLayer = null; updateFocusOutline();
}
function wireInteractiveBehaviors(){
  if (!geoLayerInteractive) return;
  const hoverTimers = new WeakMap();
  byParish = {};
  geoLayerInteractive.eachLayer(l=>{
    const parish = l.feature?.properties?.PARISH_NAM;
    (byParish[parish] ||= []).push(l);
  });
  geoLayerInteractive.eachLayer(layer=>{
    const nm = layer.feature?.properties?.CONST_NAME || '';
    const parish = layer.feature?.properties?.PARISH_NAM || '';
    const key = norm(nm);
    layer.on('click', ()=>{
      const grp = byParish[parish] || [layer];
      const group = L.featureGroup(grp);
      try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
      focusedKey = key; updateFocusOutline();
      showConstituencyDetails(key, nm);
    });
    layer.on('mouseover', e=>{
      const t = setTimeout(()=>{ try{ e.target.openTooltip(); }catch(_){}} , 800);
      hoverTimers.set(layer, t);
      e.target.setStyle({ weight: (focusedKey===key? 3:2), color:'#111827', fillOpacity:0.9 }); e.target.bringToFront();
    });
    layer.on('mouseout', e=>{
      clearTimeout(hoverTimers.get(layer));
      try{ e.target.closeTooltip(); }catch(_){}
      const fill = leaderColors[key] || '#e5e7eb';
      const wt = (focusedKey===key)? 3 : 1;
      const col = (focusedKey===key)? '#111827' : '#94a3b8';
      e.target.setStyle({ fillColor: fill, fillOpacity:0.75, color: col, weight: wt });
    });
  });
}

/* ===== Details panel ===== */
function showConstituencyDetails(normKey, featureName){
  const cont=document.getElementById('imapContent');
  cont.dataset.currentKey = normKey;
  const block = document.querySelector(`.bcard[data-key="${normKey}"]`);
  if (!block){ cont.textContent='No data found.'; return; }
  const rows = JSON.parse(block.dataset.candidates || '[]');
  const updated = block.dataset.updated ? Number(block.dataset.updated) : null;
  const cNo = block.dataset.constno ? ` (#${block.dataset.constno})` : '';

  const ageMs = Date.now() - (updated||Date.now());
  let dotColor = 'var(--bad)';
  if (ageMs <= 5*60*1000) dotColor = 'var(--good)';
  else if (ageMs <= 20*60*1000) dotColor = 'var(--warn)';

  const dispName = featureName + cNo;
  const boxStr = block.dataset.boxes || '';
  const boxPct = block.dataset.boxpct || '';

  let html = `<h3 style="margin:4px 0">${dispName}</h3>`;
  html += `
    <div class="updated">
      <span>Last updated:</span>
      <span><span class="pulse" style="color:${dotColor}"></span>
        <span style="font-variant-numeric:tabular-nums">${fmtHHMMSS(Date.now()-(updated||Date.now()))}</span> ago
      </span>
    </div>
    ${boxStr ? `<div class="bbox">Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}</div>` : ''}
  `;
  html += `<table style="width:100%; border-collapse:collapse; margin-top:6px"><thead><tr><th style="width:28px"></th><th>Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const P = partyKey(r.party);
    const icon = PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other;
    const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}; font-weight:700"`;
    html += `<tr>
      <td><img src="${icon}" alt="${P}" class="party-icon" referrerpolicy="no-referrer"></td>
      <td ${nameStyle}>${r.name}</td>
      <td>${P}</td>
      <td style="text-align:right; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
      <td style="text-align:right">${r.pct||0}%</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  cont.innerHTML = html;
}

/* ===== Battleground-style constituency cards ===== */
function renderParishBlocks(detailsByConst, rawData){
  const host=document.getElementById('parishContainer'); host.innerHTML='';
  const parishSel = document.getElementById('parishFilter');
  const partySel  = document.getElementById('partyFilter');

  const allKeys = Object.keys(detailsByConst);
  const parishOf = k => constNameToParish[k] || '';
  const cnoOf    = k => (constNameToNo[k] || '');
  const recOf    = k => Object.values(rawData).find(x=> canonKey(norm(x?.Name))===k);
  const nameOf   = k => (recOf(k)?.Name || k);

  const parishSet = new Set(allKeys.map(parishOf));
  let parishes = Array.from(parishSet).sort((a,b)=> a.localeCompare(b));

  const curParish = parishSel.value;
  parishSel.innerHTML = `<option value="">All Parishes</option>` + parishes.map(p=>`<option ${curParish===p?'selected':''} value="${p}">${p}</option>`).join('');

  const filterParish = parishSel.value;
  const filterParty  = partySel.value;

  parishes.forEach(parish=>{
    if (filterParish && parish!==filterParish) return;
    let keys = allKeys.filter(k=> parishOf(k)===parish);

    // Order by constituency number then by name
    keys.sort((a,b)=>{
      const A = Number(cnoOf(a)) || 0;
      const B = Number(cnoOf(b)) || 0;
      if (A!==B) return A-B;
      return nameOf(a).localeCompare(nameOf(b));
    });

    const wrap=document.createElement('div'); wrap.className='parish';
    wrap.innerHTML = `<h2>${parish||'—'}</h2><div class="const-grid"></div>`;
    const grid = wrap.querySelector('.const-grid');

    keys.forEach(key=>{
      const info = detailsByConst[key];
      const record = recOf(key);
      const origName = record?.Name || key;
      const cNo = constNameToNo[key] || '';

      if (filterParty && !info.all.some(c=> partyKey(c.party)===filterParty)) return;

      const winnerParty = partyKey(info.all?.[0]?.party || 'Other');
      const winnerObj = info.all?.[0] || null;

      const bg = PARTY_COLORS[winnerParty] || PARTY_COLORS.Other;
      const textColor = contrastText(bg);
      const candidatesPayload = JSON.stringify(info.all || []);
      const updatedTs = lastConstUpdated[key] || '';

      // Boxes counted / declare rule (full or >=95%)
      let boxes = '', boxpct = ''; let canDeclare=false;
      if (record?.Data){
        const d = Array.isArray(record.Data)? record.Data[0] : record.Data;
        boxes  = d?.['Boxes Counted'] || '';
        const pctRaw = (d?.['Box Counted Percentage']!=null) ? Number(d['Box Counted Percentage']) : null;
        boxpct = (pctRaw!=null && !isNaN(pctRaw)) ? String(pctRaw) : '';
        const m = boxes ? String(boxes).match(/(\d+)\s*of\s*(\d+)/i) : null;
        const counted = m ? +m[1] : null, total = m ? +m[2] : null;
        const fullCount = total>0 && counted===total;
        canDeclare = fullCount || (pctRaw!=null && pctRaw>=95);
      }

      const el=document.createElement('div'); el.className='bcard';
      el.dataset.key = key;
      el.dataset.constno = cNo;
      el.dataset.updated = updatedTs;
      el.dataset.candidates = candidatesPayload;
      el.dataset.boxes = boxes;
      el.dataset.boxpct = boxpct;
      // Search: candidate names + constituency name + number
      el.dataset.search = [origName, cNo, ...(info.all||[]).map(c=>`${c.name}`)].join(' ').toLowerCase();
      el.dataset.parish = parish;

      const ageMs = Date.now() - (updatedTs||Date.now());
      let dotColor = 'var(--bad)';
      if (ageMs <= 5*60*1000) dotColor = 'var(--good)'; else if (ageMs <= 20*60*1000) dotColor = 'var(--warn)';

      const niceName = `${origName} ${cNo?`(#${cNo})`:''}`;

      const badgeHTML = (winnerObj && canDeclare)
        ? `<div class="bbadge" style="background:${bg}; color:${textColor}; border-color:${bg}">
             <span>✓</span> ${winnerObj.name} (${winnerParty})
           </div>`
        : (winnerObj
           ? `<div class="bbadge" style="background:var(--card); color:var(--text); border-color:${bg}">
                Leading: <strong style="color:${bg}">${winnerObj.name} (${winnerParty})</strong>
              </div>`
           : ``);

      const rowsHTML = (info.all||[]).map(c=>{
        const P=partyKey(c.party);
        const nameClass = P;
        return `<div class="brow">
          <div class="bnm ${nameClass}">${c.name}</div>
          <div class="bvotes">${Number(c.votes||0).toLocaleString()}</div>
          <div class="bpct">${c.pct||0}%</div>
        </div>`;
      }).join('');

      el.innerHTML = `
        <div class="bhead" ${canDeclare?`style="box-shadow:inset 0 0 0 2px ${bg}20"`:''}>
          <div class="bname">${niceName}</div>
          <span class="updated" style="gap:2px">
            <span><span class="pulse" style="color:${dotColor}"></span>
              <span class="timer" data-ts="${updatedTs||''}" style="font-variant-numeric:tabular-nums">
                ${fmtHHMMSS(Date.now()-(updatedTs||Date.now()))}
              </span> ago
            </span>
          </span>
        </div>
        <div class="bbody">
          ${badgeHTML}
          ${boxes? `<div class="bbox">Boxes counted: <strong>${boxes}</strong>${boxpct?` (${boxpct}%)`:''}</div>` : ''}
          <div class="brows">${rowsHTML}</div>
        </div>
      `;
      if (canDeclare) el.classList.add('bdeclared');

      el.addEventListener('click', ()=> openPreviewForKey(key));
      grid.appendChild(el);
    });

    if (grid.children.length) document.getElementById('parishContainer').appendChild(wrap);
  });

  // Search filter
  const sb = document.getElementById('searchBar');
  function applyTextFilter(){
    const q = sb.value.trim().toLowerCase();
    document.querySelectorAll('.bcard').forEach(card=>{
      const hit = !q || card.dataset.search.includes(q);
      card.style.display = hit ? '' : 'none';
    });
    document.querySelectorAll('.parish').forEach(p=>{
      const any = p.querySelector('.const-grid').children.length &&
                  Array.from(p.querySelectorAll('.bcard')).some(x=> x.style.display!=='none');
      p.style.display = any ? '' : 'none';
    });
  }
  sb.oninput = applyTextFilter;
}

/* ===== Periodic timers + sidebars + ticker ===== */
function fmtAgeToClass(age){
  if (age <= 5*60*1000) return 'age-good';
  if (age <= 20*60*1000) return 'age-warn';
  return 'age-bad';
}
function tickTimersAndRecent(){
  // Timers on cards
  document.querySelectorAll('.timer').forEach(t=>{
    const ts = Number(t.dataset.ts||0);
    if (!ts) { t.textContent = '00:00:00'; return; }
    const age = Date.now()-ts;
    t.textContent = fmtHHMMSS(age);
    const dot = t.parentElement?.querySelector('.pulse');
    if (dot){
      let col='var(--bad)';
      if (age <= 5*60*1000) col='var(--good)';
      else if (age <= 20*60*1000) col='var(--warn)';
      dot.style.color = col;
    }
  });

  // Recent items + ticker
  const recents = []; const ticker  = [];
  Object.keys(lastConstUpdated).forEach(k=>{
    const ts = lastConstUpdated[k];
    const age = Date.now()-ts;
    const name = Object.values(window.__rawData||{}).find(x=> canonKey(norm(x?.Name))===k)?.Name || k;
    const num = constNameToNo[k] || '';
    if (ts && age <= SIDEBAR_MAX_AGE) recents.push({k, name, num, ts, age});
    if (ts && age <= TICKER_MAX_AGE)  ticker.push({k, name, num, ts, age});
  });

  recents.sort((a,b)=> b.ts - a.ts);
  ticker.sort((a,b)=> b.ts - a.ts);

  // Recently updated sidebar
  const side = document.getElementById('sidebarList');
  if (side){
    side.innerHTML='';
    recents.forEach(r=>{
      const el=document.createElement('div');
      el.className='sideitem '+fmtAgeToClass(r.age);
      el.dataset.key = r.k;
      el.innerHTML=`<span>#${r.num||'—'}</span><small>${fmtHHMMSS(r.age)}</small>
        <button class="pin-btn" title="Pin race" aria-label="Pin race">📌</button>`;
      el.addEventListener('click', ()=> gotoInteractiveKey(r.k));
      el.addEventListener('mouseenter', ()=> previewHoverStart(r.k));
      el.addEventListener('mouseleave', previewHoverEnd);
      el.querySelector('.pin-btn').addEventListener('click', (e)=>{ e.stopPropagation(); pinRace(r.k); renderPinned(window.__detailsByConst, window.__rawData); });
      side.appendChild(el);
    });
  }

  // Ticker
  const tick = document.getElementById('tickerText');
  if (tick){
    if (ticker.length){
      const parts = ticker.map(r=> `${r.name}${r.num?` (#${r.num})`:''} — ${fmtHHMMSS(Date.now()-r.ts)} ago`);
      tick.textContent = '   •   ' + parts.join('   •   ') + '   •   ';
    }else{
      tick.textContent = '— No constituency updated in the last 15 minutes —';
    }
  }

  // Update timer inside Interactive details
  const imTimer = document.querySelector('#imapContent .updated span[style*="font-variant-numeric"]');
  const imDot   = document.querySelector('#imapContent .updated .pulse');
  const curKey = document.getElementById('imapContent')?.dataset?.currentKey;
  if (imTimer && curKey && lastConstUpdated[curKey]){
    const age = Date.now()-lastConstUpdated[curKey];
    imTimer.textContent = fmtHHMMSS(age);
    if (imDot){
      let col='var(--bad)'; if (age<=5*60*1000) col='var(--good)'; else if (age<=20*60*1000) col='var(--warn)';
      imDot.style.color = col;
    }
  }
}

/* ===== Robust fetch ===== */
async function fetchOne(url){
  try{
    const r = await fetch(bust(url), {cache:'no-store'});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    // try .json() even if content-type is missing on local files
    return await r.json();
  }catch(e){ throw new Error(`${url} → ${e.message}`); }
}

/* ===== Closest sidebar (≤ 200 votes) ===== */
function buildClosestSidebar(detailsByConst, rawData){
  const host = document.getElementById('closestSidebar');
  if (!host) return;
  host.innerHTML='';
  const items = [];
  Object.keys(detailsByConst).forEach(key=>{
    const info = detailsByConst[key];
    const rows = (info.all||[]).slice(0,2);
    if (rows.length<2) return;
    const gap = Math.abs((rows[0].votes||0) - (rows[1].votes||0));
    if (gap <= CLOSE_VOTE_THRESHOLD){
      const displayName = Object.values(rawData).find(x=> canonKey(norm(x?.Name))===key)?.Name || key;
      items.push({ key, name:displayName, cno:(constNameToNo[key]||''), gap, top:rows[0], second:rows[1] });
    }
  });
  items.sort((a,b)=> a.gap - b.gap);
  const top10 = items.slice(0,10);
  if (!top10.length){ host.innerHTML = `<div class="empty">No close races (≤ ${CLOSE_VOTE_THRESHOLD} votes) yet.</div>`; return; }

  top10.forEach(item=>{
    const wrap = document.createElement('div');
    wrap.className='closest-item';
    wrap.dataset.key = item.key;
    const cname = `${item.name}${item.cno?` (#${item.cno})`:''}`;

    const rowHTML = (cand)=>{
      const P = partyKey(cand.party);
      const icon = PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other;
      const color = PARTY_COLORS[P] || '#888';
      return `<div class="closerow" role="row">
        <img src="${icon}" alt="${P}" referrerpolicy="no-referrer">
        <div class="nm" style="font-weight:800;color:${color}">${cand.name}</div>
        <div class="votes">${Number(cand.votes||0).toLocaleString()}</div>
        <div class="pct">${cand.pct||0}%</div>
      </div>`;
    };

    wrap.innerHTML = `
      <div class="closest-head">
        <div class="cname">${cname}</div>
        <div><button class="closest-pin" title="Pin this race">📌 Pin</button></div>
      </div>
      <div class="closest-body">
        ${rowHTML(item.top)}
        ${rowHTML(item.second)}
      </div>
      <div class="closest-foot">
        <span>Gap: <b>${item.gap.toLocaleString()}</b> votes</span>
        <button class="btn btn-secondary small-open">Open</button>
      </div>
    `;

    wrap.addEventListener('click', (e)=>{
      const isPin = e.target.closest('.closest-pin');
      const isOpen = e.target.closest('.small-open');
      if (isPin){ pinRace(item.key); renderPinned(detailsByConst, rawData); e.stopPropagation(); return; }
      if (isOpen){ gotoInteractiveKey(item.key); e.stopPropagation(); return; }
      gotoInteractiveKey(item.key);
    });
    wrap.addEventListener('mouseenter', ()=> previewHoverStart(item.key));
    wrap.addEventListener('mouseleave', previewHoverEnd);

    host.appendChild(wrap);
  });
}

/* ===== Pinned floating card ===== */
function renderPinned(detailsByConst, rawData){
  const box = document.getElementById('pinFloat');
  if (!box) return;
  if (!pinnedKey){ box.classList.add('hidden'); box.innerHTML=''; return; }
  const info = detailsByConst[pinnedKey];
  const rec  = Object.values(rawData||{}).find(x=> canonKey(norm(x?.Name))===pinnedKey);
  if (!info || !rec){ box.classList.add('hidden'); box.innerHTML=''; return; }
  const rows = (info.all||[]).slice(0,2);
  const cname = `${rec.Name || pinnedKey}${constNameToNo[pinnedKey]?` (#${constNameToNo[pinnedKey]})`:''}`;
  const rowHTML = cand=>{
    const P = partyKey(cand.party), icon=PARTY_SYMBOLS[P]||PARTY_SYMBOLS.Other, color=PARTY_COLORS[P]||'#888';
    return `<div class="row"><img src="${icon}" alt="${P}" referrerpolicy="no-referrer"><div style="font-weight:800;color:${color}">${cand.name}</div><div class="votes">${Number(cand.votes||0).toLocaleString()}</div><div class="pct">${cand.pct||0}%</div></div>`;
    };
  box.innerHTML = `
    <div class="head">
      <span>📌 ${cname}</span>
      <div><button class="close" id="btnPinUnpin">Unpin</button></div>
    </div>
    <div class="body">
      ${rows.map(rowHTML).join('')}
      <div style="margin-top:6px; display:flex; gap:6px">
        <button class="btn btn-secondary" id="btnPinOpen">Open</button>
      </div>
    </div>
  `;
  box.classList.remove('hidden');
  document.getElementById('btnPinUnpin').onclick = ()=>{ unpinRace(); };
  document.getElementById('btnPinOpen').onclick  = ()=>{ gotoInteractiveKey(pinnedKey); };
  box.addEventListener('mouseenter', ()=> previewHoverStart(pinnedKey));
  box.addEventListener('mouseleave', previewHoverEnd);
}
function pinRace(key){ pinnedKey = key; localStorage.setItem('pinnedRaceKey', key); toast('Pinned race 📌'); }
function unpinRace(){ pinnedKey = null; localStorage.removeItem('pinnedRaceKey'); const box = document.getElementById('pinFloat'); if (box){ box.classList.add('hidden'); box.innerHTML=''; }}

/* ===== Data load & build ===== */
function groupSmallParties(totals,seats,threshold=0.02, keep=Object.keys(PARTY_COLORS)){
  const baseKeys = Array.from(new Set([...keep, 'Other', 'JLP','PNP','JPP','UIC']));
  const total = Object.values(totals).reduce((a,b)=>a+b,0) || 1;
  const T = Object.fromEntries(baseKeys.map(k=>[k,0]));
  const S = Object.fromEntries(baseKeys.map(k=>[k,0]));
  for (const p of Object.keys(totals)){
    const share = totals[p] / total;
    const bucket = (!keep.includes(p) && p!=='Other' && share < threshold) ? 'Other' : p;
    T[bucket] = (T[bucket] || 0) + (totals[p] || 0);
    S[bucket] = (S[bucket] || 0) + (seats[p]  || 0);
  }
  if (T.Other == null) T.Other = 0;
  if (S.Other == null) S.Other = 0;
  return {totals:T, seats:S};
}

async function loadAll(){
  try{
    if (!arcFeatures.length){ try{ await loadECJBoundaries(); }catch(_){ toast('Could not load boundaries.'); } }
    initNationalMap(); initInteractiveMap();
    buildLegendInto('mapLegend'); buildLegendInto('imapLegend');

    const data = await fetchOne(DATA_URL);
    window.__rawData = data;

    if (!geoLayerNational){
      geoLayerNational = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapNational);
    }
    if (!geoLayerInteractive){
      geoLayerInteractive = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapInteractive);
    }

    const partyTotals={JLP:0, PNP:0, JPP:0, UIC:0, Other:0};
    const partySeats ={JLP:0, PNP:0, JPP:0, UIC:0, Other:0};
    const detailsByConst={}, closestArr=[];

    Object.values(data).forEach(c=>{
      const cname=c?.Name||''; const cData=Array.isArray(c?.Data)? c.Data[0] : c?.Data;
      const cand = Array.isArray(cData?.Candidates)? cData.Candidates : [];
      if(!cname || !cand.length) return;
      let key = canonKey(norm(cname));
      const alias = NAME_ALIASES[norm(cname)];
      if (alias){
        constNameToParish[key] = alias.parish || constNameToParish[key] || '';
        constNameToNo[key]     = alias.constno || constNameToNo[key] || '';
      }

      const safePct  = (x)=> Number(x)||0;
      const safeVote = (x)=> Number(x)||0;
      const winner = cand.reduce((m,x)=> safeVote(x.Votes)>safeVote(m.Votes)? x : m, cand[0]);
      const sortedByVotes = cand.slice().sort((a,b)=> safeVote(b.Votes)-safeVote(a.Votes)).map(k=>({
        name:`${(k['First Name']||'').trim()} ${(k['Last Name']||'').trim()}`.trim(),
        party:partyKey(k.Party),
        votes:safeVote(k.Votes),
        pct:safePct(k.Percentage)
      }));

      const sig = makeHash(cand);
      if (lastConstHashes[key] !== sig){
        lastConstHashes[key] = sig;
        lastConstUpdated[key] = Date.now();
        localStorage.setItem('constituencyHashes', JSON.stringify(lastConstHashes));
        localStorage.setItem('constituencyUpdated', JSON.stringify(lastConstUpdated));
      }

      detailsByConst[key] = { party:partyKey(winner?.Party), all: sortedByVotes };
      cand.forEach(k=>{ const p=partyKey(k.Party); partyTotals[p]=(partyTotals[p]||0)+safeVote(k.Votes); });
      const wParty = partyKey(winner?.Party);
      partySeats[wParty] = (partySeats[wParty] ?? 0) + 1;

      // for national "closest by %"
      const sortedByPct = sortedByVotes.slice().sort((a,b)=> b.pct-a.pct);
      const topPct = sortedByPct[0]?.pct||0, runnerPct=sortedByPct[1]?.pct||0;
      closestArr.push({
        constituency:cname,
        winnerFirst: sortedByVotes[0]?.name.split(' ')[0]||'',
        winnerLast:  (sortedByVotes[0]?.name.split(' ').slice(1).join(' '))||'',
        winnerParty: sortedByVotes[0]?.party||'Other',
        marginPct: Math.max(0,(topPct-runnerPct)),
        candidates: sortedByVotes
      });
    });

    const {totals: groupedTotals, seats: groupedSeats} = groupSmallParties(partyTotals, partySeats, 0.02);
    localStorage.setItem('lastSeats', JSON.stringify(groupedSeats));
    window.__detailsByConst = detailsByConst;

    // Topline
    buildSeatBar(detailsByConst);
    buildTopStats(groupedTotals, groupedSeats);

    // National tab
    buildScoreboard(groupedTotals, groupedSeats);
    buildCharts(groupedTotals, groupedSeats);
    buildClosestPanel(closestArr);

    // Constituencies + Maps + Right sidebars
    renderParishBlocks(detailsByConst, data);
    paintMap(geoLayerNational, detailsByConst);
    paintMap(geoLayerInteractive, detailsByConst);
    wireInteractiveBehaviors();
    updateFocusOutline();
    buildClosestSidebar(detailsByConst, data);
    renderPinned(detailsByConst, data);

    const last = document.getElementById('lastUpdated');
    if (last) last.textContent = 'Live • ' + new Date().toLocaleTimeString();

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(tickTimersAndRecent, 1000);
    tickTimersAndRecent();
  }catch(e){
    console.error(e);
    toast('Partial update — check console.');
  }
}

/* ===== Deep linking ===== */
function gotoInteractive(name){
  let k = norm(name);
  const alias = NAME_ALIASES[k];
  const resolved = alias?.key || k;
  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
  document.getElementById('tab-interactive').classList.remove('hidden');

  if (!geoLayerInteractive){ pendingFocusName = resolved; return; }
  focusConstituencyByName(resolved, true);
  setTimeout(()=> mapInteractive.invalidateSize(), 80);
  document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
}
function gotoInteractiveKey(key){
  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
  document.getElementById('tab-interactive').classList.remove('hidden');

  if (!geoLayerInteractive){ pendingFocusName = key; return; }
  focusConstituencyByName(key, true);
  setTimeout(()=> mapInteractive.invalidateSize(), 80);
  document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
}
function focusConstituencyByNumber(no){
  if (!geoLayerInteractive) return false;
  let found=null, parish=null, display=null, key=null;
  geoLayerInteractive.eachLayer(L=>{
    const p = L.feature?.properties||{};
    const n = String(p.CONST_NO || p.CONSTNO || p.Number || '');
    if (n === String(no)){
      found=L; parish=p.PARISH_NAM; display=p.CONST_NAME; key=norm(p.CONST_NAME||'');
    }
  });
  if (!found) return false;
  const grp=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
  const group = L.featureGroup(grp.length? grp:[found]);
  try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
  focusedKey = key; updateFocusOutline();
  setTimeout(()=> found.openTooltip(), 250);
  showConstituencyDetails(key, display||`#${no}`);
  return true;
}
function focusConstituencyByName(nameOrKey, isKey=false){
  if (!geoLayerInteractive) return;
  const rawK = isKey ? nameOrKey : norm(nameOrKey);
  const alias = NAME_ALIASES[rawK];
  const keyWanted = alias?.key || rawK;

  let target=null, parish=null, display=null;
  geoLayerInteractive.eachLayer(L=>{
    const nm = L.feature?.properties?.CONST_NAME || '';
    const k = norm(nm);
    if (k===keyWanted){ target=L; parish = L.feature?.properties?.PARISH_NAM; display=nm; }
  });

  if (target){
    const grp = (function(){ const arr=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) arr.push(l); }); return arr; })();
    const group = L.featureGroup(grp.length? grp:[target]);
    try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
    focusedKey = keyWanted; updateFocusOutline();
    startPulse(target);
    setTimeout(()=> target.openTooltip(), 250);
    showConstituencyDetails(keyWanted, display||nameOrKey);
  } else {
    const number = constNameToNo[keyWanted] || constNameToNo[alias?.key || ''];
    if (number && focusConstituencyByNumber(number)) return;
    setTimeout(()=> focusConstituencyByName(nameOrKey, isKey), 150);
  }
}

/* ===== Preview modal ===== */
function initPreviewMap(){
  if (previewMap) return;
  previewMap = L.map('previewMap', { zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS, maxBoundsViscosity:1 });
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  L.tileLayer(isDark
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    {minZoom:7, maxZoom:15}).addTo(previewMap);
  previewMap.fitBounds(JAMAICA_BOUNDS);
  previewMap.setMinZoom(previewMap.getZoom());
}
function closePreview(){
  const modal = document.getElementById('previewModal');
  modal.classList.remove('show');
  document.body.classList.remove('modal-open');
  if (previewLayer){
    try{ previewLayer.eachLayer(stopPulse); previewLayer.remove(); }catch(_){}
    previewLayer=null;
  }
  const shim = document.getElementById('previewShimmer');
  if (shim) shim.style.display='none';
}
function populatePreviewDetails(key){
  const tbody = document.getElementById('previewTableBody');
  const boxes = document.getElementById('previewBoxes');
  tbody.innerHTML=''; boxes.textContent='';
  const block = document.querySelector(`.bcard[data-key="${key}"]`);
  if (!block) return;
  const rows = JSON.parse(block.dataset.candidates || '[]');
  const boxStr = block.dataset.boxes || '';
  const boxPct = block.dataset.boxpct || '';
  if (boxStr) boxes.innerHTML = `Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}`;
  rows.forEach(r=>{
    const P = partyKey(r.party);
    const icon = PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other;
    const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}; font-weight:700"`;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${icon}" alt="${P}" class="party-icon" referrerpolicy="no-referrer"></td>
      <td ${nameStyle}>${r.name}</td>
      <td>${P}</td>
      <td style="text-align:right; font-variant-numeric:tabular-nums; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
      <td style="text-align:right">${r.pct||0}%</td>
    `;
    tbody.appendChild(tr);
  });
}
function openPreviewForKey(key){
  previewKey = key;
  const modal = document.getElementById('previewModal');
  modal.classList.add('show');
  document.body.classList.add('modal-open');

  initPreviewMap();
  const shim = document.getElementById('previewShimmer');
  if (shim) shim.style.display='block';

  const rec = Object.values(window.__rawData||{}).find(x => canonKey(norm(x?.Name))===key);
  const displayName = rec?.Name || key;
  const num = constNameToNo[key] || '';
  document.getElementById('previewTitle').textContent = displayName + (num ? ` (#${num})` : '');

  let hint = 'Review the area below · Use the button to open the Interactive Map';
  try{
    const block = document.querySelector(`.bcard[data-key="${key}"]`);
    const rows  = JSON.parse(block?.dataset?.candidates || '[]');
    const lead  = rows[0];
    const boxes = block?.dataset?.boxes || '';
    if (lead){
      const P = partyKey(lead.party);
      hint = `${lead.name} (${P}) leading • ${Number(lead.votes||0).toLocaleString()} votes${boxes ? ` • Boxes: ${boxes}` : ''}`;
    } else if (boxes) { hint = `Boxes: ${boxes}`; }
  }catch(_){}
  document.querySelector('.modal-hint').textContent = hint;

  populatePreviewDetails(key);

  if (previewLayer){ previewLayer.remove(); previewLayer=null; }
  previewLayer = L.geoJSON({type:'FeatureCollection', features: arcFeatures}, {
    style:(feat)=>{
      const nm = feat?.properties?.CONST_NAME || '';
      const k  = norm(nm);
      const isTarget = (k===key);
      const fill = isTarget ? (leaderColors[key] || '#60a5fa') : '#cbd5e1';
      return { color: isTarget ? '#111827' : '#94a3b8', weight: isTarget ? 3 : 1, fillColor: fill, fillOpacity: isTarget ? 0.8 : 0.5 };
    }
  }).addTo(previewMap);

  let target=null, parish=null;
  previewLayer.eachLayer(l=>{
    const nm = l.feature?.properties?.CONST_NAME || '';
    if (norm(nm)===key){ target=l; parish=l.feature?.properties?.PARISH_NAM; }
  });
  if (target){
    const grp=[]; previewLayer.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
    const bounds = (grp.length ? L.featureGroup(grp) : target).getBounds();
    try{ previewMap.fitBounds(bounds, {padding:[24,24]}); setTimeout(()=> previewMap.zoomIn(1), 120); }catch(_){}
    startPulse(target);
  }
  setTimeout(()=> { previewMap.invalidateSize(); if (shim) shim.style.display='none'; }, 120);

  previewMap.off('click');
  previewMap.on('click', ()=> { const k = previewKey; closePreview(); if (k) gotoInteractiveKey(k); });

  const goBtn = document.getElementById('btnPreviewGo');
  if (goBtn) goBtn.focus();
  if (num) location.hash = '#'+num;
}
document.getElementById('btnPreviewClose').addEventListener('click', closePreview);
document.getElementById('btnPreviewCancel').addEventListener('click', closePreview);
document.getElementById('btnPreviewGo').addEventListener('click', ()=>{ const k=previewKey; closePreview(); if (k) gotoInteractiveKey(k); });
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') closePreview();
  if (e.key === 'Enter' && document.getElementById('previewModal').classList.contains('show')){
    const k = previewKey; closePreview(); if (k) gotoInteractiveKey(k);
  }
});
document.getElementById('previewModal').addEventListener('click', (e)=>{
  if (e.target.id === 'previewModal') closePreview();
});

/* ===== Auto ===== */
function setupAutoRefresh(){
  if (refreshTimer) clearInterval(refreshTimer);
  const ms = Number(localStorage.getItem('refreshIntervalMs')||sel?.value||AUTO_DEFAULT);
  refreshTimer = setInterval(loadAll, ms);
}

/* ===== Start ===== */
(async function start(){
  initTheme();
  updateStickyOffsets();
  try{ await loadECJBoundaries(); }catch(_){}
  initNationalMap(); initInteractiveMap();
  buildLegendInto('mapLegend'); buildLegendInto('imapLegend');
  await loadAll();
  setupAutoRefresh();
  const pill = document.getElementById('pillMain');
  if (pill){ pill.title = 'Using local 2025-data.json'; const lag = document.getElementById('mainLag'); if (lag) lag.textContent = 'Local file'; }
})();
</script>
</body>
</html>
