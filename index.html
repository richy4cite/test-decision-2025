<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>Jamaica Decision 2025 — Live Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* THEME TOKENS */
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --accent:#0a58ca;
    --card:#ffffff; --card-alt:#f8fafc; --shadow:0 6px 18px rgba(17,24,39,.06);
    --jlp:#2e8b57; --pnp:#ff8c00; --jpp:#6a0dad; --uic:#008b8b; --other:#1e90ff;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --hdrh:56px; --tabh:48px;
  }
  html[data-theme="dark"]{
    --bg:#0f172a;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --border:#334155;
    --accent:#60a5fa;
    --card:#111827;
    --card-alt:#0b1220;
    --shadow:0 6px 18px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  body.modal-open{overflow:hidden}

  /* Header (raise z-index so maps stay underneath) */
  .header{position:sticky; top:0; z-index:1500; background:var(--card); border-bottom:1px solid var(--border)}
  .header-inner{max-width:1800px; margin:0 auto; padding:14px 24px; display:flex; align-items:center; gap:18px; flex-wrap:wrap}
  .brand{font-weight:800; font-size:1.25rem; letter-spacing:.2px}
  .live-pill{margin-left:auto; display:flex; align-items:center; gap:8px; font-weight:700}
  .live-dot{width:10px; height:10px; border-radius:50%; background:#ef4444; animation:pulse 1.8s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}70%{box-shadow:0 0 0 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
  .refresh{display:flex; align-items:center; gap:6px}
  select, .mode-btn{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:var(--card); color:var(--text); cursor:pointer; font-weight:700}
  .mode-btn{display:flex; align-items:center; gap:6px}

  /* Source status pills */
  .status-group{display:flex; align-items:center; gap:12px; margin-left:8px}
  .status-pill{
    display:flex; align-items:center; gap:8px;
    background:var(--card); border:1px solid var(--border); border-radius:999px;
    padding:6px 10px; font-weight:800; color:var(--text);
  }
  .status-pill small{color:var(--muted); font-weight:600}
  .dot{width:10px; height:10px; border-radius:50%; animation:pulse 1.8s infinite; background:#10b981}
  .dot.ok{ background:#10b981 } .dot.warn{ background:#f59e0b } .dot.bad{ background:#ef4444 }

  /* Tabs — sticky (below header), with higher z-index than maps */
  .tabs{position:sticky; top:var(--hdrh); z-index:1400; background:var(--card); border-bottom:1px solid var(--border)}
  .tabs-inner{max-width:1800px; margin:0 auto; padding:0 24px; display:flex; gap:24px}
  .tab{padding:14px 2px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:800}
  .tab.active{border-color:var(--accent); color:var(--text)}

  /* Topline */
  .topline{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border-bottom:1px solid var(--border)}
  .topline-inner{max-width:1800px; margin:0 auto; padding:12px 24px; display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .tcard{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:flex; gap:12px; align-items:center}
  .tlogo{height:22px; width:auto; filter:brightness(1)}
  html[data-theme="dark"] .tlogo{filter:brightness(1.2) contrast(1.1)}
  .tstats{font-size:.98rem; color:var(--muted)} .tstats b{color:var(--text)}
  .delta{font-weight:800; margin-left:6px} .delta.up{color:#16a34a} .delta.down{color:#ef4444}

  /* Page grid (Main + Right rail container) */
  .page{
    display:grid;
    grid-template-columns:1fr minmax(0,1600px) 360px 1fr; /* right rail 360px, auto centers */
    gap:16px;
  }
  .page > .main{grid-column:2}
  .page > .right-rail{grid-column:3}

  @media (max-width:1300px){
    .page{display:block}
    .right-rail{position:relative; width:auto; max-width:none}
  }

  /* Right rail (holds two stacked sidebars) */
  .right-rail{
    position:sticky;
    top:calc(var(--hdrh) + var(--tabh) + 12px);
    align-self:start;
    height:calc(100vh - (var(--hdrh) + var(--tabh) + 28px));
    display:flex;
    flex-direction:column;
    gap:12px;
    z-index:1;
  }

  .rb-section{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    display:flex;
    flex-direction:column;
    min-height:0;    /* allow child scroll */
    flex:1;          /* split vertical space 50/50 */
  }
  .rb-header{
    padding:10px 12px;
    border-bottom:1px solid var(--border);
    font-weight:900;
    font-size:1rem;
  }
  .rb-body{
    padding:8px 10px;
    overflow:auto;   /* only shows scrollbars if needed */
  }

  /* Recently-updated items */
  .sideitem{
    position:relative; display:flex; justify-content:space-between; align-items:center;
    border:2px solid var(--border); border-radius:12px; padding:6px 8px; margin:8px 0;
    font-weight:800; cursor:pointer; background:var(--card);
    transition:transform .08s ease, background .12s ease, border-color .12s ease;
  }
  .sideitem:hover{ transform:translateY(-1px); background:color-mix(in oklab, var(--card) 92%, var(--bg)); }
  .sideitem small{color:var(--muted); font-weight:700; font-size:.88em; font-variant-numeric:tabular-nums}
  .age-good{border-color:var(--good)} .age-warn{border-color:var(--warn)} .age-bad{border-color:var(--bad)}

  /* Closest races list (top-2 per seat) */
  .closeitem{
    border:1px solid var(--border); border-radius:12px; padding:10px; margin:10px 0;
    background:var(--card); cursor:pointer; transition:background .12s ease, transform .08s ease;
  }
  .closeitem:hover{ background:color-mix(in oklab, var(--card) 92%, var(--bg)); transform:translateY(-1px); }
  .closeitem-header{display:flex; justify-content:space-between; gap:8px; align-items:center; margin-bottom:8px}
  .closeitem-title{font-weight:900; font-size:.98rem}
  .closeitem-meta{color:var(--muted); font-weight:700; font-variant-numeric:tabular-nums}
  .cand-row{display:grid; grid-template-columns:28px 1fr 64px 80px; gap:8px; align-items:center; padding:6px; border-radius:10px; background:var(--card-alt)}
  .cand-name{font-weight:800}
  .cand-party{text-align:center; font-weight:800}
  .cand-votes{text-align:right; font-weight:900}
  .cand-pct{text-align:right; color:var(--muted)}
  .party-icon{height:18px; width:auto; display:block}

  .pin-row{display:flex; justify-content:flex-end; gap:8px; margin-top:8px}
  .pin-btn, .goto-btn{
    background:var(--card); border:1px solid var(--border); border-radius:10px; padding:6px 10px;
    cursor:pointer; font-weight:800; color:var(--text);
  }
  .pin-btn:hover, .goto-btn:hover{ filter:brightness(.98) }

  /* Sections / cards */
  .container{max-width:1600px; margin:14px auto; padding:0 24px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}

  /* Controls */
  .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
  .controls input, .controls select{border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:var(--card); color:var(--text)}
  .controls input#searchBar{width:360px; max-width:90vw}
  .controls input#cnoFilter{width:120px}

  /* Parish -> constituency blocks */
  .parish{margin:12px 0 22px}
  .parish h2{font-size:1.1rem; border-left:4px solid var(--accent); padding-left:10px; margin:0 0 12px}
  .const-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
  .const{background:var(--card); border:2px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer}
  .const-head{background:linear-gradient(180deg, color-mix(in oklab, var(--card) 90%, var(--bg)), color-mix(in oklab, var(--card) 75%, var(--bg))); border-bottom:1px solid var(--border);
    padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px}
  .const-name{font-weight:900; font-size:1rem; line-height:1.2; background:var(--bg); padding:3px 8px; border:1px solid var(--border); border-radius:8px}
  .updated{font-size:.85rem; color:var(--muted); display:flex; flex-direction:column; align-items:flex-end; text-align:right; gap:4px; white-space:nowrap}
  .pulse{display:inline-block; width:10px; height:10px; border-radius:50%; background:currentColor; animation:pulseSoft 1.8s infinite}
  @keyframes pulseSoft{0%{box-shadow:0 0 0 0 rgba(0,0,0,.2)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
  .const-body{padding:12px; display:flex; flex-direction:column; gap:8px}
  .winner-badge{display:inline-flex; align-items:center; gap:6px; font-weight:800; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08)}
  html[data-theme="dark"] .winner-badge{border-color:#00000040}
  .winner-badge .check{font-weight:900}
  .boxline{font-size:.9rem; color:var(--muted); margin-top:2px}

  /* Rows (5 columns) */
  .rows{margin-top:6px; border-top:1px solid var(--border)}
  .row{
    display:grid;
    grid-template-columns:35px 1fr 40px 70px 52px;
    gap:12px; padding:10px 4px;
    align-items:start;
    border-bottom:1px solid var(--border);
    min-height:44px;
    background:var(--card-alt);
    transition:background .12s ease;
  }
  .row:hover{ background:color-mix(in oklab, var(--card) 92%, var(--bg)); }
  .nm{font-weight:700; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.15}
  .party{ text-align:center; font-weight:800; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:.3px; }
  .votes{font-weight:800; text-align:right}
  .pct{color:var(--muted); text-align:right}

  /* Scoreboard + charts */
  .scoreboard{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(330px,1fr))}
  .pcard{border:1px solid var(--border); border-radius:10px; padding:14px; background:var(--card)}
  .phead{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .pbrand{display:flex; align-items:center; gap:10px; font-weight:800}
  .plogo{height:22px; width:auto; filter:none}
  html[data-theme="dark"] .plogo{filter:brightness(1.2) contrast(1.1)}
  .pmain{font-size:1.6rem; font-weight:800}
  .bar{height:8px; border-radius:999px; background:var(--border); overflow:hidden; margin-top:8px}
  .bar>span{display:block; height:100%}

  .charts{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
  .chart-wrap{position:relative; height:300px}
  canvas{position:absolute; inset:0}

  /* Maps */
  .map-wrap{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card-alt); z-index:1}
  #mapContainer{height:460px}
  #imapMap{height:60vh; min-height:380px; max-height:72vh}
  .mapControls{position:absolute; right:8px; top:8px; z-index:500}
  .btn{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; color:var(--text)}
  .btn:hover{filter:brightness(0.98)}
  .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
  .legend-item{display:inline-flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); padding:6px 10px; border-radius:999px; color:var(--text)}
  .swatch{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15)}
  .leaflet-tooltip{background:#111827; color:#f9fafb; border:0; border-radius:8px; padding:8px 10px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .leaflet-container{background:var(--card-alt)}
  .leaflet-control-attribution{display:none}

  /* Bottom ticker — ensure above maps too */
  .ticker{position:sticky; bottom:0; z-index:1600; background:#0b1220; color:#fff; border-top:1px solid #0f172a}
  html[data-theme="dark"] .ticker{background:#0b1220}
  .ticker-inner{max-width:1600px; margin:0 auto; padding:10px 24px; display:flex; align-items:center; gap:12px; overflow:hidden}
  .tick-title{font-weight:800; margin-right:8px}
  .marquee{white-space:nowrap; overflow:hidden; flex:1}
  .marquee span{display:inline-block; padding-left:100%; animation:scroll 180s linear infinite}
  @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  .hidden{display:none !important}
  .toast{position:fixed; right:12px; bottom:72px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); z-index:2000; font-weight:700}

  /* ================== PREVIEW MODAL ================== */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(2px)}
  .modal.show{display:flex}
  .modal-content{
    width:min(1100px, 66vw);
    max-height:86vh;
    background:var(--card);
    color:var(--text);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 30px 80px rgba(0,0,0,.35);
    display:grid;
    grid-template-rows:auto auto 1fr auto;
    overflow:hidden;
  }
  .modal-header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border)}
  .modal-title{font-weight:900; font-size:1.05rem}
  .modal-hint{padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--border)}
  .modal-body{display:grid; grid-template-columns:1.2fr .8fr; gap:0; min-height:380px}
  #previewMap{min-height:380px; position:relative}
  .modal-details{border-left:1px solid var(--border); padding:10px 12px; overflow:auto}
  .modal-actions{padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end}
  .btn-secondary{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border:1px solid var(--border)}
  .btn-primary{background:var(--accent); border:1px solid color-mix(in oklab, var(--accent) 70%, black); color:white}
  .close-x{border-radius:10px; padding:6px 10px; background:var(--card); border:1px solid var(--border); cursor:pointer}

  /* Preview loading shimmer */
  .shimmer{
    position:absolute; inset:0; pointer-events:none;
    background:linear-gradient(100deg, rgba(0,0,0,0) 0%, rgba(148,163,184,.22) 40%, rgba(0,0,0,0) 80%);
    background-size:200% 100%;
    animation:shimmer 1.2s linear infinite;
    z-index:5;
  }
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Ensure Leaflet panes don’t exceed sticky UI */
  .leaflet-pane{z-index:400} /* header/tabs/ticker are 1400+ */

  /* ===== Pinned floating card ===== */
  .pin-float{
    position:fixed; right:16px; bottom:92px;
    width:min(420px, 86vw);
    background:var(--card); color:var(--text);
    border:2px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
    padding:10px; z-index:1700; display:none;
  }
  .pin-float.show{display:block}
  .pin-float .pf-head{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px}
  .pin-float .pf-title{font-weight:900}
  .pin-float .pf-actions{display:flex; gap:8px}
  .pin-float .pf-btn{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800}
  .pin-float .pf-btn:hover{filter:brightness(.98)}
</style>
</head>
<body>
  <div class="page">
    <!-- MAIN CONTENT -->
    <div class="main">
      <!-- Header -->
      <header class="header" id="siteHeader">
        <div class="header-inner">
          <div class="brand">Jamaica Decision 2025 — Live Results</div>

          <button id="modeBtn" class="mode-btn" title="Toggle light/dark">🌞 Light</button>

          <div class="refresh">
            <span style="color:var(--muted)">Auto-refresh:</span>
            <select id="refreshSel">
              <option value="15000">15s</option>
              <option value="30000">30s</option>
              <option value="60000" selected>1m</option>
              <option value="120000">2m</option>
              <option value="300000">5m</option>
            </select>
            <button id="btnForceRefresh" class="btn">Refresh now</button>
          </div>

          <!-- Parity pills -->
          <div class="status-group" id="sourceStatus">
            <div class="status-pill" id="pillMain" title="Waiting for first check…">
              <span class="dot ok" aria-hidden="true"></span> Main <small id="mainLag">OK</small>
            </div>
            <div class="status-pill" id="pillBackup" title="Waiting for first check…">
              <span class="dot ok" aria-hidden="true"></span> Backup <small id="backupLag">OK</small>
            </div>
          </div>

          <div class="live-pill"><span class="live-dot"></span><span id="lastUpdated">Updating…</span></div>
        </div>
      </header>

      <!-- Tabs -->
      <nav class="tabs" id="siteTabs">
        <div class="tabs-inner">
          <div class="tab active" data-tab="constituencies">Constituencies</div>
          <div class="tab" data-tab="interactive">Interactive Map</div>
          <div class="tab" data-tab="national">National</div>
        </div>
      </nav>

      <!-- Topline -->
      <section class="topline">
        <div class="topline-inner" id="toplineBar"></div>
      </section>

      <!-- NATIONAL TAB -->
      <section id="tab-national" class="hidden">
        <div class="container">
          <div class="scoreboard" id="scoreboard"></div>

          <div class="charts">
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Total Votes by Party</h2>
              <div class="chart-wrap"><canvas id="voteChart"></canvas></div>
            </div>
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Seats Won by Party</h2>
              <div class="chart-wrap"><canvas id="seatChart"></canvas></div>
            </div>
          </div>

          <div class="card">
            <h2>Top 10 Closest Seats</h2>
            <ul id="closestList" class="closelist"></ul>
            <p id="closestNote" style="color:var(--muted); margin-top:8px"></p>
          </div>

          <div class="card">
            <h2>Seats Won Map</h2>
            <div class="map-wrap">
              <div id="mapContainer"></div>
              <div class="mapControls"><button id="btnResetNational" class="btn">Reset view</button></div>
            </div>
            <div id="mapLegend" class="legend"></div>
          </div>
        </div>
      </section>
      <!-- CONSTITUENCIES TAB -->
      <section id="tab-constituencies">
        <div class="container">
          <div class="card">
            <div class="controls">
              <input id="searchBar" type="text" placeholder="Search candidate, constituency, #…">
              <select id="parishFilter"><option value="">All Parishes</option></select>
              <select id="partyFilter">
                <option value="">All Parties</option>
                <option>JLP</option><option>PNP</option><option>JPP</option><option>UIC</option><option>Other</option>
              </select>
              <input id="cnoFilter" type="text" inputmode="numeric" placeholder="Const. #">
              <div class="split">
                <label for="sortField" style="color:var(--muted); font-weight:700">Sort by</label>
                <select id="sortField">
                  <option value="cno">Const #</option>
                  <option value="name">Const name</option>
                  <option value="parish">Parish</option>
                  <option value="party">Leading party</option>
                </select>
                <select id="sortDir">
                  <option value="asc">Asc</option>
                  <option value="desc">Desc</option>
                </select>
              </div>
            </div>
            <h2>Constituencies by Parish</h2>
            <div id="parishContainer"></div>
          </div>
        </div>
      </section>

      <!-- INTERACTIVE MAP TAB -->
      <section id="tab-interactive" class="hidden">
        <div class="container">
          <div class="card">
            <h2>Interactive Map</h2>
            <div class="map-wrap">
              <div id="imapMap"></div>
              <div class="mapControls"><button id="btnResetInteractive" class="btn">Reset view</button></div>
            </div>
            <div id="imapLegend" class="legend" style="margin-top:8px"></div>
            <div id="imapDetails" class="card" style="margin-top:12px">
              <h2 style="margin-top:0">Constituency Details</h2>
              <div id="imapContent" class="small">Click a constituency to see results here.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT SIDEBARS -->
    <aside class="rightbar" aria-label="Sidebars">
      <h3>Recently Updated (#)</h3>
      <div id="sidebarList"></div>

      <h3 style="margin-top:18px">Closest Races</h3>
      <div id="sidebarClosest"></div>
    </aside>
  </div>

  <!-- Bottom ticker -->
  <div class="ticker">
    <div class="ticker-inner">
      <span class="tick-title">Live Updates:</span>
      <div class="marquee"><span id="tickerText">—</span></div>
    </div>
  </div>
  <!-- ================== PREVIEW MODAL ================== -->
  <div class="modal" id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="previewTitle">Constituency</div>
        <button class="close-x" id="btnPreviewClose" aria-label="Close preview">✕</button>
      </div>
      <div class="modal-hint" aria-live="polite">Loading…</div>
      <div class="modal-body">
        <div id="previewMap">
          <div class="shimmer" id="previewShimmer"></div>
        </div>
        <div class="modal-details">
          <div id="previewBoxes" class="boxline" style="margin-top:2px"></div>
          <table style="width:100%; border-collapse:collapse; margin-top:8px">
            <thead>
              <tr><th style="width:28px"></th><th style="text-align:left">Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr>
            </thead>
            <tbody id="previewTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPreviewCancel">Close</button>
        <button class="btn btn-primary" id="btnPreviewGo">Open in Interactive Map</button>
      </div>
    </div>
  </div>

  <!-- ================== SCRIPTS START ================== -->
  <script>
  /* ===== Config ===== */
  const AUTO_DEFAULT = 60000;
  const ECJ_GEOJSON =
   'https://services6.arcgis.com/3R3y1KXaPJ9BFnsU/arcgis/rest/services/ECJWEB_MAP/FeatureServer/6/query?where=1%3D1&outFields=*&f=geojson';
  const JAMAICA_BOUNDS = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);
  const PARTY_COLORS = { JLP:'#2e8b57', PNP:'#ff8c00', JPP:'#6a0dad', UIC:'#008b8b', Other:'#1e90ff' };
  const PARTY_LOGOS = {
    JLP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JLP_logo-300x98.png",
    PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_logo-300x182.png",
    JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_logo-300x275.png",
    UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_logo-300x164.png",
    Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
  };
  const PARTY_SYMBOLS = {
    JLP:"https://ecj.com.jm/wp-content/uploads/2025/03/JLP_symbol.png",
    PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_symbol.png",
    JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_symbol-300x261.png",
    UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_symbol-300x106.png",
    Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
  };
  const CORE_PARTIES = ["JLP","PNP","JPP","UIC"];
  const TICKER_MAX_AGE = 15*60*1000;
  const SIDEBAR_MAX_AGE = 25*60*1000;

  /* Data source URLs (proxy-aware with fallbacks) */
  const PROXY_BASE = 'https://decision2025.odaneforsythe.workers.dev/';
  const DIRECT_MAIN    = 'https://jamaica-elections.com/general/2025/show/jsonapi.php';
  const DIRECT_BACKUP  = 'https://onedrex.net:9443/election/api/view/constituency-details/v2/carlito2025';
  const PROXY_MAIN     = PROXY_BASE + '?url=' + encodeURIComponent(DIRECT_MAIN);
  const PROXY_BACKUP   = PROXY_BASE + '?url=' + encodeURIComponent(DIRECT_BACKUP);
  const isGithubPages  = /github\.io$/i.test(location.hostname);
  const MAIN_URLS      = isGithubPages ? [PROXY_MAIN, DIRECT_MAIN] : [DIRECT_MAIN, PROXY_MAIN];
  const BACKUP_URLS    = isGithubPages ? [PROXY_BACKUP, DIRECT_BACKUP] : [DIRECT_BACKUP, PROXY_BACKUP];
  let DATA_URL         = MAIN_URLS[0];
  const PARITY_INTERVAL_MS = 5 * 60 * 1000;

  /* ===== Normalizer + Name Aliases ===== */
  function norm(s){ return String(s||'').toLowerCase().replace(/[\s\-\u2013\u2014'’.]/g,'').replace(/&/g,'and'); }
  const NAME_ALIASES = {
    [norm('Kingston East and Port Royal')]: { key: norm('Kingston Eastern and Port Royal'), parish: 'KINGSTON', constno: '3' }
  };
  function canonKey(k){ return NAME_ALIASES[k]?.key || k; }
  /* ===== State ===== */
  let voteChart=null, seatChart=null, refreshTimer=null, timerInterval=null;
  let mapNational=null, mapInteractive=null, geoLayerNational=null, geoLayerInteractive=null;
  let baseLightNat=null, baseDarkNat=null, baseLightInt=null, baseDarkInt=null, currentBase='light';
  let arcFeatures=[], byParish={}, constNameToNo={}, constNameToParish={};
  let leaderColors = {}; let focusedKey = null; let pendingFocusName = null;
  let lastSeats = JSON.parse(localStorage.getItem('lastSeats') || '{}');
  let lastConstHashes = JSON.parse(localStorage.getItem('constituencyHashes')||'{}');
  let lastConstUpdated = JSON.parse(localStorage.getItem('constituencyUpdated')||'{}');

  /* Sidebars / pin state */
  const PIN_KEY = 'pinnedRaces';
  let pinnedRaces = JSON.parse(localStorage.getItem(PIN_KEY) || '[]'); // stores canonical keys

  /* ===== Utils ===== */
  function toast(msg){
    const t=document.createElement('div');
    t.className='toast';
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),4000);
  }
  function contrastText(hex){
    try{
      const c=hex.replace('#','');
      const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
      return ((r*299+g*587+b*114)/1000>=140)?'#0b1220':'#ffffff';
    }catch{ return '#0b1220'; }
  }
  function fmtHHMMSS(ms){
    const s=Math.max(0,Math.floor(ms/1000));
    const hh=String(Math.floor(s/3600)).padStart(2,'0');
    const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }
  function makeHash(cands){
    return cands.map(k=>`${(k.Party||'Other').toUpperCase()}|${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}|${Number(k.Votes||0)}`).join(';');
  }
  const partyKey = p => {
    const P = String(p||'Other').toUpperCase();
    if (P.startsWith('INDA') || P.startsWith('INDB')) return 'Other';
    return ['JLP','PNP','JPP','UIC'].includes(P) ? P : 'Other';
  };
  const bust = url => url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now();

  /* ===== Theme toggle ===== */
  function applyTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    const btn = document.getElementById('modeBtn');
    if (btn) btn.textContent = theme==='dark' ? '🌙 Dark' : '🌞 Light';

    // Swap basemaps on National
    if (mapNational && baseLightNat && baseDarkNat){
      if (theme==='dark' && currentBase!=='dark'){ mapNational.removeLayer(baseLightNat); baseDarkNat.addTo(mapNational); currentBase='dark'; }
      if (theme==='light' && currentBase!=='light'){ mapNational.removeLayer(baseDarkNat); baseLightNat.addTo(mapNational); currentBase='light'; }
      setTimeout(()=>mapNational.invalidateSize(), 60);
    }
    // Swap basemaps on Interactive
    if (mapInteractive && baseLightInt && baseDarkInt){
      if (theme==='dark'){ mapInteractive.removeLayer(baseLightInt); baseDarkInt.addTo(mapInteractive); }
      else { mapInteractive.removeLayer(baseDarkInt); baseLightInt.addTo(mapInteractive); }
      setTimeout(()=>mapInteractive.invalidateSize(), 60);
    }
  }
  function initTheme(){
    const saved = localStorage.getItem('theme') || 'light';
    applyTheme(saved);
    const btn = document.getElementById('modeBtn');
    if (btn){
      btn.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
        const next = cur==='dark' ? 'light' : 'dark';
        localStorage.setItem('theme', next);
        applyTheme(next);
      });
    }
  }

  /* ===== Tabs ===== */
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-'+t.dataset.tab).classList.remove('hidden');
    if (t.dataset.tab==='national' && mapNational) setTimeout(()=>mapNational.invalidateSize(), 60);
    if (t.dataset.tab==='interactive' && mapInteractive) {
      setTimeout(()=>mapInteractive.invalidateSize(), 60);
      if (pendingFocusName){ focusConstituencyByName(pendingFocusName, true); pendingFocusName=null; }
      else {
        const cur = document.getElementById('imapContent')?.dataset?.currentKey;
        if (cur) focusConstituencyByName(cur, true);
      }
    }
  }));

  /* ===== Sticky offsets ===== */
  function updateStickyOffsets(){
    const hdr = document.getElementById('siteHeader');
    const tabs = document.getElementById('siteTabs');
    if (hdr){ document.documentElement.style.setProperty('--hdrh', hdr.offsetHeight+'px'); }
    if (tabs){ document.documentElement.style.setProperty('--tabh', tabs.offsetHeight+'px'); }
  }
  window.addEventListener('resize', updateStickyOffsets);

  /* ===== Auto refresh controls (listeners wired later in start()) ===== */
  const refreshSelEl = document.getElementById('refreshSel');
  if (refreshSelEl){
    refreshSelEl.value = localStorage.getItem('refreshIntervalMs') || String(AUTO_DEFAULT);
    refreshSelEl.addEventListener('change', ()=>{
      localStorage.setItem('refreshIntervalMs', refreshSelEl.value);
      setupAutoRefresh();
    });
  }
  const forceBtn = document.getElementById('btnForceRefresh');
  if (forceBtn){
    forceBtn.addEventListener('click', ()=>{ loadECJAndData(); });
  }
  /* ===== Maps ===== */
  // Ensure a single shared bounds object
  const JAMAICA_BOUNDS_LEAF = window.JAMAICA_BOUNDS_LEAF || (window.JAMAICA_BOUNDS_LEAF =
    L.latLngBounds([17.6, -78.6], [18.6, -76.0])
  );

  function initNationalMap(){
    if (mapNational) return;
    mapNational = L.map('mapContainer', {
      zoomControl:true, attributionControl:false,
      maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1
    });
    baseLightNat = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    baseDarkNat  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkNat : baseLightNat).addTo(mapNational);
    mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
    mapNational.setMinZoom(mapNational.getZoom());

    const btn = document.getElementById('btnResetNational');
    if (btn){
      btn.onclick = ()=>{
        mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
        mapNational.setMinZoom(mapNational.getZoom());
        setTimeout(()=> mapNational.invalidateSize(), 40);
      };
    }
  }

  function initInteractiveMap(){
    if (mapInteractive) return;
    mapInteractive = L.map('imapMap', {
      zoomControl:true, attributionControl:false,
      maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1
    });
    baseLightInt = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    baseDarkInt  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
    (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkInt : baseLightInt).addTo(mapInteractive);
    mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
    mapInteractive.setMinZoom(mapInteractive.getZoom());

    const btn = document.getElementById('btnResetInteractive');
    if (btn){
      btn.onclick = ()=>{
        mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
        mapInteractive.setMinZoom(mapInteractive.getZoom());
        focusedKey = null; pendingFocusName = null;
        const cont = document.getElementById('imapContent');
        if (cont){ cont.textContent = 'Click a constituency to see results here.'; cont.dataset.currentKey=''; }
        if (geoLayerInteractive){
          geoLayerInteractive.eachLayer(l=>{
            try{ l.closeTooltip(); }catch(_){}
            const nm = l.feature?.properties?.CONST_NAME || '';
            const key = norm(nm);
            const fill = leaderColors[key] || '#e5e7eb';
            l.setStyle({ fillColor:fill, fillOpacity:0.75, color:'#94a3b8', weight:1 });
            stopPulse(l);
          });
        }
        setTimeout(()=> mapInteractive.invalidateSize(), 40);
      };
    }
    window.addEventListener('resize', ()=> setTimeout(()=> mapInteractive.invalidateSize(), 40));
  }

  function buildLegendInto(containerId){
    const host=document.getElementById(containerId); if(!host) return;
    host.innerHTML='';
    ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
      const el=document.createElement('span'); el.className='legend-item';
      el.innerHTML=`<span class="swatch" style="background:${PARTY_COLORS[p]}"></span>${p}`;
      host.appendChild(el);
    });
  }

  /* ===== Boundaries ===== */
  async function loadECJBoundaries(){
    try{
      const r = await fetch(ECJ_GEOJSON, {cache:'no-store'});
      if (!r.ok) throw new Error('Boundaries HTTP '+r.status);
      const gj = await r.json();
      arcFeatures = gj.features || [];
      byParish = {}; constNameToNo={}; constNameToParish={};
      arcFeatures.forEach(f=>{
        const p=f.properties||{};
        const parish = p.PARISH_NAM || p.PARISH_NAME || '';
        const cname  = p.CONST_NAME || p.CONSTNAME || p.Name || '';
        const cno    = p.CONST_NO || p.CONSTNO || p.Number || '';
        const key=norm(cname);
        if (parish) (byParish[parish] ||= []);
        constNameToNo[key]=(cno||'').toString();
        constNameToParish[key]=parish||'';
      });
      // apply manual aliases / fixes
      Object.values(NAME_ALIASES).forEach(a=>{
        if (a.key){
          constNameToParish[a.key] = a.parish || constNameToParish[a.key] || '';
          constNameToNo[a.key]     = a.constno || constNameToNo[a.key] || '';
        }
      });
    }catch(e){
      console.error(e);
      toast('Could not load boundaries.');
    }
  }

  /* ===== Pulsing helpers ===== */
  function startPulse(layer){
    if (!layer || layer._pulseTimer) return;
    let up=true;
    layer._pulseTimer = setInterval(()=>{
      const next = up ? 0.95 : 0.6; up=!up;
      layer.setStyle({ fillOpacity: next });
    }, 800);
  }
  function stopPulse(layer){
    if (layer && layer._pulseTimer){
      clearInterval(layer._pulseTimer);
      layer._pulseTimer = null;
      layer.setStyle({ fillOpacity:0.75 });
    }
  }
  /* ===== Topline / score / charts / closest ===== */
  function buildToplineBar(totals,seats){
    const el=document.getElementById('toplineBar'); el.innerHTML='';
    const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
    const deltas={};
    ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
      const prev=lastSeats?.[p]||0; const cur=seats[p]||0; deltas[p]=cur-prev;
    });
    localStorage.setItem('lastSeats', JSON.stringify(seats)); lastSeats=seats;
    ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
      const votes=totals[p]||0, s=seats[p]||0;
      const pct=((votes/(totalVotes||1))*100).toFixed(1);
      const d=deltas[p]||0;
      const deltaHtml = d?`<span class="delta ${d>0?'up':'down'}">${d>0?'▲':'▼'} ${Math.abs(d)}</span>`:'';
      const card=document.createElement('div'); card.className='tcard';
      card.innerHTML = `<img class="tlogo" src="${PARTY_LOGOS[p]}" alt="${p} logo" referrerpolicy="no-referrer">
        <div class="tstats"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; <b>${votes.toLocaleString()}</b> votes &nbsp;|&nbsp; <b>${pct}%</b></div>`;
      el.appendChild(card);
    });
  }

  function buildScoreboard(totals,seats){
    const el=document.getElementById('scoreboard'); if(!el) return; el.innerHTML='';
    const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
    const prev = JSON.parse(localStorage.getItem('lastSeats')||'{}');
    [
      {key:'JLP', name:'Jamaica Labour Party', color:PARTY_COLORS.JLP, logo:PARTY_LOGOS.JLP},
      {key:'PNP', name:'People’s National Party', color:PARTY_COLORS.PNP, logo:PARTY_LOGOS.PNP},
      {key:'Other', name:'Others (JPP, UIC, etc.)', color:PARTY_COLORS.Other, logo:PARTY_LOGOS.Other}
    ].forEach(g=>{
      const votes=totals[g.key]||0, s=seats[g.key]||0, pct=((votes/(totalVotes||1))*100).toFixed(1);
      const delta=s-(prev?.[g.key]||0);
      const deltaHtml = delta?`<span class="delta ${delta>0?'up':'down'}">${delta>0?'▲':'▼'} ${Math.abs(delta)}</span>`:'';
      const div=document.createElement('div'); div.className='pcard';
      div.innerHTML = `
        <div class="phead">
          <div class="pbrand" style="color:${g.color}">
            <img class="plogo" src="${g.logo}" alt="${g.key} logo" referrerpolicy="no-referrer">
            <strong>${g.name}</strong>
          </div>
          <div class="pmain" style="color:${g.color}">${pct}%</div>
        </div>
        <div class="bar"><span style="width:${pct}%; background:${g.color}"></span></div>
        <div style="margin-top:8px; color:var(--muted)"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; Votes: ${votes.toLocaleString()}</div>`;
      el.appendChild(div);
    });
  }

  function buildCharts(totals,seats){
    const vc=document.getElementById('voteChart'), sc=document.getElementById('seatChart');
    try{ voteChart && voteChart.destroy(); }catch(_){}
    try{ seatChart && seatChart.destroy(); }catch(_){}
    const labels=Object.keys(totals); if(!labels.length) return;
    const colors=labels.map(p=>PARTY_COLORS[p]||PARTY_COLORS.Other);
    voteChart=new Chart(vc,{type:'pie',
      data:{labels,datasets:[{data:labels.map(k=>totals[k]||0),backgroundColor:colors}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
    seatChart=new Chart(sc,{type:'bar',
      data:{labels,datasets:[{label:'Seats',data:labels.map(k=>seats[k]||0),backgroundColor:colors}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,precision:0,grid:{color:'rgba(148,163,184,.3)'}}}}});
  }

  function buildClosestPanel(items){
    const list=document.getElementById('closestList'), note=document.getElementById('closestNote'); if(!list) return;
    list.innerHTML='';
    const top10 = items.filter(x=>!isNaN(x.marginVotes) && x.marginVotes<=200).sort((a,b)=>a.marginVotes-b.marginVotes).slice(0,10);
    top10.forEach(item=>{
      const color=PARTY_COLORS[partyKey(item.winnerParty)]||PARTY_COLORS.Other;
      const li=document.createElement('li');
      li.innerHTML = `
        <span><strong>#${item.constno} ${item.constituency}</strong> —
          <span style="color:${color}">${item.winnerFirst} ${item.winnerLast} (${partyKey(item.winnerParty)})</span>
        </span>
        <span><strong>${item.marginVotes} votes</strong></span>`;
      li.title = item.candidates.map(c=>`${c.name} (${partyKey(c.party)}): ${c.votes.toLocaleString()} • ${c.pct}%`).join(' | ');
      li.addEventListener('mouseover', ()=> highlightConstituency(item.constno));
      li.addEventListener('mouseout', ()=> unhighlightConstituency(item.constno));
      li.addEventListener('click', ()=> pinRace(item));
      list.appendChild(li);
    });
    note.textContent='Close races = margin ≤ 200 votes.';
  }
  /* ===== Hover highlight + Pin Race ===== */
  function getPartyIcon(P){ return PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other; }
  function getPartyColor(P){ return PARTY_COLORS[P] || PARTY_COLORS.Other; }

  function highlightConstituency(constNo){
    if (!geoLayerInteractive) return;
    geoLayerInteractive.eachLayer(l=>{
      const p = l.feature?.properties || {};
      const n = String(p.CONST_NO || p.CONSTNO || p.Number || '');
      if (n === String(constNo)){
        try{ l.bringToFront(); }catch(_){}
        l.setStyle({ weight:3, color:'#111827', fillOpacity:0.9 });
        try{ l.openTooltip(); }catch(_){}
      }
    });
  }
  function unhighlightConstituency(constNo){
    if (!geoLayerInteractive) return;
    geoLayerInteractive.eachLayer(l=>{
      const p = l.feature?.properties || {};
      const n = String(p.CONST_NO || p.CONSTNO || p.Number || '');
      if (n === String(constNo)){
        const k = norm(p.CONST_NAME || '');
        const fill = leaderColors[k] || '#e5e7eb';
        const isFocused = (focusedKey && focusedKey===k);
        l.setStyle({ fillColor:fill, fillOpacity:0.75, color:isFocused?'#111827':'#94a3b8', weight:isFocused?3:1 });
        try{ l.closeTooltip(); }catch(_){}
      }
    });
  }

  /* Floating pinned card */
  function ensurePinnedHost(){
    let host = document.getElementById('pinnedRace');
    if (host) return host;
    host = document.createElement('div');
    host.id = 'pinnedRace';
    host.style.position='fixed';
    host.style.right='14px';
    host.style.bottom='90px';
    host.style.zIndex='1700';
    host.style.maxWidth='360px';
    host.style.background='var(--card)';
    host.style.border='1px solid var(--border)';
    host.style.borderRadius='12px';
    host.style.boxShadow='var(--shadow)';
    host.style.overflow='hidden';
    host.style.display='none';
    document.body.appendChild(host);
    return host;
  }

  function renderPinnedCard(item){
    const host = ensurePinnedHost();
    if (!item){ host.style.display='none'; host.innerHTML=''; return; }
    const top2 = (item.candidates||[]).slice(0,2);
    const headerBg = getPartyColor(partyKey(top2[0]?.party||'Other'));
    const headerFg = contrastText(headerBg);
    const rows = top2.map(c=>{
      const P = partyKey(c.party);
      const icon = getPartyIcon(P);
      return `
        <div style="display:grid; grid-template-columns:26px 1fr 70px 70px; gap:8px; align-items:center; padding:8px 10px; border-top:1px solid var(--border); background:var(--card-alt)">
          <img src="${icon}" alt="${P}" class="party-icon" referrerpolicy="no-referrer" style="height:18px; width:auto">
          <div style="font-weight:800; color:${getPartyColor(P)}">${c.name} <span style="color:var(--muted); font-weight:700">(${P})</span></div>
          <div style="text-align:right; font-weight:800">${Number(c.votes||0).toLocaleString()}</div>
          <div style="text-align:right; color:var(--muted)">${c.pct||0}%</div>
        </div>`;
    }).join('');
    host.innerHTML = `
      <div style="padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; background:${headerBg}; color:${headerFg}">
        <div style="font-weight:900; line-height:1.2; cursor:pointer" id="pinTitle">#${item.constno||'—'} ${item.constituency}</div>
        <div style="display:flex; gap:6px; align-items:center">
          <button id="btnPinOpen" class="btn" style="background:transparent; border:1px solid ${headerFg}; color:${headerFg}; padding:6px 8px; border-radius:8px">Open</button>
          <button id="btnPinUnpin" class="btn" style="background:transparent; border:1px solid ${headerFg}; color:${headerFg}; padding:6px 8px; border-radius:8px">Unpin ✕</button>
        </div>
      </div>
      <div style="padding:6px 0">${rows}</div>
      <div style="padding:8px 12px; color:var(--muted); border-top:1px solid var(--border)">Margin: <b>${item.marginVotes}</b> votes</div>
    `;
    host.style.display='block';

    // interactions
    host.onmouseover = ()=> highlightConstituency(item.constno);
    host.onmouseout  = ()=> unhighlightConstituency(item.constno);
    host.querySelector('#btnPinUnpin').onclick = ()=> { localStorage.removeItem('pinnedRace'); renderPinnedCard(null); };
    host.querySelector('#btnPinOpen').onclick  = ()=> gotoInteractiveKey(item.key || item.normKey || item.constKey || item.constnoKey || item.constno || norm(item.constituency));
    host.querySelector('#pinTitle').onclick    = ()=> gotoInteractive(item.constituency);
  }

  function pinRace(item){
    // enrich & persist
    const rec = Object.values(window.__rawData||{}).find(x=> canonKey(norm(x?.Name))===canonKey(norm(item.constituency)));
    const constno = constNameToNo[canonKey(norm(item.constituency))] || rec?.ConstNo || item.constno || '';
    const payload = {
      key: canonKey(norm(item.constituency)),
      constno,
      constituency: item.constituency,
      marginVotes: item.marginVotes,
      candidates: (item.candidates||[]).slice(0,2)
    };
    localStorage.setItem('pinnedRace', JSON.stringify(payload));
    renderPinnedCard(payload);
    toast('Pinned race saved.');
  }

  // Restore on load (called near startup)
  function restorePinned(){
    try{
      const raw = localStorage.getItem('pinnedRace');
      if (!raw) return;
      const item = JSON.parse(raw);
      if (item && item.constituency) renderPinnedCard(item);
    }catch(_){}
  }

  /* ===== Tie into load cycle: extend closest builder to include votes margin ===== */
  // Patch into the existing load process: ensure closestArr items get marginVotes & constno.
  // If you already calculate closestArr elsewhere, keep this helper to decorate before rendering.
  function decorateClosestWithVotes(rawData, detailsByConst){
    const out = [];
    Object.values(rawData).forEach(c=>{
      const cname=c?.Name||''; const cData=Array.isArray(c?.Data)? c.Data[0] : c?.Data;
      const cand = Array.isArray(cData?.Candidates)? cData.Candidates : [];
      if(!cname || cand.length<2) return;
      const safeVote = (x)=> Number(x)||0;
      const sorted = cand.slice().sort((a,b)=> safeVote(b.Votes)-safeVote(a.Votes)).map(k=>({
        name:`${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}`.trim(),
        party:partyKey(k.Party),
        votes:safeVote(k.Votes),
        pct:Number(k.Percentage)||0
      }));
      const marginVotes = Math.max(0,(sorted[0].votes - sorted[1].votes));
      const key = canonKey(norm(cname));
      out.push({
        constituency:cname,
        constno: constNameToNo[key] || '',
        winnerFirst: sorted[0]?.name.split(' ')[0]||'',
        winnerLast:  (sorted[0]?.name.split(' ').slice(1).join(' '))||'',
        winnerParty: sorted[0]?.party||'Other',
        marginVotes,
        candidates: sorted
      });
    });
    return out;
  }

  /* ===== Start / bootstrap (append to your existing start sequence) ===== */
  // If you already have an IIFE start() in earlier chunks, keep that.
  // The following listeners ensure pinned card restoration after first data load.
  document.addEventListener('DOMContentLoaded', ()=>{
    // Try to restore pinned after first paint (and again after first successful load)
    restorePinned();
  });

  // Optional: if your existing code exposes a hook after loadECJAndData completes,
  // you can call restorePinned() there too to ensure UI is in sync.

  /* ===== END: close script and document ===== */
</script>
</body>
</html>
