<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>Jamaica Decision 2025 â€” Live Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
Â  /* THEME TOKENS */
Â  :root{
Â  Â  --bg:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --accent:#0a58ca;
Â  Â  --card:#ffffff; --card-alt:#f8fafc; --shadow:0 6px 18px rgba(17,24,39,.06);
Â  Â  --jlp:#2e8b57; --pnp:#ff8c00; --jpp:#6a0dad; --uic:#008b8b; --other:#1e90ff;
Â  Â  --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
Â  Â  --hdrh:56px; --tabh:48px;
Â  }
Â  html[data-theme="dark"]{
Â  Â  --bg:#0f172a;
Â  Â  --text:#e5e7eb;
Â  Â  --muted:#9ca3af;
Â  Â  --border:#334155;
Â  Â  --accent:#60a5fa;
Â  Â  --card:#111827;
Â  Â  --card-alt:#0b1220;
Â  Â  --shadow:0 6px 18px rgba(0,0,0,.35);
Â  }

Â  *{box-sizing:border-box}
Â  body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
Â  body.modal-open{overflow:hidden}

Â  /* Header (raise z-index so maps stay underneath) */
Â  .header{position:sticky; top:0; z-index:1500; background:var(--card); border-bottom:1px solid var(--border)}
Â  .header-inner{max-width:1800px; margin:0 auto; padding:14px 24px; display:flex; align-items:center; gap:18px; flex-wrap:wrap}
Â  .brand{font-weight:800; font-size:1.25rem; letter-spacing:.2px}
Â  .live-pill{margin-left:auto; display:flex; align-items:center; gap:8px; font-weight:700}
Â  .live-dot{width:10px; height:10px; border-radius:50%; background:#ef4444; animation:pulse 1.8s infinite}
Â  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}70%{box-shadow:0 0 0 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
Â  .refresh{display:flex; align-items:center; gap:6px}
Â  select, .mode-btn{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:var(--card); color:var(--text); cursor:pointer; font-weight:700}
Â  .mode-btn{display:flex; align-items:center; gap:6px}

Â  /* Source status pills */
Â  .status-group{display:flex; align-items:center; gap:12px; margin-left:8px}
Â  .status-pill{
Â  Â  display:flex; align-items:center; gap:8px;
Â  Â  background:var(--card); border:1px solid var(--border); border-radius:999px;
Â  Â  padding:6px 10px; font-weight:800; color:var(--text);
Â  }
Â  .status-pill small{color:var(--muted); font-weight:600}
Â  .dot{width:10px; height:10px; border-radius:50%; animation:pulse 1.8s infinite; background:#10b981}
Â  .dot.ok{ background:#10b981 } .dot.warn{ background:#f59e0b } .dot.bad{ background:#ef4444 }

Â  /* Tabs â€” sticky (below header), with higher z-index than maps */
Â  .tabs{position:sticky; top:var(--hdrh); z-index:1400; background:var(--card); border-bottom:1px solid var(--border)}
Â  .tabs-inner{max-width:1800px; margin:0 auto; padding:0 24px; display:flex; gap:24px}
Â  .tab{padding:14px 2px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:800}
Â  .tab.active{border-color:var(--accent); color:var(--text)}

Â  /* Topline */
Â  .topline{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border-bottom:1px solid var(--border)}
Â  .topline-inner{max-width:1800px; margin:0 auto; padding:12px 24px; display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
Â  .tcard{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:flex; gap:12px; align-items:center}
Â  .tlogo{height:22px; width:auto; filter:brightness(1)}
Â  html[data-theme="dark"] .tlogo{filter:brightness(1.2) contrast(1.1)}
Â  .tstats{font-size:.98rem; color:var(--muted)} .tstats b{color:var(--text)}
Â  .delta{font-weight:800; margin-left:6px} .delta.up{color:#16a34a} .delta.down{color:#ef4444}

Â  /* Page grid */
Â  .page{display:grid; grid-template-columns:1fr minmax(0,1600px) 320px 1fr; gap:16px}
Â  .page > .main{grid-column:2}
Â  .page > .rightbar{grid-column:3}
Â  @media (max-width:1300px){ .page{display:block} .rightbar{position:relative; width:auto; max-width:none} }

Â  /* Sidebar (z under tabs/header) */
Â  .rightbar{position:sticky; top:calc(var(--hdrh) + var(--tabh) + 12px); align-self:start; height:calc(100vh - (var(--hdrh) + var(--tabh) + 28px)); overflow:auto;
Â  Â  background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; z-index:1}
Â  .rightbar h3{margin:2px 0 8px 0; font-size:1rem}
Â  .sideitem{position:relative; display:flex; justify-content:space-between; align-items:center;
Â  Â  border:2px solid var(--border); border-radius:12px; padding:6px 8px; margin:8px 0; font-weight:800; cursor:pointer; background:var(--card)}
Â  .sideitem small{color:var(--muted); font-weight:700; font-size:.88em; font-variant-numeric:tabular-nums}
Â  .sideitem::before{content:""; position:absolute; inset:-2px; border-radius:14px; padding:2px; background:
Â  Â  conic-gradient(from var(--angle,0deg), rgba(22,163,74,.9), rgba(245,158,11,.9), rgba(239,68,68,.9), rgba(22,163,74,.9));
Â  Â  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
Â  Â  -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; opacity:.18; animation:spin 12s linear infinite}
Â  @keyframes spin{to{--angle:360deg}}
Â  .age-good{border-color:var(--good)} .age-warn{border-color:var(--warn)} .age-bad{border-color:var(--bad)}

Â  /* Sections / cards */
Â  .container{max-width:1600px; margin:14px auto; padding:0 24px}
Â  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}

Â  /* Controls */
Â  .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
Â  .controls input, .controls select{border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:var(--card); color:var(--text)}
Â  .controls input#searchBar{width:360px; max-width:90vw}
Â  .controls input#cnoFilter{width:120px}

Â  /* Parish -> constituency blocks */
Â  .parish{margin:12px 0 22px}
Â  .parish h2{font-size:1.1rem; border-left:4px solid var(--accent); padding-left:10px; margin:0 0 12px}
Â  .const-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(330px,1fr))} /* Changed from 300px to 330px */
Â  .const{background:var(--card); border:2px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer}
Â  .const-head{background:linear-gradient(180deg, color-mix(in oklab, var(--card) 90%, var(--bg)), color-mix(in oklab, var(--card) 75%, var(--bg))); border-bottom:1px solid var(--border);
Â  Â  padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px}
Â  .const-name{font-weight:900; font-size:1rem; line-height:1.2; background:var(--bg); padding:3px 8px; border:1px solid var(--border); border-radius:8px}
Â  .updated{font-size:.85rem; color:var(--muted); display:flex; flex-direction:column; align-items:flex-end; text-align:right; gap:4px; white-space:nowrap}
Â  .pulse{display:inline-block; width:10px; height:10px; border-radius:50%; background:currentColor; animation:pulseSoft 1.8s infinite}
Â  @keyframes pulseSoft{0%{box-shadow:0 0 0 0 rgba(0,0,0,.2)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
Â  .const-body{padding:12px; display:flex; flex-direction:column; gap:8px}
Â  .winner-badge{display:inline-flex; align-items:center; gap:6px; font-weight:800; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08)}
Â  html[data-theme="dark"] .winner-badge{border-color:#00000040}
Â  .winner-badge .check{font-weight:900}
Â  .boxline{font-size:.9rem; color:var(--muted); margin-top:2px}

Â  /* New progress bar */
Â  .const-bar {
Â  Â  height: 8px;
Â  Â  border-radius: 4px;
Â  Â  background: var(--border);
Â  Â  display: flex;
Â  Â  overflow: hidden;
Â  Â  margin-top: 8px;
Â  }
Â  .const-bar span {
Â  Â  display: block;
Â  Â  height: 100%;
Â  }
Â  .const-bar-container{padding: 0 12px 12px;}

Â  /* Rows (5 columns) */
Â  .rows{margin-top:6px; border-top:1px solid var(--border)}
Â  .row{
Â  Â  display:grid;
Â  Â  grid-template-columns:35px 1fr 40px 70px 52px;
Â  Â  gap:12px; padding:10px 4px;
Â  Â  align-items:start;
Â  Â  border-bottom:1px solid var(--border);
Â  Â  min-height:44px;
Â  Â  background:var(--card-alt);
Â  }
Â  .row:last-child{border-bottom:none}
Â  .nm{font-weight:700; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.15}
Â  .party{ text-align:center; font-weight:800; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:.3px; }
Â  .votes{font-weight:800; text-align:right}
Â  .pct{color:var(--muted); text-align:right}
Â  .party-icon{height:18px; width:auto; display:block; margin-top:2px; filter:none}
Â  html[data-theme="dark"] .party-icon{filter:brightness(1.1)}

Â  /* Scoreboard + charts */
Â  .scoreboard{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(330px,1fr))}
Â  .pcard{border:1px solid var(--border); border-radius:10px; padding:14px; background:var(--card)}
Â  .phead{display:flex; align-items:center; justify-content:space-between; gap:12px}
Â  .pbrand{display:flex; align-items:center; gap:10px; font-weight:800}
Â  .plogo{height:22px; width:auto; filter:none}
Â  html[data-theme="dark"] .plogo{filter:brightness(1.2) contrast(1.1)}
Â  .pmain{font-size:1.6rem; font-weight:800}
Â  .bar{height:8px; border-radius:999px; background:var(--border); overflow:hidden; margin-top:8px}
Â  .bar>span{display:block; height:100%}

Â  .charts{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
Â  .chart-wrap{position:relative; height:300px}
Â  canvas{position:absolute; inset:0}

Â  .closelist{list-style:none; padding:0; margin:0; display:grid; gap:8px}
Â  .closelist li{display:flex; justify-content:space-between; gap:10px; border:1px solid var(--border); background:var(--card); border-radius:10px; padding:10px 12px; cursor:pointer}

Â  /* Maps */
Â  .map-wrap{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card-alt); z-index:1}
Â  #mapContainer{height:460px}
Â  #imapMap{height:60vh; min-height:380px; max-height:72vh}
Â  .mapControls{position:absolute; right:8px; top:8px; z-index:500}
Â  .btn{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; color:var(--text)}
Â  .btn:hover{filter:brightness(0.98)}
Â  .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
Â  .legend-item{display:inline-flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); padding:6px 10px; border-radius:999px; color:var(--text)}
Â  .swatch{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15)}
Â  .leaflet-tooltip{background:#111827; color:#f9fafb; border:0; border-radius:8px; padding:8px 10px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
Â  .leaflet-container{background:var(--card-alt)}
Â  .leaflet-control-attribution{display:none}

Â  /* Bottom ticker â€” ensure above maps too */
Â  .ticker{position:sticky; bottom:0; z-index:1600; background:#0b1220; color:#fff; border-top:1px solid #0f172a}
Â  html[data-theme="dark"] .ticker{background:#0b1220}
Â  .ticker-inner{max-width:1600px; margin:0 auto; padding:10px 24px; display:flex; align-items:center; gap:12px; overflow:hidden}
Â  .tick-title{font-weight:800; margin-right:8px}
Â  .marquee{white-space:nowrap; overflow:hidden; flex:1}
Â  .marquee span{display:inline-block; padding-left:100%; animation:scroll 180s linear infinite}
Â  @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

Â  .hidden{display:none !important}
Â  .toast{position:fixed; right:12px; bottom:72px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); z-index:2000; font-weight:700}

Â  /* ================== PREVIEW MODAL ================== */
Â  .modal{position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(2px)}
Â  .modal.show{display:flex}
Â  .modal-content{
Â  Â  width:min(1100px, 66vw);
Â  Â  max-height:86vh;
Â  Â  background:var(--card);
Â  Â  color:var(--text);
Â  Â  border:1px solid var(--border);
Â  Â  border-radius:16px;
Â  Â  box-shadow:0 30px 80px rgba(0,0,0,.35);
Â  Â  display:grid;
Â  Â  grid-template-rows:auto auto 1fr auto;
Â  Â  overflow:hidden;
Â  }
Â  .modal-header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border)}
Â  .modal-title{font-weight:900; font-size:1.05rem}
Â  .modal-hint{padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--border)}
Â  .modal-body{display:grid; grid-template-columns:1.2fr .8fr; gap:0; min-height:380px}
Â  #previewMap{min-height:380px; position:relative}
Â  .modal-details{border-left:1px solid var(--border); padding:10px 12px; overflow:auto}
Â  .modal-actions{padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end}
Â  .btn-secondary{background:color-mix(in oklab, var(--card) 80%, var(--bg)); border:1px solid var(--border)}
Â  .btn-primary{background:var(--accent); border:1px solid color-mix(in oklab, var(--accent) 70%, black); color:white}
Â  .close-x{border-radius:10px; padding:6px 10px; background:var(--card); border:1px solid var(--border); cursor:pointer}

Â  /* Preview loading shimmer */
Â  .shimmer{
Â  Â  position:absolute; inset:0; pointer-events:none;
Â  Â  background:linear-gradient(100deg, rgba(0,0,0,0) 0%, rgba(148,163,184,.22) 40%, rgba(0,0,0,0) 80%);
Â  Â  background-size:200% 100%;
Â  Â  animation:shimmer 1.2s linear infinite;
Â  Â  z-index:5;
Â  }
Â  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

Â  /* Ensure Leaflet panes donâ€™t exceed sticky UI */
Â  .leaflet-pane{z-index:400}
</style>
</head>
<body>
Â  <div class="page">
Â  Â  Â  Â  <div class="main">
Â  Â  Â  Â  Â  Â  <header class="header" id="siteHeader">
Â  Â  Â  Â  <div class="header-inner">
Â  Â  Â  Â  Â  <div class="brand">Jamaica Decision 2025 â€” Live Results</div>

Â  Â  Â  Â  Â  <button id="modeBtn" class="mode-btn" title="Toggle light/dark">ðŸŒž Light</button>

Â  Â  Â  Â  Â  <div class="refresh">
Â  Â  Â  Â  Â  Â  <span style="color:var(--muted)">Auto-refresh:</span>
Â  Â  Â  Â  Â  Â  <select id="refreshSel">
Â  Â  Â  Â  Â  Â  Â  <option value="15000">15s</option>
Â  Â  Â  Â  Â  Â  Â  <option value="30000">30s</option>
Â  Â  Â  Â  Â  Â  Â  <option value="60000" selected>1m</option>
Â  Â  Â  Â  Â  Â  Â  <option value="120000">2m</option>
Â  Â  Â  Â  Â  Â  Â  <option value="300000">5m</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <button id="btnForceRefresh" class="btn">Refresh now</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="status-group" id="sourceStatus">
Â  Â  Â  Â  Â  Â  <div class="status-pill" id="pillMain" title="Using local 2025-data.json">
Â  Â  Â  Â  Â  Â  Â  <span class="dot ok" aria-hidden="true"></span> Data <small id="mainLag">Local file</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="live-pill"><span class="live-dot"></span><span id="lastUpdated">Updatingâ€¦</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </header>

Â  Â  Â  Â  Â  Â  <nav class="tabs" id="siteTabs">
Â  Â  Â  Â  <div class="tabs-inner">
Â  Â  Â  Â  Â  <div class="tab active" data-tab="constituencies">Constituencies</div>
Â  Â  Â  Â  Â  <div class="tab" data-tab="interactive">Interactive Map</div>
Â  Â  Â  Â  Â  <div class="tab" data-tab="national">National</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </nav>

Â  Â  Â  Â  Â  Â  <section class="topline">
Â  Â  Â  Â  <div class="topline-inner" id="toplineBar"></div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="tab-national" class="hidden">
Â  Â  Â  Â  <div class="container">
Â  Â  Â  Â  Â  <div class="scoreboard" id="scoreboard"></div>

Â  Â  Â  Â  Â  <div class="charts">
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  <h2 style="color:var(--muted); font-size:1rem">Total Votes by Party</h2>
Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="voteChart"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  <h2 style="color:var(--muted); font-size:1rem">Seats Won by Party</h2>
Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="seatChart"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h2>Top 10 Closest Seats</h2>
Â  Â  Â  Â  Â  Â  <ul id="closestList" class="closelist"></ul>
Â  Â  Â  Â  Â  Â  <p id="closestNote" style="color:var(--muted); margin-top:8px"></p>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h2>Seats Won Map</h2>
Â  Â  Â  Â  Â  Â  <div class="map-wrap">
Â  Â  Â  Â  Â  Â  Â  <div id="mapContainer"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="mapControls"><button id="btnResetNational" class="btn">Reset view</button></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="mapLegend" class="legend"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="tab-constituencies">
Â  Â  Â  Â  <div class="container">
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  <input id="searchBar" type="text" placeholder="Search candidate, constituency, #â€¦">
Â  Â  Â  Â  Â  Â  Â  <select id="parishFilter"><option value="">All Parishes</option></select>
Â  Â  Â  Â  Â  Â  Â  <select id="partyFilter">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">All Parties</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>JLP</option><option>PNP</option><option>JPP</option><option>UIC</option><option>Other</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  <input id="cnoFilter" type="text" inputmode="numeric" placeholder="Const. #">
Â  Â  Â  Â  Â  Â  Â  <div class="split">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="sortField" style="color:var(--muted); font-weight:700">Sort by</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="sortField">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="cno">Const #</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="name">Const name</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="parish">Parish</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="party">Leading party</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="sortDir">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="asc">Asc</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="desc">Desc</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h2>Constituencies by Parish</h2>
Â  Â  Â  Â  Â  Â  <div id="parishContainer"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="tab-interactive" class="hidden">
Â  Â  Â  Â  <div class="container">
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h2>Interactive Map</h2>
Â  Â  Â  Â  Â  Â  <div class="map-wrap">
Â  Â  Â  Â  Â  Â  Â  <div id="imapMap"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="mapControls"><button id="btnResetInteractive" class="btn">Reset view</button></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="imapLegend" class="legend" style="margin-top:8px"></div>
Â  Â  Â  Â  Â  Â  <div id="imapDetails" class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  Â  Â  <h2 style="margin-top:0">Constituency Details</h2>
Â  Â  Â  Â  Â  Â  Â  <div id="imapContent" class="small">Click a constituency to see results here.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>
Â  Â  </div>

Â  Â  Â  Â  <aside class="rightbar" aria-label="Recently Updated Constituency Numbers">
Â  Â  Â  <h3>Recently Updated (#)</h3>
Â  Â  Â  <div id="sidebarList"></div>
Â  Â  </aside>
Â  </div>

Â  Â  <div class="ticker">
Â  Â  <div class="ticker-inner">
Â  Â  Â  <span class="tick-title">Live Updates:</span>
Â  Â  Â  <div class="marquee"><span id="tickerText">â€”</span></div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="modal" id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <div class="modal-title" id="previewTitle">Constituency</div>
Â  Â  Â  Â  <button class="close-x" id="btnPreviewClose" aria-label="Close preview">âœ•</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-hint" aria-live="polite">Loadingâ€¦</div>
Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  <div id="previewMap">
Â  Â  Â  Â  Â  <div class="shimmer" id="previewShimmer"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-details">
Â  Â  Â  Â  Â  <div id="previewBoxes" class="boxline" style="margin-top:2px"></div>
Â  Â  Â  Â  Â  <table style="width:100%; border-collapse:collapse; margin-top:8px">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr><th style="width:28px"></th><th style="text-align:left">Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="previewTableBody"></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  <button class="btn btn-secondary" id="btnPreviewCancel">Close</button>
Â  Â  Â  Â  <button class="btn btn-primary" id="btnPreviewGo">Open in Interactive Map</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

<script>
/* ===== Config ===== */
const AUTO_DEFAULT = 60000;
const ECJ_GEOJSON =
Â 'https://services6.arcgis.com/3R3y1KXaPJ9BFnsU/arcgis/rest/services/ECJWEB_MAP/FeatureServer/6/query?where=1%3D1&outFields=*&f=geojson';
const JAMAICA_BOUNDS = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);

/* Party theming (unchanged) */
const PARTY_COLORS = { JLP:'#2e8b57', PNP:'#ff8c00', JPP:'#6a0dad', UIC:'#008b8b', Other:'#1e90ff' };
const PARTY_LOGOS = {
Â  JLP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JLP_logo-300x98.png",
Â  PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_logo-300x182.png",
Â  JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_logo-300x275.png",
Â  UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_logo-300x164.png",
Â  Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
};
const PARTY_SYMBOLS = {
Â  JLP:"https://ecj.com.jm/wp-content/uploads/2025/03/JLP_symbol.png",
Â  PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_symbol.png",
Â  JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_symbol-300x261.png",
Â  UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_symbol-300x106.png",
Â  Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
};
const CORE_PARTIES = ["JLP","PNP","JPP","UIC"];
const TICKER_MAX_AGE = 15*60*1000;
const SIDEBAR_MAX_AGE = 25*60*1000;

/* ===== Local data source ===== */
const DATA_URL = './2025-data.json';Â  // â†â€”â€”â€”â€”â€” local file

/* ===== Normalizer + Name Aliases with metadata ===== */
function norm(s){ return String(s||'').toLowerCase().replace(/[\s\-\u2013\u2014'â€™.]/g,'').replace(/&/g,'and'); }
const NAME_ALIASES = {
Â  [norm('Kingston East and Port Royal')]: { key: norm('Kingston Eastern and Port Royal'), parish: 'KINGSTON', constno: '3' }
};
function canonKey(k){ return NAME_ALIASES[k]?.key || k; }

/* ===== State ===== */
let voteChart=null, seatChart=null, refreshTimer=null, timerInterval=null;
let mapNational=null, mapInteractive=null, geoLayerNational=null, geoLayerInteractive=null;
let baseLightNat=null, baseDarkNat=null, baseLightInt=null, baseDarkInt=null, currentBase='light';
let arcFeatures=[], byParish={}, constNameToNo={}, constNameToParish={};
let leaderColors = {}; let focusedKey = null; let pendingFocusName = null;
let lastSeats = JSON.parse(localStorage.getItem('lastSeats') || '{}');
let lastConstHashes = JSON.parse(localStorage.getItem('constituencyHashes')||'{}');
let lastConstUpdated = JSON.parse(localStorage.getItem('constituencyUpdated')||'{}');

/* ===== Preview modal state ===== */
let previewMap=null, previewLayer=null, previewKey=null, previewPulseTimer=null;

/* ===== Utils ===== */
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),4000); }
function contrastText(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16); return ((r*299+g*587+b*114)/1000>=140)?'#0b1220':'#ffffff'; }catch{ return '#0b1220'; } }
function fmtHHMMSS(ms){ const s=Math.max(0,Math.floor(ms/1000)); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
function makeHash(cands){ return cands.map(k=>`${(k.Party||'Other').toUpperCase()}|${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}|${Number(k.Votes||0)}`).join(';'); }
const partyKey = p => { const P = String(p||'Other').toUpperCase(); if (P.startsWith('INDA') || P.startsWith('INDB')) return 'Other'; return ['JLP','PNP','JPP','UIC'].includes(P) ? P : 'Other'; };
const bust = url => url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now();

/* ===== Theme toggle ===== */
function applyTheme(theme){
Â  document.documentElement.setAttribute('data-theme', theme);
Â  document.getElementById('modeBtn').textContent = theme==='dark' ? 'ðŸŒ™ Dark' : 'ðŸŒž Light';
Â  if (mapNational && baseLightNat && baseDarkNat){
Â  Â  if (theme==='dark' && currentBase!=='dark'){ mapNational.removeLayer(baseLightNat); baseDarkNat.addTo(mapNational); currentBase='dark'; }
Â  Â  if (theme==='light' && currentBase!=='light'){ mapNational.removeLayer(baseDarkNat); baseLightNat.addTo(mapNational); currentBase='light'; }
Â  Â  setTimeout(()=>mapNational.invalidateSize(), 60);
Â  }
Â  if (mapInteractive && baseLightInt && baseDarkInt){
Â  Â  if (theme==='dark'){ mapInteractive.removeLayer(baseLightInt); baseDarkInt.addTo(mapInteractive); }
Â  Â  else { mapInteractive.removeLayer(baseDarkInt); baseLightInt.addTo(mapInteractive); }
Â  Â  setTimeout(()=>mapInteractive.invalidateSize(), 60);
Â  }
}
function initTheme(){
Â  const saved = localStorage.getItem('theme') || 'light';
Â  applyTheme(saved);
Â  document.getElementById('modeBtn').addEventListener('click', ()=>{
Â  Â  const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
Â  Â  const next = cur==='dark' ? 'light' : 'dark';
Â  Â  localStorage.setItem('theme', next);
Â  Â  applyTheme(next);
Â  });
}

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
Â  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
Â  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
Â  t.classList.add('active');
Â  document.getElementById('tab-'+t.dataset.tab).classList.remove('hidden');
Â  if (t.dataset.tab==='national' && mapNational) setTimeout(()=>mapNational.invalidateSize(), 60);
Â  if (t.dataset.tab==='interactive' && mapInteractive) {
Â  Â  setTimeout(()=>mapInteractive.invalidateSize(), 60);
Â  Â  if (pendingFocusName){ focusConstituencyByName(pendingFocusName, true); pendingFocusName=null; }
Â  Â  else {
Â  Â  Â  const cur = document.getElementById('imapContent')?.dataset?.currentKey;
Â  Â  Â  if (cur) focusConstituencyByName(cur, true);
Â  Â  }
Â  }
}));

/* ===== Sticky offsets ===== */
function updateStickyOffsets(){
Â  const hdr = document.getElementById('siteHeader');
Â  const tabs = document.getElementById('siteTabs');
Â  if (hdr){ document.documentElement.style.setProperty('--hdrh', hdr.offsetHeight+'px'); }
Â  if (tabs){ document.documentElement.style.setProperty('--tabh', tabs.offsetHeight+'px'); }
}
window.addEventListener('resize', updateStickyOffsets);

/* ===== Auto refresh ===== */
const sel = document.getElementById('refreshSel');
sel.value = localStorage.getItem('refreshIntervalMs') || String(AUTO_DEFAULT);
sel.addEventListener('change', ()=>{ localStorage.setItem('refreshIntervalMs', sel.value); setupAutoRefresh(); });
document.getElementById('btnForceRefresh').addEventListener('click', ()=>{ loadECJAndData(); });

/* ===== Maps ===== */
const JAMAICA_BOUNDS_LEAF = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);
function initNationalMap(){
Â  if (mapNational) return;
Â  mapNational = L.map('mapContainer',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
Â  baseLightNat = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
Â  baseDarkNatÂ  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
Â  (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkNat : baseLightNat).addTo(mapNational);
Â  mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
Â  mapNational.setMinZoom(mapNational.getZoom());
Â  document.getElementById('btnResetNational').onclick = ()=>{
Â  Â  mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
Â  Â  mapNational.setMinZoom(mapNational.getZoom());
Â  Â  setTimeout(()=> mapNational.invalidateSize(), 40);
Â  };
}
function initInteractiveMap(){
Â  if (mapInteractive) return;
Â  mapInteractive = L.map('imapMap',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
Â  baseLightInt = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
Â  baseDarkIntÂ  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15});
Â  (document.documentElement.getAttribute('data-theme')==='dark' ? baseDarkInt : baseLightInt).addTo(mapInteractive);
Â  mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
Â  mapInteractive.setMinZoom(mapInteractive.getZoom());
Â  document.getElementById('btnResetInteractive').onclick = ()=>{
Â  Â  mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
Â  Â  mapInteractive.setMinZoom(mapInteractive.getZoom());
Â  Â  focusedKey = null; pendingFocusName = null;
Â  Â  const cont = document.getElementById('imapContent');
Â  Â  cont.textContent = 'Click a constituency to see results here.';
Â  Â  cont.dataset.currentKey = '';
Â  Â  if (geoLayerInteractive){
Â  Â  Â  geoLayerInteractive.eachLayer(l=>{
Â  Â  Â  Â  try{ l.closeTooltip(); }catch(_){}
Â  Â  Â  Â  const nm = l.feature?.properties?.CONST_NAME || '';
Â  Â  Â  Â  const key = norm(nm);
Â  Â  Â  Â  const fill = leaderColors[key] || '#e5e7eb';
Â  Â  Â  Â  l.setStyle({ fillColor:fill, fillOpacity:0.75, color:'#94a3b8', weight:1 });
Â  Â  Â  Â  stopPulse(l);
Â  Â  Â  });
Â  Â  }
Â  Â  setTimeout(()=> mapInteractive.invalidateSize(), 40);
Â  };
Â  window.addEventListener('resize', ()=> setTimeout(()=> mapInteractive.invalidateSize(), 40));
}
function buildLegendInto(containerId){
Â  const host=document.getElementById(containerId); if(!host) return;
Â  host.innerHTML='';
Â  ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
Â  Â  const el=document.createElement('span'); el.className='legend-item';
Â  Â  el.innerHTML=`<span class="swatch" style="background:${PARTY_COLORS[p]}"></span>${p}`;
Â  Â  host.appendChild(el);
Â  });
}

/* ===== Boundaries ===== */
async function loadECJBoundaries(){
Â  const gj = await fetch(ECJ_GEOJSON, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('Boundaries HTTP '+r.status); return r.json(); });
Â  arcFeatures = gj.features || [];
Â  byParish = {}; constNameToNo={}; constNameToParish={};
Â  arcFeatures.forEach(f=>{
Â  Â  const p=f.properties||{};
Â  Â  const parish = p.PARISH_NAM || p.PARISH_NAME || '';
Â  Â  const cnameÂ  = p.CONST_NAME || p.CONSTNAME || p.Name || '';
Â  Â  const cnoÂ  Â  = p.CONST_NO || p.CONSTNO || p.Number || '';
Â  Â  const key=norm(cname);
Â  Â  if (parish) (byParish[parish] ||= []);
Â  Â  constNameToNo[key]=(cno||'').toString();
Â  Â  constNameToParish[key]=parish||'';
Â  });
Â  Object.values(NAME_ALIASES).forEach(a=>{
Â  Â  if (a.key){
Â  Â  Â  constNameToParish[a.key] = a.parish || constNameToParish[a.key] || '';
Â  Â  Â  constNameToNo[a.key]Â  Â  Â = a.constno || constNameToNo[a.key] || '';
Â  Â  }
Â  });
}

/* ===== Pulsing helpers ===== */
function startPulse(layer){
Â  if (!layer || layer._pulseTimer) return;
Â  let up=true;
Â  layer._pulseTimer = setInterval(()=>{
Â  Â  const next = up ? 0.95 : 0.6; up=!up;
Â  Â  layer.setStyle({ fillOpacity: next });
Â  }, 800);
}
function stopPulse(layer){
Â  if (layer && layer._pulseTimer){
Â  Â  clearInterval(layer._pulseTimer);
Â  Â  layer._pulseTimer = null;
Â  Â  layer.setStyle({ fillOpacity:0.75 });
Â  }
}

/* ===== Topline / score / charts / closest ===== */
function buildToplineBar(totals,seats){
Â  const el=document.getElementById('toplineBar'); el.innerHTML='';
Â  const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
Â  const deltas={}; ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{ const prev=lastSeats?.[p]||0; const cur=seats[p]||0; deltas[p]=cur-prev; });
Â  localStorage.setItem('lastSeats', JSON.stringify(seats)); lastSeats=seats;
Â  ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
Â  Â  const votes=totals[p]||0, s=seats[p]||0; const pct=((votes/(totalVotes||1))*100).toFixed(1); const d=deltas[p]||0;
Â  Â  const deltaHtml = d?`<span class="delta ${d>0?'up':'down'}">${d>0?'â–²':'â–¼'} ${Math.abs(d)}</span>`:'';
Â  Â  const card=document.createElement('div'); card.className='tcard';
Â  Â  card.innerHTML = `<img class="tlogo" src="${PARTY_LOGOS[p]}" alt="${p} logo" referrerpolicy="no-referrer">
Â  Â  Â  <div class="tstats"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; <b>${votes.toLocaleString()}</b> votes &nbsp;|&nbsp; <b>${pct}%</b></div>`;
Â  Â  el.appendChild(card);
Â  });
}
function buildScoreboard(totals,seats){
Â  const el=document.getElementById('scoreboard'); if(!el) return; el.innerHTML='';
Â  const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
Â  const prev = JSON.parse(localStorage.getItem('lastSeats')||'{}');
Â  [{key:'JLP', name:'Jamaica Labour Party', color:PARTY_COLORS.JLP, logo:PARTY_LOGOS.JLP},
Â  Â {key:'PNP', name:'Peopleâ€™s National Party', color:PARTY_COLORS.PNP, logo:PARTY_LOGOS.PNP},
Â  Â {key:'Other', name:'Others (JPP, UIC, etc.)', color:PARTY_COLORS.Other, logo:PARTY_LOGOS.Other}].forEach(g=>{
Â  Â  const votes=totals[g.key]||0, s=seats[g.key]||0, pct=((votes/(totalVotes||1))*100).toFixed(1);
Â  Â  const delta=s-(prev?.[g.key]||0);
Â  Â  const deltaHtml = delta?`<span class="delta ${delta>0?'up':'down'}">${delta>0?'â–²':'â–¼'} ${Math.abs(delta)}</span>`:'';
Â  Â  const div=document.createElement('div'); div.className='pcard';
Â  Â  div.innerHTML = `
Â  Â  Â  <div class="phead">
Â  Â  Â  Â  <div class="pbrand" style="color:${g.color}">
Â  Â  Â  Â  Â  <img class="plogo" src="${g.logo}" alt="${g.key} logo" referrerpolicy="no-referrer">
Â  Â  Â  Â  Â  <strong>${g.name}</strong>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="pmain" style="color:${g.color}">${pct}%</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="bar"><span style="width:${pct}%; background:${g.color}"></span></div>
Â  Â  Â  <div style="margin-top:8px; color:var(--muted)"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; Votes: ${votes.toLocaleString()}</div>`;
Â  Â  el.appendChild(div);
Â  });
}
function buildCharts(totals,seats){
Â  const vc=document.getElementById('voteChart'), sc=document.getElementById('seatChart');
Â  try{ voteChart && voteChart.destroy(); }catch(_){}
Â  try{ seatChart && seatChart.destroy(); }catch(_){}
Â  const labels=Object.keys(totals); if(!labels.length) return;
Â  const colors=labels.map(p=>PARTY_COLORS[p]||PARTY_COLORS.Other);
Â  voteChart=new Chart(vc,{type:'pie',data:{labels,datasets:[{data:labels.map(k=>totals[k]||0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
Â  seatChart=new Chart(sc,{type:'bar',data:{labels,datasets:[{label:'Seats',data:labels.map(k=>seats[k]||0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,precision:0,grid:{color:'rgba(148,163,184,.3)'}}}}});
}
function buildClosestPanel(items){
Â  const list=document.getElementById('closestList'), note=document.getElementById('closestNote'); if(!list) return;
Â  list.innerHTML='';
Â  const top10 = items.filter(x=>!isNaN(x.marginPct)).sort((a,b)=>a.marginPct-b.marginPct).slice(0,10);
Â  top10.forEach(item=>{
Â  Â  const color=PARTY_COLORS[partyKey(item.winnerParty)]||PARTY_COLORS.Other;
Â  Â  const li=document.createElement('li');
Â  Â  li.innerHTML = `<span><strong>${item.constituency}</strong> â€” <span style="color:${color}">${item.winnerFirst} ${item.winnerLast} (${partyKey(item.winnerParty)})</span></span><span><strong>${item.marginPct.toFixed(1)}%</strong></span>`;
Â  Â  li.title = item.candidates.map(c=>`${c.name} (${partyKey(c.party)}): ${c.votes.toLocaleString()} â€¢ ${c.pct}%`).join(' | ');
Â  Â  li.addEventListener('click', ()=> gotoInteractive(item.constituency));
Â  Â  list.appendChild(li);
Â  });
Â  note.textContent='Margin = percentage-point gap between 1st and 2nd.';
}

/* ===== Map coloring & interactions ===== */
function paintMap(layer, detailsByConst){
Â  if (!layer) return;
Â  layer.eachLayer(Ly=>{
Â  Â  const nm = Ly.feature?.properties?.CONST_NAME || '';
Â  Â  const key = norm(nm);
Â  Â  const info = detailsByConst[key];
Â  Â  if (info){
Â  Â  Â  const fill = PARTY_COLORS[partyKey(info.party)] || PARTY_COLORS.Other;
Â  Â  Â  leaderColors[key]=fill;
Â  Â  Â  const strokeWeight = (focusedKey && focusedKey===key) ? 3 : 1;
Â  Â  Â  const strokeColorÂ  = (focusedKey && focusedKey===key) ? '#111827' : '#94a3b8';
Â  Â  Â  Ly.setStyle({ fillColor: fill, fillOpacity:0.75, color:strokeColor, weight:strokeWeight });
Â  Â  Â  const disp = `${nm}${constNameToNo[key]?` (#${constNameToNo[key]})`:''}`;
Â  Â  Â  const rows = (info.all||[]).map(c=>{
Â  Â  Â  Â  const P=partyKey(c.party), col=PARTY_COLORS[P]||PARTY_COLORS.Other;
Â  Â  Â  Â  return `<div><span style="color:${col}; font-weight:700">${c.name}</span> (${P}) â€” ${c.votes.toLocaleString()} â€¢ ${c.pct}%</div>`;
Â  Â  Â  }).join('');
Â  Â  Â  Ly.bindTooltip(`<div style="min-width:260px"><div style="font-weight:800;margin-bottom:4px">${disp}</div>${rows}</div>`, {sticky:true});
Â  Â  }else{
Â  Â  Â  Ly.setStyle({ fillColor:'#e5e7eb', fillOpacity:0.6, color:'#94a3b8', weight:1 });
Â  Â  Â  Ly.bindTooltip(`<div><strong>${nm}</strong><br/><span style="color:#d1d5db">No result yet.</span></div>`, {sticky:true});
Â  Â  }
Â  });
}
function updateFocusOutline(){
Â  if (!geoLayerInteractive) return;
Â  geoLayerInteractive.eachLayer(l=>{
Â  Â  const nm = l.feature?.properties?.CONST_NAME || '';
Â  Â  const key = norm(nm);
Â  Â  const fill = leaderColors[key] || '#e5e7eb';
Â  Â  const isFocused = focusedKey && focusedKey===key;
Â  Â  l.setStyle({ fillColor: fill, fillOpacity:0.75, color: isFocused? '#111827':'#94a3b8', weight: isFocused? 3:1 });
Â  Â  if (isFocused){ try{ l.bringToFront(); }catch(_){}
Â  Â  Â  startPulse(l);
Â  Â  } else {
Â  Â  Â  stopPulse(l);
Â  Â  }
Â  });
}
function wireInteractiveBehaviors(){
Â  const hoverTimers = new WeakMap();
Â  byParish = {};
Â  geoLayerInteractive.eachLayer(l=>{
Â  Â  const parish = l.feature?.properties?.PARISH_NAM;
Â  Â  (byParish[parish] ||= []).push(l);
Â  });
Â  geoLayerInteractive.eachLayer(layer=>{
Â  Â  const nm = layer.feature?.properties?.CONST_NAME || '';
Â  Â  const parish = layer.feature?.properties?.PARISH_NAM || '';
Â  Â  const key = norm(nm);
Â  Â  layer.on('click', ()=>{
Â  Â  Â  const grp = byParish[parish] || [layer];
Â  Â  Â  const group = L.featureGroup(grp);
Â  Â  Â  try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
Â  Â  Â  focusedKey = key; updateFocusOutline();
Â  Â  Â  showConstituencyDetails(key, nm);
Â  Â  });
Â  Â  layer.on('mouseover', e=>{
Â  Â  Â  const t = setTimeout(()=>{ e.target.openTooltip(); }, 800);
Â  Â  Â  hoverTimers.set(layer, t);
Â  Â  Â  e.target.setStyle({ weight: (focusedKey===key? 3:2), color:'#111827', fillOpacity:0.9 }); e.target.bringToFront();
Â  Â  });
Â  Â  layer.on('mouseout', e=>{
Â  Â  Â  clearTimeout(hoverTimers.get(layer));
Â  Â  Â  e.target.closeTooltip();
Â  Â  Â  const fill = leaderColors[key] || '#e5e7eb';
Â  Â  Â  const wt = (focusedKey===key)? 3 : 1;
Â  Â  Â  const col = (focusedKey===key)? '#111827' : '#94a3b8';
Â  Â  Â  e.target.setStyle({ fillColor: fill, fillOpacity:0.75, color: col, weight: wt });
Â  Â  });
Â  });
}

/* ===== Details panel ===== */
function showConstituencyDetails(normKey, featureName){
Â  const cont=document.getElementById('imapContent');
Â  cont.dataset.currentKey = normKey;
Â  const block = document.querySelector(`.const[data-key="${normKey}"]`);
Â  if (!block){ cont.textContent='No data found.'; return; }
Â  const rows = JSON.parse(block.dataset.candidates || '[]');
Â  const updated = block.dataset.updated ? Number(block.dataset.updated) : null;
Â  const cNo = block.dataset.constno ? ` (#${block.dataset.constno})` : '';

Â  const ageMs = Date.now() - (updated||Date.now());
Â  let dotColor = 'var(--bad)';
Â  if (ageMs <= 5*60*1000) dotColor = 'var(--good)';
Â  else if (ageMs <= 20*60*1000) dotColor = 'var(--warn)';

Â  const dispName = featureName + cNo;
Â  const boxStr = block.dataset.boxes || '';
Â  const boxPct = block.dataset.boxpct || '';

Â  let html = `<h3 style="margin:4px 0">${dispName}</h3>`;
Â  html += `
Â  Â  <div class="updated">
Â  Â  Â  <span>Last updated:</span>
Â  Â  Â  <span><span class="pulse" style="color:${dotColor}"></span>
Â  Â  Â  Â  <span style="font-variant-numeric:tabular-nums">${fmtHHMMSS(Date.now()-(updated||Date.now()))}</span> ago
Â  Â  Â  </span>
Â  Â  </div>
Â  Â  ${boxStr ? `<div class="boxline">Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}</div>` : ''}
Â  `;
Â  html += `<table style="width:100%; border-collapse:collapse; margin-top:6px"><thead><tr><th style="width:28px"></th><th>Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr></thead><tbody>`;
Â  rows.forEach(r=>{
Â  Â  const P = partyKey(r.party);
Â  Â  const icon = PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other;
Â  Â  const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}; font-weight:700"`;
Â  Â  html += `<tr>
Â  Â  Â  <td><img src="${icon}" alt="${P}" class="party-icon" referrerpolicy="no-referrer"></td>
Â  Â  Â  <td ${nameStyle}>${r.name}</td>
Â  Â  Â  <td>${P}</td>
Â  Â  Â  <td style="text-align:right; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
Â  Â  Â  <td style="text-align:right">${r.pct||0}%</td>
Â  Â  </tr>`;
Â  });
Â  html += `</tbody></table>`;
Â  cont.innerHTML = html;
}

/* ===== Render parish blocks + filters + SORT ===== */
function renderParishBlocks(detailsByConst, rawData){
Â  const host=document.getElementById('parishContainer'); host.innerHTML='';
Â  const parishSel = document.getElementById('parishFilter');
Â  const partySelÂ  = document.getElementById('partyFilter');
Â  const cnoInpÂ  Â  = document.getElementById('cnoFilter');
Â  const sortField = document.getElementById('sortField').value;
Â  const sortDirÂ  Â = document.getElementById('sortDir').value;

Â  const allKeys = Object.keys(detailsByConst);
Â  const parishOf = k => constNameToParish[k] || '';
Â  const cnoOfÂ  Â  = k => (constNameToNo[k] || '');
Â  const recOfÂ  Â  = k => Object.values(rawData).find(x=> canonKey(norm(x?.Name))===k);
Â  const nameOfÂ  Â = k => (recOf(k)?.Name || k);
Â  const leadPartyOf = k => detailsByConst[k]?.all?.[0]?.party || 'Other';

Â  const parishSet = new Set(allKeys.map(parishOf));
Â  let parishes = Array.from(parishSet).sort((a,b)=> a.localeCompare(b));
Â  if (sortField==='parish') parishes.sort((a,b)=> sortDir==='asc'? a.localeCompare(b):b.localeCompare(a));

Â  const curParish = parishSel.value;
Â  parishSel.innerHTML = `<option value="">All Parishes</option>` + parishes.map(p=>`<option ${curParish===p?'selected':''} value="${p}">${p}</option>`).join('');

Â  const filterParish = parishSel.value;
Â  const filterPartyÂ  = partySel.value;
Â  const filterCnoÂ  Â  = cnoInp.value.trim();

Â  parishes.forEach(parish=>{
Â  Â  if (filterParish && parish!==filterParish) return;
Â  Â  let keys = allKeys.filter(k=> parishOf(k)===parish);

Â  Â  keys.sort((ka,kb)=>{
Â  Â  Â  let A,B;
Â  Â  Â  switch (sortField){
Â  Â  Â  Â  case 'cno':Â  Â A=Number(cnoOf(ka)||0); B=Number(cnoOf(kb)||0); break;
Â  Â  Â  Â  case 'name':Â  A=nameOf(ka).toLowerCase(); B=nameOf(kb).toLowerCase(); break;
Â  Â  Â  Â  case 'party': A=leadPartyOf(ka); B=leadPartyOf(kb); break;
Â  Â  Â  Â  case 'parish':A=parishOf(ka); B=parishOf(kb); break;
Â  Â  Â  Â  default: A=nameOf(ka).toLowerCase(); B=nameOf(kb).toLowerCase();
Â  Â  Â  }
Â  Â  Â  if (A<B) return sortDir==='asc'?-1:1;
Â  Â  Â  if (A>B) return sortDir==='asc'? 1:-1;
Â  Â  Â  return 0;
Â  Â  });

Â  Â  const wrap=document.createElement('div'); wrap.className='parish';
Â  Â  wrap.innerHTML = `<h2>${parish||'â€”'}</h2><div class="const-grid"></div>`;
Â  Â  const grid = wrap.querySelector('.const-grid');

Â  Â  keys.forEach(key=>{
Â  Â  Â  const info = detailsByConst[key];
Â  Â  Â  const record = recOf(key);
Â  Â  Â  const origName = record?.Name || key;
Â  Â  Â  const cNo = constNameToNo[key] || '';

Â  Â  Â  if (filterParty && !info.all.some(c=> partyKey(c.party)===filterParty)) return;
Â  Â  Â  if (filterCno && !String(cNo).startsWith(filterCno)) return;

Â  Â  Â  const winnerParty = partyKey(info.all?.[0]?.party || 'Other');
Â  Â  Â  const winnerObj = info.all?.[0] || null;

Â  Â  Â  const bg = PARTY_COLORS[winnerParty] || PARTY_COLORS.Other;
Â  Â  Â  const textColor = contrastText(bg);
Â  Â  Â  const candidatesPayload = JSON.stringify(info.all || []);
Â  Â  Â  const updatedTs = lastConstUpdated[key] || '';

Â  Â  Â  // Boxes declare rule: declare only full or >=95%
Â  Â  Â  let boxes = '', boxpct = ''; let fullCounted=false, pctNum=0, canDeclare=false;
Â  Â  Â  if (record?.Data){
Â  Â  Â  Â  const d = Array.isArray(record.Data)? record.Data[0] : record.Data;
Â  Â  Â  Â  boxesÂ  = d?.["Boxes Counted"] || '';
Â  Â  Â  Â  boxpct = (d?.["Box Counted Percentage"]!=null) ? String(d["Box Counted Percentage"]) : '';
Â  Â  Â  Â  const m = boxes ? String(boxes).match(/(\d+)\s*of\s*(\d+)/i) : null;
Â  Â  Â  Â  if (m){ const counted=+m[1], total=+m[2]; fullCounted = total>0 && counted===total; }
Â  Â  Â  Â  pctNum = Number(boxpct)||0;
Â  Â  Â  Â  canDeclare = fullCounted || (pctNum>=95);
Â  Â  Â  }

Â  Â  Â  const el=document.createElement('div'); el.className='const';
Â  Â  Â  el.dataset.key = key;
Â  Â  Â  el.dataset.constno = cNo;
Â  Â  Â  el.dataset.updated = updatedTs;
Â  Â  Â  el.dataset.candidates = candidatesPayload;
Â  Â  Â  el.dataset.boxes = boxes;
Â  Â  Â  el.dataset.boxpct = boxpct;

Â  Â  Â  el.dataset.search = [origName, cNo, parish, ...(info.all||[]).map(c=>`${c.name} ${partyKey(c.party)}`)].join(' ').toLowerCase();
Â  Â  Â  el.dataset.parish = parish;
Â  Â  Â  el.dataset.parties = (info.all||[]).map(c=>partyKey(c.party)).join('|');
Â  Â  Â  el.dataset.cno = cNo;

Â  Â  Â  el.style.borderColor = bg;

Â  Â  Â  const ageMs = Date.now() - (updatedTs||Date.now());
Â  Â  Â  let dotColor = 'var(--bad)';
Â  Â  Â  if (ageMs <= 5*60*1000) dotColor = 'var(--good)';
Â  Â  Â  else if (ageMs <= 20*60*1000) dotColor = 'var(--warn)';

Â  Â  Â  const niceName = `${origName} ${cNo?`(#${cNo})`:''}`;

Â  Â  Â  const winnerBadgeHTML = (canDeclare && winnerObj)
Â  Â  Â  Â  ? `<div class="winner-badge" style="background:${bg}; color:${textColor}; border-color:${bg}">
Â  Â  Â  Â  Â  Â  Â <span class="check">âœ“</span> ${winnerObj.name} (${winnerParty})
Â  Â  Â  Â  Â  Â </div>`
Â  Â  Â  Â  : (winnerObj
Â  Â  Â  Â  Â  Â ? `<div class="winner-badge" style="background:var(--card); color:var(--text); border-color:var(--border)">
Â  Â  Â  Â  Â  Â  Â  Â  Leading: <strong style="color:${PARTY_COLORS[winnerParty]||'#888'}">${winnerObj.name} (${winnerParty})</strong>
Â  Â  Â  Â  Â  Â  Â  </div>`
Â  Â  Â  Â  Â  Â : ``);

Â  Â  Â  const rowsHTML = (info.all||[]).map(c=>{
Â  Â  Â  Â  const P=partyKey(c.party), icon=PARTY_SYMBOLS[P]||PARTY_SYMBOLS.Other;
Â  Â  Â  Â  const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}"`;
Â  Â  Â  Â  return `<div class="row">
Â  Â  Â  Â  Â  <img class="party-icon" src="${icon}" alt="${P}" referrerpolicy="no-referrer">
Â  Â  Â  Â  Â  <div class="nm" ${nameStyle}>${c.name}</div>
Â  Â  Â  Â  Â  <div class="party">${P}</div>
Â  Â  Â  Â  Â  <div class="votes">${Number(c.votes||0).toLocaleString()}</div>
Â  Â  Â  Â  Â  <div class="pct">${c.pct||0}%</div>
Â  Â  Â  Â  </div>`;
Â  Â  Â  }).join('');
Â  Â  Â 
Â  Â  Â  // Calculate total votes for the progress bar
Â  Â  Â  const totalVotes = (info.all||[]).reduce((sum, c) => sum + Number(c.votes || 0), 0);
Â  Â  Â  const progressBarHTML = totalVotes > 0 ? `<div class="const-bar">${
Â  Â  Â  Â  (info.all || []).map(c => {
Â  Â  Â  Â  Â  const P = partyKey(c.party);
Â  Â  Â  Â  Â  const width = (Number(c.votes || 0) / totalVotes) * 100;
Â  Â  Â  Â  Â  return `<span style="width:${width}%; background:${PARTY_COLORS[P] || PARTY_COLORS.Other};"></span>`;
Â  Â  Â  Â  }).join('')
Â  Â  Â  }</div>` : '';

Â  Â  Â  el.innerHTML = `
Â  Â  Â  Â  <div class="const-head">
Â  Â  Â  Â  Â  <div class="const-name">${niceName}</div>
Â  Â  Â  Â  Â  <span class="updated">
Â  Â  Â  Â  Â  Â  <span>Last updated:</span>
Â  Â  Â  Â  Â  Â  <span><span class="pulse" style="color:${dotColor}"></span>
Â  Â  Â  Â  Â  Â  Â  <span class="timer" data-ts="${updatedTs||''}" style="font-variant-numeric:tabular-nums">
Â  Â  Â  Â  Â  Â  Â  Â  ${fmtHHMMSS(Date.now()-(updatedTs||Date.now()))}
Â  Â  Â  Â  Â  Â  Â  </span> ago
Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="const-body">
Â  Â  Â  Â  Â  ${winnerBadgeHTML}
Â  Â  Â  Â  Â  ${boxes? `<div class="boxline">Boxes counted: <strong>${boxes}</strong>${boxpct?` (${boxpct}%)`:''}</div>` : ''}
Â  Â  Â  Â  Â  <div class="const-bar-container">${progressBarHTML}</div>
Â  Â  Â  Â  Â  <div class="rows">${rowsHTML}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  /* OPEN PREVIEW (first click) */
Â  Â  Â  el.addEventListener('click', ()=> openPreviewForKey(key));
Â  Â  Â  grid.appendChild(el);
Â  Â  });

Â  Â  if (grid.children.length) document.getElementById('parishContainer').appendChild(wrap);
Â  });

Â  // Text search
Â  const sb = document.getElementById('searchBar');
Â  function applyTextFilter(){
Â  Â  const q = sb.value.trim().toLowerCase();
Â  Â  document.querySelectorAll('.const').forEach(card=>{
Â  Â  Â  const hit = !q || card.dataset.search.includes(q);
Â  Â  Â  card.style.display = hit ? '' : 'none';
Â  Â  });
Â  Â  document.querySelectorAll('.parish').forEach(p=>{
Â  Â  Â  const any = p.querySelector('.const-grid').children.length &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Array.from(p.querySelectorAll('.const')).some(x=> x.style.display!=='none');
Â  Â  Â  p.style.display = any ? '' : 'none';
Â  Â  });
Â  }
Â  sb.oninput = applyTextFilter;
}

/* ===== Periodic timers + sidebar + ticker ===== */
function fmtAgeToClass(age){
Â  if (age <= 5*60*1000) return 'age-good';
Â  if (age <= 20*60*1000) return 'age-warn';
Â  return 'age-bad';
}
function tickTimersAndRecent(){
Â  document.querySelectorAll('.const .timer').forEach(t=>{
Â  Â  const ts = Number(t.dataset.ts||0);
Â  Â  if (!ts) { t.textContent = '00:00:00'; return; }
Â  Â  const age = Date.now()-ts;
Â  Â  t.textContent = fmtHHMMSS(age);
Â  Â  const dot = t.parentElement?.querySelector('.pulse');
Â  Â  if (dot){
Â  Â  Â  let col='var(--bad)';
Â  Â  Â  if (age <= 5*60*1000) col='var(--good)';
Â  Â  Â  else if (age <= 20*60*1000) col='var(--warn)';
Â  Â  Â  dot.style.color = col;
Â  Â  }
Â  });

Â  const recents = []; const tickerÂ  = [];
Â  Object.keys(lastConstUpdated).forEach(k=>{
Â  Â  const ts = lastConstUpdated[k];
Â  Â  const age = Date.now()-ts;
Â  Â  const name = Object.values(window.__rawData||{}).find(x=> canonKey(norm(x?.Name))===k)?.Name || k;
Â  Â  const num = constNameToNo[k] || '';
Â  Â  if (ts && age <= SIDEBAR_MAX_AGE) recents.push({k, name, num, ts, age});
Â  Â  if (ts && age <= TICKER_MAX_AGE)Â  ticker.push({k, name, num, ts, age});
Â  });
Â  recents.sort((a,b)=> b.ts - a.ts);
Â  ticker.sort((a,b)=> b.ts - a.ts);

Â  const side = document.getElementById('sidebarList');
Â  side.innerHTML='';
Â  recents.forEach(r=>{
Â  Â  const el=document.createElement('div');
Â  Â  el.className='sideitem '+fmtAgeToClass(r.age);
Â  Â  el.dataset.key = r.k;
Â  Â  el.innerHTML=`<span>#${r.num||'â€”'}</span><small>${fmtHHMMSS(r.age)}</small>`;
Â  Â  el.addEventListener('click', ()=> gotoInteractiveKey(r.k));
Â  Â  side.appendChild(el);
Â  });

Â  const tick = document.getElementById('tickerText');
Â  if (ticker.length){
Â  Â  const parts = ticker.map(r=> `${r.name}${r.num?` (#${r.num})`:''} â€” ${fmtHHMMSS(Date.now()-r.ts)} ago`);
Â  Â  tick.textContent = 'Â  Â â€¢Â  Â ' + parts.join('Â  Â â€¢Â  Â ') + 'Â  Â â€¢Â  Â ';
Â  }else{
Â  Â  tick.textContent = 'â€” No constituency updated in the last 15 minutes â€”';
Â  }

Â  const imTimer = document.querySelector('#imapContent .updated span[style*="font-variant-numeric"]');
Â  const imDotÂ  Â = document.querySelector('#imapContent .updated .pulse');
Â  const curKey = document.getElementById('imapContent')?.dataset?.currentKey;
Â  if (imTimer && curKey && lastConstUpdated[curKey]){
Â  Â  const age = Date.now()-lastConstUpdated[curKey];
Â  Â  imTimer.textContent = fmtHHMMSS(age);
Â  Â  if (imDot){
Â  Â  Â  let col='var(--bad)'; if (age<=5*60*1000) col='var(--good)'; else if (age<=20*60*1000) col='var(--warn)';
Â  Â  Â  imDot.style.color = col;
Â  Â  }
Â  }
}

/* ===== Robust fetch helpers ===== */
async function fetchOne(url){
Â  try{
Â  Â  const r = await fetch(bust(url), {cache:'no-store'});
Â  Â  if (!r.ok) throw new Error(`HTTP ${r.status}`);
Â  Â  const ct = r.headers.get('content-type') || '';
Â  Â  if (!/json/i.test(ct)) {
Â  Â  Â  try { return await r.json(); } catch { throw new Error(`Non-JSON content-type: ${ct}`); }
Â  Â  }
Â  Â  return await r.json();
Â  }catch(e){ throw new Error(`${url} â†’ ${e.message}`); }
}

/* ===== Data load (local JSON) ===== */
async function loadECJAndData(){
Â  try{
Â  Â  if (!arcFeatures.length){ try{ await loadECJBoundaries(); }catch(_){ toast('Could not load boundaries.'); } }
Â  Â  initNationalMap(); initInteractiveMap();
Â  Â  buildLegendInto('mapLegend'); buildLegendInto('imapLegend');

Â  Â  const data = await fetchOne(DATA_URL);
Â  Â  window.__rawData = data;

Â  Â  if (!geoLayerNational){
Â  Â  Â  geoLayerNational = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapNational);
Â  Â  }
Â  Â  if (!geoLayerInteractive){
Â  Â  Â  geoLayerInteractive = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapInteractive);
Â  Â  }

Â  Â  const partyTotals={JLP:0, PNP:0, JPP:0, UIC:0, Other:0};
Â  Â  const partySeats ={JLP:0, PNP:0, JPP:0, UIC:0, Other:0};
Â  Â  const detailsByConst={}, closestArr=[];
Â  Â  Object.values(data).forEach(c=>{
Â  Â  Â  const cname=c?.Name||''; const cData=Array.isArray(c?.Data)? c.Data[0] : c?.Data;
Â  Â  Â  const cand = Array.isArray(cData?.Candidates)? cData.Candidates : [];
Â  Â  Â  if(!cname || !cand.length) return;
Â  Â  Â  let key = canonKey(norm(cname));
Â  Â  Â  const alias = NAME_ALIASES[norm(cname)];
Â  Â  Â  if (alias){
Â  Â  Â  Â  constNameToParish[key] = alias.parish || constNameToParish[key] || '';
Â  Â  Â  Â  constNameToNo[key]Â  Â  Â = alias.constno || constNameToNo[key] || '';
Â  Â  Â  }

Â  Â  Â  const safePctÂ  = (x)=> Number(x)||0;
Â  Â  Â  const safeVote = (x)=> Number(x)||0;
Â  Â  Â  const winner = cand.reduce((m,x)=> safeVote(x.Votes)>safeVote(m.Votes)? x : m, cand[0]);
Â  Â  Â  const sorted = cand.slice().sort((a,b)=> safePct(b.Percentage)-safePct(a.Percentage)).map(k=>({
Â  Â  Â  Â  name:`${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}`.trim(),
Â  Â  Â  Â  party:partyKey(k.Party),
Â  Â  Â  Â  votes:safeVote(k.Votes),
Â  Â  Â  Â  pct:safePct(k.Percentage)
Â  Â  Â  }));

Â  Â  Â  const sig = makeHash(cand);
Â  Â  Â  if (lastConstHashes[key] !== sig){
Â  Â  Â  Â  lastConstHashes[key] = sig;
Â  Â  Â  Â  lastConstUpdated[key] = Date.now();
Â  Â  Â  Â  localStorage.setItem('constituencyHashes', JSON.stringify(lastConstHashes));
Â  Â  Â  Â  localStorage.setItem('constituencyUpdated', JSON.stringify(lastConstUpdated));
Â  Â  Â  }

Â  Â  Â  detailsByConst[key] = { party:partyKey(winner?.Party), all: sorted };
Â  Â  Â  cand.forEach(k=>{ const p=partyKey(k.Party); partyTotals[p]=(partyTotals[p]||0)+safeVote(k.Votes); });
Â  Â  Â  const wParty = partyKey(winner?.Party);
Â  Â  Â  partySeats[wParty] = (partySeats[wParty] ?? 0) + 1;

Â  Â  Â  const topPct = sorted[0]?.pct||0, runnerPct=sorted[1]?.pct||0;
Â  Â  Â  closestArr.push({
Â  Â  Â  Â  constituency:cname,
Â  Â  Â  Â  winnerFirst: sorted[0]?.name.split(' ')[0]||'',
Â  Â  Â  Â  winnerLast:Â  (sorted[0]?.name.split(' ').slice(1).join(' '))||'',
Â  Â  Â  Â  winnerParty: sorted[0]?.party||'Other',
Â  Â  Â  Â  marginPct: Math.max(0,(topPct-runnerPct)),
Â  Â  Â  Â  candidates: sorted
Â  Â  Â  });
Â  Â  });

Â  Â  const {totals: groupedTotals, seats: groupedSeats} = groupSmallParties(partyTotals, partySeats, 0.02, Object.keys(PARTY_COLORS));

Â  Â  buildToplineBar(groupedTotals, groupedSeats);
Â  Â  buildScoreboard(groupedTotals, groupedSeats);
Â  Â  buildCharts(groupedTotals, groupedSeats);
Â  Â  buildClosestPanel(closestArr);
Â  Â  renderParishBlocks(detailsByConst, data);
Â  Â  paintMap(geoLayerNational, detailsByConst);
Â  Â  paintMap(geoLayerInteractive, detailsByConst);
Â  Â  wireInteractiveBehaviors();
Â  Â  updateFocusOutline();

Â  Â  document.getElementById('lastUpdated').textContent = "Live â€¢ " + new Date().toLocaleTimeString();

Â  Â  if (timerInterval) clearInterval(timerInterval);
Â  Â  timerInterval = setInterval(tickTimersAndRecent, 1000);
Â  Â  tickTimersAndRecent();
Â  }catch(e){ console.error(e); toast('Partial update â€” check console.'); }
}
function groupSmallParties(totals,seats,threshold=0.02, keep=[]){
Â  const baseKeys = Array.from(new Set([...keep, 'Other', 'JLP','PNP','JPP','UIC']));
Â  const total = Object.values(totals).reduce((a,b)=>a+b,0) || 1;
Â  const T = Object.fromEntries(baseKeys.map(k=>[k,0]));
Â  const S = Object.fromEntries(baseKeys.map(k=>[k,0]));
Â  for (const p of Object.keys(totals)){
Â  Â  const share = totals[p] / total;
Â  Â  const bucket = (!keep.includes(p) && p!=='Other' && share < threshold) ? 'Other' : p;
Â  Â  T[bucket] = (T[bucket] || 0) + (totals[p] || 0);
Â  Â  S[bucket] = (S[bucket] || 0) + (seats[p]Â  || 0);
Â  }
Â  if (T.Other == null) T.Other = 0;
Â  if (S.Other == null) S.Other = 0;
Â  return {totals:T, seats:S};
}

/* ===== Deep link + handshake ===== */
function gotoInteractive(name){
Â  let k = norm(name);
Â  const alias = NAME_ALIASES[k];
Â  const resolved = alias?.key || k;
Â  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
Â  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
Â  document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
Â  document.getElementById('tab-interactive').classList.remove('hidden');

Â  if (!geoLayerInteractive){ pendingFocusName = resolved; return; }
Â  focusConstituencyByName(resolved, true);
Â  setTimeout(()=> mapInteractive.invalidateSize(), 80);
Â  document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
}
function gotoInteractiveKey(key){
Â  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
Â  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
Â  document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
Â  document.getElementById('tab-interactive').classList.remove('hidden');

Â  if (!geoLayerInteractive){ pendingFocusName = key; return; }
Â  focusConstituencyByName(key, true);
Â  setTimeout(()=> mapInteractive.invalidateSize(), 80);
Â  document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
}
function focusConstituencyByNumber(no){
Â  if (!geoLayerInteractive) return false;
Â  let found=null, parish=null, display=null, key=null;
Â  geoLayerInteractive.eachLayer(L=>{
Â  Â  const p = L.feature?.properties||{};
Â  Â  const n = String(p.CONST_NO || p.CONSTNO || p.Number || '');
Â  Â  if (n === String(no)){
Â  Â  Â  found=L; parish=p.PARISH_NAM; display=p.CONST_NAME; key=norm(p.CONST_NAME||'');
Â  Â  }
Â  });
Â  if (!found) return false;
Â  const grp=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
Â  const group = L.featureGroup(grp.length? grp:[found]);
Â  try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
Â  focusedKey = key; updateFocusOutline();
Â  setTimeout(()=> found.openTooltip(), 250);
Â  showConstituencyDetails(key, display||`#${no}`);
Â  return true;
}
function focusConstituencyByName(nameOrKey, isKey=false){
Â  if (!geoLayerInteractive) return;
Â  const rawK = isKey ? nameOrKey : norm(nameOrKey);
Â  const alias = NAME_ALIASES[rawK];
Â  const keyWanted = alias?.key || rawK;

Â  let target=null, parish=null, display=null;
Â  geoLayerInteractive.eachLayer(L=>{
Â  Â  const nm = L.feature?.properties?.CONST_NAME || '';
Â  Â  const k = norm(nm);
Â  Â  if (k===keyWanted){ target=L; parish = L.feature?.properties?.PARISH_NAM; display=nm; }
Â  });

Â  if (target){
Â  Â  const grp = (function(){ const arr=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) arr.push(l); }); return arr; })();
Â  Â  const group = L.featureGroup(grp.length? grp:[target]);
Â  Â  try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
Â  Â  focusedKey = keyWanted; updateFocusOutline();
Â  Â  startPulse(target);
Â  Â  setTimeout(()=> target.openTooltip(), 250);
Â  Â  showConstituencyDetails(keyWanted, display||nameOrKey);
Â  } else {
Â  Â  const number = constNameToNo[keyWanted] || constNameToNo[alias?.key || ''];
Â  Â  if (number && focusConstituencyByNumber(number)) return;
Â  Â  setTimeout(()=> focusConstituencyByName(nameOrKey, isKey), 150);
Â  }
}

/* ===== Preview modal logic ===== */
function initPreviewMap(){
Â  if (previewMap) return;
Â  previewMap = L.map('previewMap', { zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS, maxBoundsViscosity:1 });
Â  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
Â  L.tileLayer(isDark
Â  Â  ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
Â  Â  : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
Â  Â  {minZoom:7, maxZoom:15}).addTo(previewMap);
Â  previewMap.fitBounds(JAMAICA_BOUNDS);
Â  previewMap.setMinZoom(previewMap.getZoom());
}
function closePreview(){
Â  const modal = document.getElementById('previewModal');
Â  modal.classList.remove('show');
Â  document.body.classList.remove('modal-open');
Â  if (previewLayer){
Â  Â  try{
Â  Â  Â  previewLayer.eachLayer(stopPulse);
Â  Â  Â  previewLayer.remove();
Â  Â  }catch(_){}
Â  Â  previewLayer=null;
Â  }
Â  const shim = document.getElementById('previewShimmer');
Â  if (shim) shim.style.display='none';
}
function populatePreviewDetails(key){
Â  const tbody = document.getElementById('previewTableBody');
Â  const boxes = document.getElementById('previewBoxes');
Â  tbody.innerHTML='';
Â  boxes.textContent='';
Â  const block = document.querySelector(`.const[data-key="${key}"]`);
Â  if (!block) return;
Â  const rows = JSON.parse(block.dataset.candidates || '[]');
Â  const boxStr = block.dataset.boxes || '';
Â  const boxPct = block.dataset.boxpct || '';
Â  if (boxStr) boxes.innerHTML = `Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}`;
Â  rows.forEach(r=>{
Â  Â  const P = partyKey(r.party);
Â  Â  const icon = PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other;
Â  Â  const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}; font-weight:700"`;
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `
Â  Â  Â  <td><img src="${icon}" alt="${P}" class="party-icon" referrerpolicy="no-referrer"></td>
Â  Â  Â  <td ${nameStyle}>${r.name}</td>
Â  Â  Â  <td>${P}</td>
Â  Â  Â  <td style="text-align:right; font-variant-numeric:tabular-nums; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
Â  Â  Â  <td style="text-align:right">${r.pct||0}%</td>
Â  Â  `;
Â  Â  tbody.appendChild(tr);
Â  });
}
function openPreviewForKey(key){
Â  previewKey = key;
Â  const modal = document.getElementById('previewModal');
Â  modal.classList.add('show');
Â  document.body.classList.add('modal-open');

Â  initPreviewMap();
Â  const shim = document.getElementById('previewShimmer');
Â  if (shim) shim.style.display='block';

Â  // Title = Name (#no)
Â  const rec = Object.values(window.__rawData||{}).find(x => canonKey(norm(x?.Name))===key);
Â  const displayName = rec?.Name || key;
Â  const num = constNameToNo[key] || '';
Â  document.getElementById('previewTitle').textContent = displayName + (num ? ` (#${num})` : '');

Â  // Hint aria-live
Â  let hint = 'Review the area below Â· Use the button to open the Interactive Map';
Â  try{
Â  Â  const block = document.querySelector(`.const[data-key="${key}"]`);
Â  Â  const rowsÂ  = JSON.parse(block?.dataset?.candidates || '[]');
Â  Â  const leadÂ  = rows[0];
Â  Â  const boxes = block?.dataset?.boxes || '';
Â  Â  if (lead){
Â  Â  Â  const P = partyKey(lead.party);
Â  Â  Â  hint = `${lead.name} (${P}) leading â€¢ ${Number(lead.votes||0).toLocaleString()} votes${boxes ? ` â€¢ Boxes: ${boxes}` : ''}`;
Â  Â  } else if (boxes) { hint = `Boxes: ${boxes}`; }
Â  }catch(_){}
Â  document.querySelector('.modal-hint').textContent = hint;

Â  // Details table + boxes
Â  populatePreviewDetails(key);

Â  // Build a fresh layer with pulsing on target, others muted
Â  if (previewLayer){ previewLayer.remove(); previewLayer=null; }
Â  previewLayer = L.geoJSON({type:'FeatureCollection', features: arcFeatures}, {
Â  Â  style:(feat)=>{
Â  Â  Â  const nm = feat?.properties?.CONST_NAME || '';
Â  Â  Â  const kÂ  = norm(nm);
Â  Â  Â  const isTarget = (k===key);
Â  Â  Â  const fill = isTarget ? (leaderColors[key] || '#60a5fa') : '#cbd5e1';
Â  Â  Â  return { color: isTarget ? '#111827' : '#94a3b8', weight: isTarget ? 3 : 1, fillColor: fill, fillOpacity: isTarget ? 0.8 : 0.5 };
Â  Â  }
Â  }).addTo(previewMap);

Â  // Fit to parish bounds, then zoom in +1
Â  let target=null, parish=null;
Â  previewLayer.eachLayer(l=>{
Â  Â  const nm = l.feature?.properties?.CONST_NAME || '';
Â  Â  if (norm(nm)===key){ target=l; parish=l.feature?.properties?.PARISH_NAM; }
Â  });
Â  if (target){
Â  Â  const grp=[]; previewLayer.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
Â  Â  const bounds = (grp.length ? L.featureGroup(grp) : target).getBounds();
Â  Â  try{
Â  Â  Â  previewMap.fitBounds(bounds, {padding:[24,24]});
Â  Â  Â  setTimeout(()=> previewMap.zoomIn(1), 120);
Â  Â  }catch(_){}
Â  Â  startPulse(target);
Â  }
Â  setTimeout(()=> {
Â  Â  previewMap.invalidateSize();
Â  Â  if (shim) shim.style.display='none';
Â  }, 120);

Â  // Map click = go interactive
Â  previewMap.off('click');
Â  previewMap.on('click', ()=> {
Â  Â  const k = previewKey; closePreview(); if (k) gotoInteractiveKey(k);
Â  });

Â  // Focus mgmt
Â  const goBtn = document.getElementById('btnPreviewGo');
Â  if (goBtn) goBtn.focus();

Â  // Deep link hash by number
Â  if (num) location.hash = '#'+num;
}

/* Modal buttons + keyboard */
document.getElementById('btnPreviewClose').addEventListener('click', closePreview);
document.getElementById('btnPreviewCancel').addEventListener('click', closePreview);
document.getElementById('btnPreviewGo').addEventListener('click', ()=>{ const k=previewKey; closePreview(); if (k) gotoInteractiveKey(k); });
document.addEventListener('keydown', (e)=>{
Â  if (e.key === 'Escape') closePreview();
Â  if (e.key === 'Enter' && document.getElementById('previewModal').classList.contains('show')){
Â  Â  const k = previewKey; closePreview(); if (k) gotoInteractiveKey(k);
Â  }
});
// Close if clicking backdrop
document.getElementById('previewModal').addEventListener('click', (e)=>{
Â  if (e.target.id === 'previewModal') closePreview();
});

/* ===== Auto ===== */
function setupAutoRefresh(){
Â  if (refreshTimer) clearInterval(refreshTimer);
Â  const ms = Number(localStorage.getItem('refreshIntervalMs')||sel.value||AUTO_DEFAULT);
Â  refreshTimer = setInterval(loadECJAndData, ms);
}

/* ===== Start ===== */
(async function start(){
Â  initTheme();
Â  updateStickyOffsets();
Â  try{ await loadECJBoundaries(); }catch(_){}
Â  initNationalMap(); initInteractiveMap();
Â  buildLegendInto('mapLegend'); buildLegendInto('imapLegend');
Â  await loadECJAndData();
Â  setupAutoRefresh();

Â  // Update the single pill to show local state
Â  const pill = document.getElementById('pillMain');
Â  if (pill){ pill.title = 'Using local 2025-data.json'; document.getElementById('mainLag').textContent = 'Local file'; }
})();
</script>
</body>
</html>
